<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ScoreStream Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@300;400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary:#080b10; --bg-secondary:#0d1117; --bg-card:#111722;
  --bg-card-hover:#161e2e; --border:#1e2d42; --border-bright:#2a4060;
  --accent:#00d4ff; --accent2:#ff6b00; --accent-green:#00ff88;
  --accent-red:#ff3b5c; --text-primary:#e8f0fe; --text-secondary:#7a9ab8;
  --text-dim:#3d5a78;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg-primary);color:var(--text-primary);font-family:'Barlow',sans-serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,212,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
#app{position:relative;z-index:1;display:flex;height:100vh;}

/* SIDEBAR */
#sidebar{width:270px;min-width:270px;background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;}
.sidebar-header{padding:16px 20px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,#080b10,#0d1825);}
.logo{display:flex;align-items:center;gap:10px;margin-bottom:4px;}
.logo-icon{width:30px;height:30px;background:linear-gradient(135deg,var(--accent),#0066ff);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;}
.logo-text{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:19px;letter-spacing:2px;text-transform:uppercase;}
.logo-text span{color:var(--accent);}
.logo-sub{font-size:10px;color:var(--text-dim);letter-spacing:3px;text-transform:uppercase;padding-left:40px;}
.live-badge{display:flex;align-items:center;gap:6px;padding:3px 10px;background:rgba(255,59,92,0.15);border:1px solid rgba(255,59,92,0.3);border-radius:4px;margin-top:10px;width:fit-content;}
.live-dot{width:7px;height:7px;background:var(--accent-red);border-radius:50%;animation:pulse-red 1.5s infinite;}
.live-badge span{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--accent-red);}
@keyframes pulse-red{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(255,59,92,0.5);}50%{opacity:0.6;box-shadow:0 0 0 4px rgba(255,59,92,0);}}

.sidebar-section{padding:14px 18px;border-bottom:1px solid var(--border);}
.section-label{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--text-dim);margin-bottom:10px;}

/* Layout buttons */
.layout-btns{display:flex;gap:5px;}
.layout-btn{flex:1;padding:9px 4px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;transition:all 0.2s;color:var(--text-secondary);}
.layout-btn:hover{border-color:var(--accent);color:var(--accent);}
.layout-btn.active{background:rgba(0,212,255,0.1);border-color:var(--accent);color:var(--accent);}
.layout-btn .icon{font-size:16px;}.layout-btn .lbl{font-size:9px;font-weight:600;letter-spacing:1px;text-transform:uppercase;}

/* Filter pills */
.pill-toggle{display:flex;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;overflow:hidden;}
.pill-opt{padding:4px 9px;font-size:10px;font-weight:600;letter-spacing:1px;cursor:pointer;transition:all 0.2s;color:var(--text-dim);text-transform:uppercase;font-family:'Barlow Condensed',sans-serif;}
.pill-opt.active{background:var(--accent);color:var(--bg-primary);}
.option-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.option-label{font-size:12px;color:var(--text-secondary);font-weight:500;}

/* Sport toggles */
.sport-toggle{display:flex;align-items:center;justify-content:space-between;padding:8px 11px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;margin-bottom:5px;cursor:pointer;transition:all 0.2s;}
.sport-toggle:hover{border-color:var(--border-bright);}
.sport-toggle.active{border-color:var(--accent);background:rgba(0,212,255,0.06);}
.sport-toggle.off-season{opacity:0.45;border-style:dashed;}
.sport-toggle.off-season:hover{opacity:0.75;}
.sport-info{display:flex;align-items:center;gap:8px;}
.sport-dot{width:7px;height:7px;border-radius:2px;}
.sport-name{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:1px;color:var(--text-primary);}
.sport-count{font-size:10px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;}
.sport-season-badge{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:2px 5px;border-radius:3px;border:1px solid;white-space:nowrap;}
.sport-season-badge.off{color:var(--text-dim);border-color:var(--text-dim);}
.sport-season-badge.pre{color:#ff9500;border-color:rgba(255,149,0,0.4);background:rgba(255,149,0,0.08);}
.sport-season-badge.post{color:#ff6b00;border-color:rgba(255,107,0,0.4);background:rgba(255,107,0,0.08);}
.toggle-switch{width:30px;height:17px;background:var(--bg-primary);border-radius:9px;border:1px solid var(--border);position:relative;transition:all 0.2s;flex-shrink:0;}
.sport-toggle.active .toggle-switch{background:var(--accent);border-color:var(--accent);}
.toggle-switch::after{content:'';position:absolute;width:11px;height:11px;background:var(--text-dim);border-radius:50%;top:2px;left:2px;transition:all 0.2s;}
.sport-toggle.active .toggle-switch::after{left:15px;background:white;}

/* Ended games */
.ended-master-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.ended-label{font-size:12px;color:var(--text-secondary);font-weight:500;}
.big-toggle{width:38px;height:21px;background:var(--bg-primary);border-radius:11px;border:1px solid var(--border);position:relative;cursor:pointer;transition:all 0.25s;flex-shrink:0;}
.big-toggle.on{background:var(--accent);border-color:var(--accent);}
.big-toggle::after{content:'';position:absolute;width:15px;height:15px;background:var(--text-dim);border-radius:50%;top:2px;left:2px;transition:all 0.25s;}
.big-toggle.on::after{left:19px;background:white;}
.small-toggle{width:26px;height:15px;background:var(--bg-primary);border-radius:8px;border:1px solid var(--border);position:relative;cursor:pointer;transition:all 0.2s;flex-shrink:0;}
.small-toggle.on{background:var(--accent);border-color:var(--accent);}
.small-toggle::after{content:'';position:absolute;width:9px;height:9px;background:var(--text-dim);border-radius:50%;top:2px;left:2px;transition:all 0.2s;}
.small-toggle.on::after{left:13px;background:white;}
.ended-leagues{margin-top:8px;border-top:1px solid var(--border);padding-top:8px;display:flex;flex-direction:column;gap:6px;}
.ended-league-row{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;overflow:hidden;}
.ended-league-row.active{border-color:rgba(0,212,255,0.3);}
.ended-league-header{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;cursor:pointer;}
.ended-league-name{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;color:var(--text-secondary);display:flex;align-items:center;gap:5px;}
.ended-league-row.active .ended-league-name{color:var(--text-primary);}
.ended-league-slider-wrap{padding:5px 10px 8px;border-top:1px solid var(--border);display:none;}
.ended-league-row.active .ended-league-slider-wrap{display:block;}
.league-days-row{display:flex;align-items:center;gap:8px;}
.league-days-label{font-size:10px;color:var(--text-dim);white-space:nowrap;font-family:'Barlow Condensed',sans-serif;}
.league-days-val{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--accent);min-width:20px;text-align:right;}
input[type=range]{flex:1;-webkit-appearance:none;height:4px;border-radius:2px;background:var(--border);outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 5px rgba(0,212,255,0.4);}
.ended-filter-row{display:flex;gap:3px;margin-top:6px;}
.ended-filter-pill{flex:1;padding:3px 3px;background:var(--bg-primary);border:1px solid var(--border);border-radius:5px;font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--text-dim);cursor:pointer;text-align:center;transition:all 0.15s;white-space:nowrap;}
.ended-filter-pill:hover{border-color:var(--border-bright);color:var(--text-secondary);}
.ended-filter-pill.active{background:rgba(0,212,255,0.12);border-color:var(--accent);color:var(--accent);}
.ended-filter-pill.active.fav{background:rgba(255,215,0,0.1);border-color:rgba(255,215,0,0.5);color:#ffd700;}

/* Favorites */
.fav-summary{display:flex;flex-wrap:wrap;gap:4px;min-height:18px;}
.fav-tag{display:flex;align-items:center;gap:4px;padding:2px 7px 2px 5px;background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.2);border-radius:20px;font-size:10px;color:#ffd700;font-family:'Barlow Condensed',sans-serif;font-weight:700;letter-spacing:0.5px;cursor:pointer;transition:all 0.2s;}
.fav-tag:hover{background:rgba(255,215,0,0.15);border-color:rgba(255,215,0,0.5);}
.fav-tag .remove-fav{font-size:9px;color:rgba(255,215,0,0.5);margin-left:1px;}
.fav-tag:hover .remove-fav{color:#ffd700;}
.no-favs-hint{font-size:11px;color:var(--text-dim);font-style:italic;line-height:1.5;}

/* Sidebar buttons */
.sidebar-btn{width:100%;padding:9px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px;margin-top:6px;}
.sidebar-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(0,212,255,0.06);}
.refresh-btn{width:100%;padding:10px;background:linear-gradient(135deg,rgba(0,212,255,0.15),rgba(0,102,255,0.15));border:1px solid var(--accent);border-radius:8px;color:var(--accent);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;}
.refresh-btn:hover{background:linear-gradient(135deg,rgba(0,212,255,0.25),rgba(0,102,255,0.25));box-shadow:0 0 20px rgba(0,212,255,0.2);}
.last-update{text-align:center;font-size:10px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;margin-top:6px;}
.sidebar-footer{margin-top:auto;padding:12px 18px;border-top:1px solid var(--border);font-size:10px;color:var(--text-dim);text-align:center;letter-spacing:1px;}

/* Dispatcharr status in sidebar */
.dispatcharr-status{display:flex;align-items:center;gap:6px;padding:5px 10px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;margin-top:6px;cursor:pointer;transition:all 0.2s;}
.dispatcharr-status:hover{border-color:var(--accent);}
.ds-dot{width:7px;height:7px;border-radius:50%;background:var(--text-dim);flex-shrink:0;}
.ds-dot.connected{background:var(--accent-green);box-shadow:0 0 6px rgba(0,255,136,0.5);}
.ds-dot.error{background:var(--accent-red);}
.ds-label{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;color:var(--text-dim);}
.ds-label.connected{color:var(--accent-green);}
.ds-label.error{color:var(--accent-red);}

/* MAIN */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.topbar{padding:12px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--bg-secondary);}
.topbar-title{font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:20px;letter-spacing:2px;text-transform:uppercase;}
.topbar-meta{display:flex;align-items:center;gap:14px;}
.meta-item{font-size:11px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;display:flex;align-items:center;gap:5px;}
.meta-item .val{color:var(--accent);}
#scoreboard{flex:1;overflow-y:auto;padding:18px 22px;}
#scoreboard::-webkit-scrollbar{width:4px;}
#scoreboard::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* LEAGUE / GAME CARDS */
.league-section{margin-bottom:26px;}
.league-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.league-stripe{width:4px;height:22px;border-radius:2px;}
.league-name{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:15px;letter-spacing:3px;text-transform:uppercase;color:var(--text-primary);}
.league-game-count{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);padding:2px 7px;background:var(--bg-card);border-radius:4px;border:1px solid var(--border);}
.league-season-badge{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:800;letter-spacing:2px;text-transform:uppercase;padding:2px 7px;border-radius:4px;border:1px solid;white-space:nowrap;}
.league-season-badge.pre{color:#ff9500;border-color:rgba(255,149,0,0.45);background:rgba(255,149,0,0.08);}
.league-season-badge.post{color:#ff6b00;border-color:rgba(255,107,0,0.45);background:rgba(255,107,0,0.1);animation:postGlow 2.5s ease-in-out infinite;}
@keyframes postGlow{0%,100%{box-shadow:0 0 0 rgba(255,107,0,0);}50%{box-shadow:0 0 8px rgba(255,107,0,0.35);}}
.league-star-btn{background:none;border:none;cursor:pointer;font-size:12px;padding:2px 4px;filter:grayscale(1) opacity(0.3);transition:all 0.2s;margin-left:2px;}
.league-star-btn:hover{filter:grayscale(0) opacity(0.7);transform:scale(1.15);}
.league-star-btn.starred{filter:grayscale(0) opacity(1) drop-shadow(0 0 3px rgba(255,215,0,0.5));}
.league-section.fav-league .league-name{color:#ffd700;}
.games-grid{display:grid;gap:9px;}
.games-grid.grid-mode{grid-template-columns:repeat(auto-fill,minmax(300px,1fr));}
.games-grid.fullscreen-mode,.games-grid.ticker-mode{grid-template-columns:1fr;}
.game-card{background:var(--bg-card);border:1px solid var(--border);border-radius:11px;overflow:hidden;transition:all 0.25s;animation:cardIn 0.4s ease forwards;}
@keyframes cardIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.game-card:hover{border-color:var(--border-bright);background:var(--bg-card-hover);transform:translateY(-1px);box-shadow:0 8px 30px rgba(0,0,0,0.4);}
.game-card.live{border-color:rgba(0,255,136,0.3);}
.game-card.favorited{border-color:rgba(255,215,0,0.35);background:linear-gradient(180deg,rgba(255,215,0,0.04) 0%,var(--bg-card) 60%);}
.game-card.is-final{opacity:0.82;}.game-card.is-final:hover{opacity:1;}
.card-status{padding:5px 13px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:rgba(0,0,0,0.2);}
.status-live{display:flex;align-items:center;gap:5px;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--accent-green);}
.status-live-dot{width:6px;height:6px;background:var(--accent-green);border-radius:50%;animation:pulse-green 1.5s infinite;}
@keyframes pulse-green{0%,100%{opacity:1;}50%{opacity:0.4;}}
.status-final{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--text-dim);}
.status-upcoming{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--accent);}
.game-period{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-secondary);}
.card-body{padding:12px 14px;}
.teams-container{display:flex;flex-direction:column;gap:9px;}
.team-row{display:flex;align-items:center;gap:10px;}
.team-logo-placeholder{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:10px;flex-shrink:0;text-align:center;line-height:1.1;}
.team-name-block{flex:1;min-width:0;}
.team-abbr{font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:var(--card-abbr-size,18px);letter-spacing:1px;text-transform:uppercase;color:var(--text-primary);line-height:1;}
.team-full-name{font-size:var(--card-name-size,11px);color:var(--card-name-color,var(--text-dim));white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.team-score{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:var(--card-score-size,34px);line-height:1;color:var(--text-primary);min-width:48px;text-align:right;}
.team-row.winning .team-score{color:white;}.team-row.losing .team-score{color:var(--text-secondary);}
.vs-line{height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:2px 0;}
.star-btn{background:none;border:none;cursor:pointer;font-size:14px;line-height:1;transition:transform 0.2s,filter 0.2s;padding:0 2px;filter:grayscale(1) opacity(0.35);}
.star-btn:hover{transform:scale(1.25);filter:grayscale(0) opacity(0.8);}
.star-btn.starred{filter:grayscale(0) opacity(1) drop-shadow(0 0 4px rgba(255,215,0,0.6));}
.stats-bar{margin-top:9px;padding-top:9px;border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(3,1fr);gap:5px;}
.stat-cell{text-align:center;}
.stat-val{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:15px;color:var(--text-primary);display:block;}
.stat-lbl{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;display:block;}
.fullscreen-mode .game-card{max-width:680px;margin:0 auto;}
.fullscreen-mode .team-score{font-size:calc(var(--card-score-size,34px) + 16px);}
.fullscreen-mode .team-abbr{font-size:calc(var(--card-abbr-size,18px) + 6px);}
.ticker-row{display:flex;align-items:center;padding:9px 14px;gap:12px;}
.ticker-teams{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:14px;color:var(--text-primary);flex:1;}
.ticker-score{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:17px;color:var(--accent);letter-spacing:2px;}
.ticker-period{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);min-width:60px;text-align:right;}
.pinned-section{margin-bottom:26px;}
.pinned-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,215,0,0.25);}
.pinned-stripe{width:4px;height:22px;border-radius:2px;background:linear-gradient(180deg,#ffd700,#ff9500);}
.pinned-title{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:15px;letter-spacing:3px;text-transform:uppercase;color:#ffd700;}
.pinned-count{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);padding:2px 7px;background:rgba(255,215,0,0.08);border-radius:4px;border:1px solid rgba(255,215,0,0.2);}
.loading-skeleton{background:linear-gradient(90deg,var(--bg-card) 25%,var(--bg-card-hover) 50%,var(--bg-card) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:11px;height:110px;margin-bottom:9px;}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-dim);}
.empty-icon{font-size:44px;margin-bottom:12px;}
.empty-text{font-family:'Barlow Condensed',sans-serif;font-size:15px;letter-spacing:2px;text-transform:uppercase;}

/* ==================== SETTINGS MODAL ==================== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(6px);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.2s ease;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.modal{background:var(--bg-secondary);border:1px solid var(--border-bright);border-radius:18px;width:700px;max-width:100%;max-height:88vh;display:flex;flex-direction:column;box-shadow:0 30px 100px rgba(0,0,0,0.8);animation:slideUp 0.25s ease;}
@keyframes slideUp{from{transform:translateY(24px);opacity:0;}to{transform:translateY(0);opacity:1;}}
.modal-header{padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.modal-title{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;letter-spacing:2px;text-transform:uppercase;}
.modal-close{background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:20px;padding:4px 8px;border-radius:6px;transition:all 0.15s;}
.modal-close:hover{color:var(--text-primary);background:var(--bg-card);}
.modal-tabs{display:flex;gap:3px;padding:12px 18px 0;border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;}
.modal-tabs::-webkit-scrollbar{display:none;}
.modal-tab{padding:8px 14px;background:none;border:none;border-bottom:2px solid transparent;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);cursor:pointer;transition:all 0.2s;white-space:nowrap;}
.modal-tab:hover{color:var(--text-secondary);}
.modal-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.modal-body{flex:1;overflow-y:auto;padding:20px 22px;}
.modal-body::-webkit-scrollbar{width:4px;}
.modal-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.modal-section{margin-bottom:24px;}
.modal-section-title{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--text-dim);margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.modal-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.modal-label{font-size:13px;color:var(--text-secondary);}
.modal-sublabel{font-size:11px;color:var(--text-dim);margin-top:2px;}
.modal-input{padding:7px 11px;background:var(--bg-card);border:1px solid var(--border);border-radius:7px;color:var(--text-primary);font-family:'Barlow',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;width:200px;}
.modal-input:focus{border-color:var(--accent);}
.modal-input::placeholder{color:var(--text-dim);}
.modal-input.full{width:100%;margin-top:6px;}
.modal-btn{padding:8px 18px;background:linear-gradient(135deg,rgba(0,212,255,0.15),rgba(0,102,255,0.15));border:1px solid var(--accent);border-radius:8px;color:var(--accent);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;}
.modal-btn:hover{background:rgba(0,212,255,0.25);}
.modal-btn.danger{border-color:var(--accent-red);color:var(--accent-red);background:rgba(255,59,92,0.08);}
.modal-btn.success{border-color:var(--accent-green);color:var(--accent-green);background:rgba(0,255,136,0.08);}
.modal-slider-row{display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:10px;margin-bottom:12px;}
.modal-slider-label{font-size:13px;color:var(--text-secondary);}
.modal-slider-val{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--accent);min-width:40px;text-align:right;}

/* Sport grid in settings */
.sport-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.sport-setting-row{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;transition:all 0.2s;}
.sport-setting-row.enabled{border-color:rgba(0,212,255,0.3);}
.sport-setting-info{display:flex;align-items:center;gap:8px;}
.sport-setting-name{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:0.5px;color:var(--text-primary);}

/* Refresh rate pills */
.rate-pills{display:flex;gap:5px;flex-wrap:wrap;}
.rate-pill{padding:5px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:20px;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;color:var(--text-dim);cursor:pointer;transition:all 0.15s;}
.rate-pill:hover{border-color:var(--border-bright);color:var(--text-secondary);}
.rate-pill.active{background:rgba(0,212,255,0.12);border-color:var(--accent);color:var(--accent);}

/* Color picker row */
.color-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.color-swatch{width:32px;height:32px;border-radius:6px;border:2px solid var(--border);cursor:pointer;overflow:hidden;flex-shrink:0;}
.color-swatch input[type=color]{width:100%;height:100%;border:none;padding:0;cursor:pointer;opacity:0;position:absolute;}
.color-swatch-wrap{position:relative;width:32px;height:32px;}

/* Dispatcharr status in modal */
.dispatcharr-test-result{margin-top:10px;padding:9px 13px;border-radius:8px;font-family:'Share Tech Mono',monospace;font-size:12px;display:none;}
.dispatcharr-test-result.ok{background:rgba(0,255,136,0.08);border:1px solid rgba(0,255,136,0.3);color:var(--accent-green);}
.dispatcharr-test-result.err{background:rgba(255,59,92,0.08);border:1px solid rgba(255,59,92,0.3);color:var(--accent-red);}
.channel-result{margin-top:10px;padding:9px 13px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;font-size:12px;color:var(--text-secondary);display:none;}

/* NCAA team search ‚Äî full names visible */
.tb-team-full{font-size:10px;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
</style>
</head>
<body>
<div id="app">
<aside id="sidebar">
  <div class="sidebar-header">
    <div class="logo">
      <div class="logo-icon">&#x1F4E1;</div>
      <div class="logo-text">Score<span>Stream</span></div>
    </div>
    <div class="logo-sub">Pro Scoreboard</div>
    <div class="live-badge"><div class="live-dot"></div><span>Live Data</span></div>
  </div>

  <div class="sidebar-section">
    <div class="section-label">Display Layout</div>
    <div class="layout-btns">
      <button class="layout-btn" data-layout="fullscreen"><div class="icon">&#x2B1B;</div><div class="lbl">Full</div></button>
      <button class="layout-btn active" data-layout="grid"><div class="icon">&#x229E;</div><div class="lbl">Grid</div></button>
      <button class="layout-btn" data-layout="ticker"><div class="icon">&#x25AC;</div><div class="lbl">Ticker</div></button>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="section-label">Filter</div>
    <div class="pill-toggle">
      <div class="pill-opt active" data-opt="filter" data-val="all">All</div>
      <div class="pill-opt" data-opt="filter" data-val="live">Live</div>
      <div class="pill-opt" data-opt="filter" data-val="favorites">&#x2B50; Mine</div>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="section-label">Active Sports</div>
    <div id="sport-toggles"></div>
  </div>

  <div class="sidebar-section" id="endedSection">
    <div class="section-label">Ended Games</div>
    <div class="ended-master-row">
      <span class="ended-label">&#x1F3C1; Show Final Games</span>
      <div class="big-toggle" id="endedMasterToggle" onclick="toggleEndedMaster()"></div>
    </div>
    <div id="endedControls" style="display:none">
      <div class="ended-leagues" id="endedLeagueToggles"></div>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="section-label">&#x2B50; My Favorites</div>
    <div class="fav-summary" id="favSummary">
      <div class="no-favs-hint">Star a team or league to pin it here</div>
    </div>
  </div>

  <div class="sidebar-section">
    <button class="refresh-btn" id="refreshBtn"><span>&#x21BB;</span> Refresh Scores</button>
    <div class="last-update" id="lastUpdate">Last updated: --</div>
    <div class="dispatcharr-status" id="dsStatus" onclick="openSettings('dispatcharr')">
      <div class="ds-dot" id="dsDot"></div>
      <span class="ds-label" id="dsLabel">Dispatcharr: Not configured</span>
    </div>
    <button class="sidebar-btn" onclick="openSettings('sports')">&#x2699;&#xFE0F; Settings</button>
  </div>

  <div class="sidebar-footer">ScoreStream Pro v0.0.1-beta &middot; ESPN Data</div>
</aside>

<div id="main">
  <div class="topbar">
    <div class="topbar-title" id="topbarTitle">All Sports Scoreboard</div>
    <div class="topbar-meta">
      <div class="meta-item">Live: <span class="val" id="liveCount">&ndash;</span></div>
      <div class="meta-item">Total: <span class="val" id="totalCount">&ndash;</span></div>
      <div class="meta-item" id="clockDisplay"></div>
    </div>
  </div>
  <div id="scoreboard"></div>
</div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsOverlay" style="display:none" onclick="handleModalOverlay(event)">
<div class="modal">
  <div class="modal-header">
    <div class="modal-title">&#x2699;&#xFE0F; Settings</div>
    <button class="modal-close" onclick="closeSettings()">&#x2715;</button>
  </div>
  <div class="modal-tabs">
    <button class="modal-tab active" data-tab="sports" onclick="switchTab('sports')">Sports &amp; Leagues</button>
    <button class="modal-tab" data-tab="teams" onclick="switchTab('teams')">Teams</button>
    <button class="modal-tab" data-tab="display" onclick="switchTab('display')">Display</button>
    <button class="modal-tab" data-tab="data" onclick="switchTab('data')">Data &amp; Refresh</button>
    <button class="modal-tab" data-tab="dispatcharr" onclick="switchTab('dispatcharr')">Dispatcharr</button>
  </div>
  <div class="modal-body">

    <!-- TAB: SPORTS -->
    <div id="tab-sports" class="tab-panel">
      <div class="modal-section">
        <div class="modal-section-title">Pro Leagues</div>
        <div class="sport-grid" id="sg-pro"></div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">NCAA Men's</div>
        <div class="sport-grid" id="sg-ncaam"></div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">NCAA Women's</div>
        <div class="sport-grid" id="sg-ncaaw"></div>
      </div>
    </div>

    <!-- TAB: TEAMS -->
    <div id="tab-teams" class="tab-panel" style="display:none">
      <div class="modal-section">
        <div class="modal-section-title">Browse &amp; Favorite Teams</div>
        <div style="display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;padding-bottom:4px;" id="tbTabs"></div>
        <div style="position:relative;margin-bottom:10px;">
          <span style="position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:13px;">&#x1F50D;</span>
          <input type="text" id="tbSearch" placeholder="Search by name, nickname, abbreviation..."
            style="width:100%;padding:8px 12px 8px 32px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:'Barlow',sans-serif;font-size:13px;outline:none;box-sizing:border-box;"
            oninput="filterTeams(this.value)">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;max-height:340px;overflow-y:auto;" id="tbTeamList"></div>
        <div style="margin-top:10px;font-size:11px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;" id="tbFavCount">&#x2B50; 0 teams favorited</div>
      </div>
    </div>

    <!-- TAB: DISPLAY -->
    <div id="tab-display" class="tab-panel" style="display:none">
      <div class="modal-section">
        <div class="modal-section-title">Card Typography</div>
        <div class="modal-slider-row">
          <span class="modal-slider-label">Team Abbreviation Size</span>
          <input type="range" min="14" max="28" value="18" id="sl-abbr" oninput="applyDisplay()">
          <span class="modal-slider-val" id="val-abbr">18px</span>
        </div>
        <div class="modal-slider-row">
          <span class="modal-slider-label">Score Size</span>
          <input type="range" min="24" max="52" value="34" id="sl-score" oninput="applyDisplay()">
          <span class="modal-slider-val" id="val-score">34px</span>
        </div>
        <div class="modal-slider-row">
          <span class="modal-slider-label">Team Name Size</span>
          <input type="range" min="9" max="16" value="11" id="sl-name" oninput="applyDisplay()">
          <span class="modal-slider-val" id="val-name">11px</span>
        </div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Team Name Color</div>
        <div class="modal-row">
          <div>
            <div class="modal-label">Name / Subtitle Color</div>
            <div class="modal-sublabel">The small text below the abbreviation</div>
          </div>
          <div class="color-row" style="margin:0;">
            <div class="color-swatch-wrap">
              <div class="color-swatch" id="nameColorSwatch" style="background:#3d5a78;"></div>
              <input type="color" id="nameColorPicker" value="#3d5a78" style="position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;" oninput="applyDisplay()">
            </div>
            <span style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-dim);" id="nameColorVal">#3d5a78</span>
          </div>
        </div>
        <div class="modal-row" style="margin-top:10px;">
          <span class="modal-label">Presets</span>
          <div style="display:flex;gap:5px;">
            <div onclick="setNameColor('#3d5a78')" style="width:24px;height:24px;border-radius:5px;background:#3d5a78;cursor:pointer;border:2px solid var(--border);" title="Default dim"></div>
            <div onclick="setNameColor('#7a9ab8')" style="width:24px;height:24px;border-radius:5px;background:#7a9ab8;cursor:pointer;border:2px solid var(--border);" title="Medium"></div>
            <div onclick="setNameColor('#b0c4de')" style="width:24px;height:24px;border-radius:5px;background:#b0c4de;cursor:pointer;border:2px solid var(--border);" title="Light blue"></div>
            <div onclick="setNameColor('#e8f0fe')" style="width:24px;height:24px;border-radius:5px;background:#e8f0fe;cursor:pointer;border:2px solid var(--border);" title="White"></div>
            <div onclick="setNameColor('#00d4ff')" style="width:24px;height:24px;border-radius:5px;background:#00d4ff;cursor:pointer;border:2px solid var(--border);" title="Accent cyan"></div>
          </div>
        </div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Stats</div>
        <div class="modal-row">
          <span class="modal-label">Stats Depth</span>
          <div class="pill-toggle">
            <div class="pill-opt active" data-opt="stats" data-val="basic">Basic</div>
            <div class="pill-opt" data-opt="stats" data-val="deep">Deep</div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: DATA -->
    <div id="tab-data" class="tab-panel" style="display:none">
      <div class="modal-section">
        <div class="modal-section-title">Auto-Refresh Rate</div>
        <div class="rate-pills" id="ratePills">
          <div class="rate-pill" data-rate="0" onclick="setRefreshRate(0)">Manual only</div>
          <div class="rate-pill" data-rate="30" onclick="setRefreshRate(30)">30 sec</div>
          <div class="rate-pill active" data-rate="60" onclick="setRefreshRate(60)">1 min</div>
          <div class="rate-pill" data-rate="120" onclick="setRefreshRate(120)">2 min</div>
          <div class="rate-pill" data-rate="300" onclick="setRefreshRate(300)">5 min</div>
        </div>
        <div style="margin-top:10px;font-size:11px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;" id="rateStatus">Auto-refresh: every 60 seconds</div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Data Source</div>
        <div style="font-size:13px;color:var(--text-secondary);line-height:1.6;">
          ScoreStream uses the unofficial ESPN Scoreboard API. Data is fetched directly from your browser &mdash; no proxy needed.<br><br>
          <span style="color:var(--text-dim);font-size:11px;">If scores show &ldquo;demo&rdquo; it means ESPN blocked the request from your network (CORS). This is normal inside some Docker/reverse proxy setups. Data still loads from a rich fallback dataset.</span>
        </div>
      </div>
    </div>

    <!-- TAB: DISPATCHARR -->
    <div id="tab-dispatcharr" class="tab-panel" style="display:none">
      <div class="modal-section">
        <div class="modal-section-title">Connection Status</div>
        <div class="modal-row">
          <div>
            <div class="modal-label">ScoreStream API</div>
            <div class="modal-sublabel">Your local API container must be running</div>
          </div>
          <button class="modal-btn" onclick="testConnection()">Test Connection</button>
        </div>
        <div class="dispatcharr-test-result" id="testResult"></div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Channel Configuration</div>
        <div class="modal-row">
          <div>
            <div class="modal-label">Credentials</div>
            <div class="modal-sublabel">Set DISPATCHARR_URL, DISPATCHARR_USER, DISPATCHARR_PASS in your .env file &mdash; credentials never enter the browser</div>
          </div>
        </div>
        <div class="modal-row" style="margin-top:4px;">
          <span class="modal-label">Channel Group</span>
          <input type="text" class="modal-input" id="dGroupInput" placeholder="ScoreStream" value="ScoreStream">
        </div>
        <div class="modal-row">
          <span class="modal-label">Starting Channel #</span>
          <input type="number" class="modal-input" id="dChannelStart" placeholder="900" value="900">
        </div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Create Channels in Dispatcharr</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div class="modal-row">
            <div>
              <div class="modal-label">Combined channel</div>
              <div class="modal-sublabel">One channel showing all sports</div>
            </div>
            <button class="modal-btn" onclick="createChannels('combined')">Create</button>
          </div>
          <div class="modal-row">
            <div>
              <div class="modal-label">Per-sport channels</div>
              <div class="modal-sublabel">Separate channel per active sport</div>
            </div>
            <button class="modal-btn" onclick="createChannels('per_sport')">Create</button>
          </div>
          <div class="modal-row">
            <div>
              <div class="modal-label">Both</div>
              <div class="modal-sublabel">Combined + individual sport channels</div>
            </div>
            <button class="modal-btn" onclick="createChannels('both')">Create All</button>
          </div>
        </div>
        <div class="channel-result" id="channelResult"></div>
      </div>
    </div>

  </div>
</div>
</div>

<script>
// =====================
//  SAFE STORAGE
// =====================
const mem={};
const ss={
  get:k=>{try{return localStorage.getItem(k);}catch(e){return mem[k]||null;}},
  set:(k,v)=>{try{localStorage.setItem(k,v);}catch(e){mem[k]=v;}}
};

// =====================
//  ALL SPORTS
// =====================
const ALL_SPORTS=[
  // Pro
  {id:'nfl',   name:'NFL',                  group:'pro',   color:'#4169e1',emoji:'üèà',url:'https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard'},
  {id:'nba',   name:'NBA',                  group:'pro',   color:'#c9082a',emoji:'üèÄ',url:'https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard'},
  {id:'mlb',   name:'MLB',                  group:'pro',   color:'#002d72',emoji:'‚öæ',url:'https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/scoreboard'},
  {id:'nhl',   name:'NHL',                  group:'pro',   color:'#00b7e0',emoji:'üèí',url:'https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard'},
  // NCAA Men
  {id:'ncaamb',name:"NCAA Men's Basketball",group:'ncaam', color:'#ff6600',emoji:'üèÄ',url:'https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/scoreboard'},
  {id:'ncaafb',name:'NCAA Football',        group:'ncaam', color:'#8b0000',emoji:'üèà',url:'https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard'},
  {id:'ncaabase',name:"NCAA Men's Baseball",group:'ncaam', color:'#005c2e',emoji:'‚öæ',url:'https://site.api.espn.com/apis/site/v2/sports/baseball/college-baseball/scoreboard'},
  // NCAA Women
  {id:'ncaawb',name:"NCAA Women's Basketball",group:'ncaaw',color:'#c7006b',emoji:'üèÄ',url:'https://site.api.espn.com/apis/site/v2/sports/basketball/womens-college-basketball/scoreboard'},
  {id:'ncaasb',name:"NCAA Softball",        group:'ncaaw', color:'#7b3f99',emoji:'ü•é',url:'https://site.api.espn.com/apis/site/v2/sports/baseball/college-softball/scoreboard'},
];

// Default enabled sports
const DEFAULT_ENABLED=new Set(['nfl','nba','mlb','nhl','ncaamb','ncaabase']);

// =====================
//  NCAA FULL NAME MAP
// =====================
// Maps ESPN abbreviations to [full school name, common name, nickname, state]
const NCAA_NAMES={
  'TEX':['University of Texas','Texas','Longhorns','Austin'],
  'KU':['University of Kansas','Kansas','Jayhawks'],
  'UK':['University of Kentucky','Kentucky','Wildcats'],
  'DUKE':['Duke University','Duke','Blue Devils'],
  'UNC':['University of North Carolina','North Carolina','Tar Heels','Chapel Hill'],
  'UCLA':['UCLA','University of California Los Angeles','Bruins'],
  'USC':['USC','University of Southern California','Trojans'],
  'OU':['University of Oklahoma','Oklahoma','Sooners'],
  'OSU':['Ohio State University','Ohio State','Buckeyes'],
  'MICH':['University of Michigan','Michigan','Wolverines'],
  'MSU':['Michigan State University','Michigan State','Spartans'],
  'PSU':['Penn State University','Penn State','Nittany Lions'],
  'IU':['Indiana University','Indiana','Hoosiers'],
  'PUR':['Purdue University','Purdue','Boilermakers'],
  'IOWA':['University of Iowa','Iowa','Hawkeyes'],
  'WISC':['University of Wisconsin','Wisconsin','Badgers'],
  'MINN':['University of Minnesota','Minnesota','Gophers'],
  'NW':['Northwestern University','Northwestern','Wildcats'],
  'ILL':['University of Illinois','Illinois','Illini','Fighting Illini'],
  'RUT':['Rutgers University','Rutgers','Scarlet Knights'],
  'MD':['University of Maryland','Maryland','Terrapins','Terps'],
  'NEB':['University of Nebraska','Nebraska','Cornhuskers','Huskers'],
  'ARIZ':['University of Arizona','Arizona','Wildcats'],
  'ASU':['Arizona State University','Arizona State','Sun Devils'],
  'UTAH':['University of Utah','Utah','Utes'],
  'COL':['University of Colorado','Colorado','Buffaloes','Buffs'],
  'WSU':['Washington State University','Washington State','Cougars'],
  'UW':['University of Washington','Washington','Huskies'],
  'ORE':['University of Oregon','Oregon','Ducks'],
  'ORST':['Oregon State University','Oregon State','Beavers'],
  'CAL':['University of California Berkeley','California','Cal','Golden Bears'],
  'STAN':['Stanford University','Stanford','Cardinal'],
  'AUB':['Auburn University','Auburn','Tigers'],
  'ALA':['University of Alabama','Alabama','Crimson Tide','Bama'],
  'LSU':['Louisiana State University','LSU','Tigers'],
  'TENN':['University of Tennessee','Tennessee','Vols','Volunteers'],
  'UGA':['University of Georgia','Georgia','Bulldogs'],
  'FLA':['University of Florida','Florida','Gators'],
  'FSU':['Florida State University','Florida State','Seminoles','Noles'],
  'MIAMI':['University of Miami','Miami','Hurricanes','Canes'],
  'CLEM':['Clemson University','Clemson','Tigers'],
  'SC':['University of South Carolina','South Carolina','Gamecocks'],
  'VAN':['Vanderbilt University','Vanderbilt','Commodores'],
  'MISS':['University of Mississippi','Ole Miss','Rebels'],
  'MSST':['Mississippi State University','Mississippi State','Bulldogs'],
  'ARK':['University of Arkansas','Arkansas','Razorbacks','Hogs'],
  'MO':['University of Missouri','Missouri','Mizzou','Tigers'],
  'TA&M':['Texas A&M University','Texas A&M','Aggies'],
  'TAMU':['Texas A&M University','Texas A&M','Aggies'],
  'TCU':['Texas Christian University','TCU','Horned Frogs'],
  'TTU':['Texas Tech University','Texas Tech','Red Raiders'],
  'BAYLOR':['Baylor University','Baylor','Bears'],
  'UT':['University of Texas','Texas','Longhorns'],
  'WVU':['West Virginia University','West Virginia','Mountaineers'],
  'KST':['Kansas State University','Kansas State','Wildcats','K-State'],
  'OKST':['Oklahoma State University','Oklahoma State','Cowboys'],
  'ISU':['Iowa State University','Iowa State','Cyclones'],
  'CIN':['University of Cincinnati','Cincinnati','Bearcats'],
  'UCF':['University of Central Florida','UCF','Knights'],
  'KENN':['University of Connecticut','UConn','Huskies'],
  'UCONN':['University of Connecticut','UConn','Huskies'],
  'GONZ':['Gonzaga University','Gonzaga','Bulldogs','Zags'],
  'MARQ':['Marquette University','Marquette','Golden Eagles'],
  'VILL':['Villanova University','Villanova','Wildcats','Nova'],
  'NOVA':['Villanova University','Villanova','Wildcats','Nova'],
  'CREI':['Creighton University','Creighton','Bluejays'],
  'XAVI':['Xavier University','Xavier','Musketeers'],
  'PROV':['Providence College','Providence','Friars'],
  'BIGA':['Big East',''],
  'SYRA':['Syracuse University','Syracuse','Orange'],
  'BOST':['Boston College','Boston College','Eagles'],
  'WAKE':['Wake Forest University','Wake Forest','Demon Deacons'],
  'PITT':['University of Pittsburgh','Pittsburgh','Pitt','Panthers'],
  'ND':['University of Notre Dame','Notre Dame','Fighting Irish','Irish'],
  'NORT':['Northern Iowa','Panthers'],
  'DRKE':['Drake University','Drake','Bulldogs'],
  'BRAD':['Bradley University','Bradley','Braves'],
  'ILL ST':['Illinois State University','Illinois State','Redbirds'],
  'INST':['Indiana State','Sycamores'],
  'SDST':['South Dakota State','Jackrabbits'],
  'NDSU':['North Dakota State','Bison'],
};

// =====================
//  STATE
// =====================
function loadEnabledSports(){
  try{const s=ss.get('ss_sports');return s?new Set(JSON.parse(s)):new Set(DEFAULT_ENABLED);}catch(e){return new Set(DEFAULT_ENABLED);}
}
function saveEnabledSports(){ss.set('ss_sports',JSON.stringify([...state.enabledSports]));}

const state={
  layout:'grid',
  enabledSports:loadEnabledSports(),
  statsDepth:'basic',
  filterMode:'all',
  games:{},
  favTeams:loadFavs(),
  favLeagues:loadFavLeagues(),
  showEnded:false,
  daysPerSport:{nfl:7,nhl:2,nba:2,mlb:1,ncaamb:2,ncaawb:2,ncaabase:1,ncaasb:1,ncaafb:7},
  endedLeagues:new Set(ALL_SPORTS.map(s=>s.id)),
  endedFilter:Object.fromEntries(ALL_SPORTS.map(s=>[s.id,'all'])),
  seasonMeta:{},
  usingMock:false,
  refreshRate:60,
  display:{abbrSize:18,scoreSize:34,nameSize:11,nameColor:'#3d5a78'},
};

// getter
function getSPORTS(){return ALL_SPORTS.filter(s=>state.enabledSports.has(s.id));}

function loadFavs(){try{return new Set(JSON.parse(ss.get('ss_favs')||'[]'));}catch(e){return new Set();}}
function loadFavLeagues(){try{return new Set(JSON.parse(ss.get('ss_fav_leagues')||'[]'));}catch(e){return new Set();}}
function saveFavs(){ss.set('ss_favs',JSON.stringify([...state.favTeams]));}
function saveFavLeagues(){ss.set('ss_fav_leagues',JSON.stringify([...state.favLeagues]));}
function saveDisplay(){ss.set('ss_display',JSON.stringify(state.display));}
function loadDisplay(){try{const d=ss.get('ss_display');if(d)Object.assign(state.display,JSON.parse(d));}catch(e){}}

// =====================
//  FAVORITES
// =====================
function toggleFavTeam(n){if(state.favTeams.has(n))state.favTeams.delete(n);else state.favTeams.add(n);saveFavs();renderScoreboard();renderFavSummary();}
function toggleFavLeague(id){if(state.favLeagues.has(id))state.favLeagues.delete(id);else state.favLeagues.add(id);saveFavLeagues();renderScoreboard();renderFavSummary();}
function isGameFavorited(g){if(state.favLeagues.has(g.sport))return true;return g.teams.some(t=>state.favTeams.has(t.name)||state.favTeams.has(t.abbr));}

function renderFavSummary(){
  const c=document.getElementById('favSummary');if(!c)return;
  const tags=[];
  state.favLeagues.forEach(lid=>{const s=ALL_SPORTS.find(x=>x.id===lid);if(!s)return;tags.push(`<div class="fav-tag" onclick="toggleFavLeague('${lid}')">${s.emoji} ${s.name} <span class="remove-fav">‚úï</span></div>`);});
  state.favTeams.forEach(t=>{const safe=t.replace(/'/g,"\\'");tags.push(`<div class="fav-tag" onclick="toggleFavTeam('${safe}')">‚≠ê ${t} <span class="remove-fav">‚úï</span></div>`);});
  c.innerHTML=tags.length?tags.join(''):'<div class="no-favs-hint">Star a team or league to pin it here</div>';
}

// =====================
//  ENDED GAMES
// =====================
function buildEndedLeagueToggles(){
  const c=document.getElementById('endedLeagueToggles');if(!c)return;c.innerHTML='';
  getSPORTS().forEach(sport=>{
    const on=state.endedLeagues.has(sport.id),days=state.daysPerSport[sport.id]||1,filter=state.endedFilter[sport.id]||'all';
    const row=document.createElement('div');
    row.className=`ended-league-row${on?' active':''}`;row.id=`ended-row-${sport.id}`;
    row.innerHTML=`
      <div class="ended-league-header">
        <div class="ended-league-name"><div style="width:7px;height:7px;border-radius:2px;background:${sport.color}"></div>${sport.emoji} ${sport.name}</div>
        <div class="small-toggle${on?' on':''}" id="ended-toggle-${sport.id}" onclick="toggleEndedLeague('${sport.id}')"></div>
      </div>
      <div class="ended-league-slider-wrap">
        <div class="league-days-row">
          <span class="league-days-label">Days back:</span>
          <input type="range" min="1" max="7" value="${days}" id="days-slider-${sport.id}" oninput="onLeagueDaysChange('${sport.id}',this.value)">
          <span class="league-days-val" id="days-val-${sport.id}">${days}d</span>
        </div>
        <div class="ended-filter-row">
          <div class="ended-filter-pill ${filter==='all'?'active':''}" onclick="setEndedFilter('${sport.id}','all')" id="efp-all-${sport.id}">All</div>
          <div class="ended-filter-pill fav ${filter==='favs-first'?'active fav':''}" onclick="setEndedFilter('${sport.id}','favs-first')" id="efp-first-${sport.id}">‚≠ê First</div>
          <div class="ended-filter-pill fav ${filter==='favs-only'?'active fav':''}" onclick="setEndedFilter('${sport.id}','favs-only')" id="efp-only-${sport.id}">‚≠ê Only</div>
        </div>
      </div>`;
    c.appendChild(row);
  });
}

function setEndedFilter(sid,v){
  state.endedFilter[sid]=v;
  ['all','favs-first','favs-only'].forEach(x=>{
    const k=x==='all'?'all':x==='favs-first'?'first':'only';
    const el=document.getElementById(`efp-${k}-${sid}`);if(!el)return;
    el.classList.toggle('active',x===v);if(x!=='all')el.classList.toggle('fav',x===v);
  });
  renderScoreboard();
}

function toggleEndedMaster(){
  state.showEnded=!state.showEnded;
  document.getElementById('endedMasterToggle').classList.toggle('on',state.showEnded);
  document.getElementById('endedControls').style.display=state.showEnded?'block':'none';
  if(state.showEnded)buildEndedLeagueToggles();
  fetchAllScores();
}

function toggleEndedLeague(id){
  if(state.endedLeagues.has(id))state.endedLeagues.delete(id);else state.endedLeagues.add(id);
  document.getElementById(`ended-toggle-${id}`)?.classList.toggle('on',state.endedLeagues.has(id));
  document.getElementById(`ended-row-${id}`)?.classList.toggle('active',state.endedLeagues.has(id));
  fetchAllScores();
}

function onLeagueDaysChange(sid,v){
  state.daysPerSport[sid]=parseInt(v);
  const el=document.getElementById(`days-val-${sid}`);if(el)el.textContent=`${v}d`;
  fetchAllScores();
}

// =====================
//  SIDEBAR SPORT TOGGLES
// =====================
function getSPORTS(){return ALL_SPORTS.filter(s=>state.enabledSports.has(s.id));}

function buildSportToggles(){
  const c=document.getElementById('sport-toggles');c.innerHTML='';
  getSPORTS().forEach(sport=>{
    const active=true; // all enabled sports shown as active by default
    const season=state.seasonMeta[sport.id];
    const isOff=season?.isOff||false;
    const div=document.createElement('div');
    div.className=`sport-toggle active${isOff?' off-season':''}`;
    div.id=`sport-toggle-${sport.id}`;
    div.dataset.sport=sport.id;
    let badge='';
    if(season&&season.key!=='reg')badge=`<span class="sport-season-badge ${season.key}">${season.label}</span>`;
    div.innerHTML=`
      <div class="sport-info">
        <div class="sport-dot" style="background:${sport.color}"></div>
        <div><span class="sport-name">${sport.name}</span>${badge}</div>
      </div>
      <div style="display:flex;align-items:center;gap:5px;">
        <span class="sport-count" id="count-${sport.id}">‚Äì</span>
        <div class="toggle-switch"></div>
      </div>`;
    c.appendChild(div);
  });
}

function refreshSportToggles(){buildSportToggles();}

// =====================
//  DISPLAY SETTINGS
// =====================
function applyDisplay(){
  const abbrEl=document.getElementById('sl-abbr'),scoreEl=document.getElementById('sl-score'),nameEl=document.getElementById('sl-name'),colorEl=document.getElementById('nameColorPicker');
  if(abbrEl){state.display.abbrSize=parseInt(abbrEl.value);document.getElementById('val-abbr').textContent=abbrEl.value+'px';}
  if(scoreEl){state.display.scoreSize=parseInt(scoreEl.value);document.getElementById('val-score').textContent=scoreEl.value+'px';}
  if(nameEl){state.display.nameSize=parseInt(nameEl.value);document.getElementById('val-name').textContent=nameEl.value+'px';}
  if(colorEl){state.display.nameColor=colorEl.value;document.getElementById('nameColorVal').textContent=colorEl.value;document.getElementById('nameColorSwatch').style.background=colorEl.value;}
  const root=document.documentElement;
  root.style.setProperty('--card-abbr-size',state.display.abbrSize+'px');
  root.style.setProperty('--card-score-size',state.display.scoreSize+'px');
  root.style.setProperty('--card-name-size',state.display.nameSize+'px');
  root.style.setProperty('--card-name-color',state.display.nameColor);
  saveDisplay();
}

function setNameColor(c){
  document.getElementById('nameColorPicker').value=c;
  applyDisplay();
}

function initDisplayControls(){
  loadDisplay();
  const root=document.documentElement;
  root.style.setProperty('--card-abbr-size',state.display.abbrSize+'px');
  root.style.setProperty('--card-score-size',state.display.scoreSize+'px');
  root.style.setProperty('--card-name-size',state.display.nameSize+'px');
  root.style.setProperty('--card-name-color',state.display.nameColor);
  const abbrEl=document.getElementById('sl-abbr');if(abbrEl){abbrEl.value=state.display.abbrSize;document.getElementById('val-abbr').textContent=state.display.abbrSize+'px';}
  const scoreEl=document.getElementById('sl-score');if(scoreEl){scoreEl.value=state.display.scoreSize;document.getElementById('val-score').textContent=state.display.scoreSize+'px';}
  const nameEl=document.getElementById('sl-name');if(nameEl){nameEl.value=state.display.nameSize;document.getElementById('val-name').textContent=state.display.nameSize+'px';}
  const colorEl=document.getElementById('nameColorPicker');if(colorEl){colorEl.value=state.display.nameColor;document.getElementById('nameColorSwatch').style.background=state.display.nameColor;document.getElementById('nameColorVal').textContent=state.display.nameColor;}
}

// =====================
//  REFRESH RATE
// =====================
let autoRefreshTimer=null;
function setRefreshRate(r){
  state.refreshRate=r;
  document.querySelectorAll('.rate-pill').forEach(p=>p.classList.toggle('active',parseInt(p.dataset.rate)===r));
  const el=document.getElementById('rateStatus');
  if(el)el.textContent=r===0?'Auto-refresh: disabled':`Auto-refresh: every ${r<60?r+' seconds':r/60+' minute(s)'}`;
  startAutoRefresh();
  ss.set('ss_refresh_rate',String(r));
}

function startAutoRefresh(){
  clearInterval(autoRefreshTimer);
  if(state.refreshRate>0)autoRefreshTimer=setInterval(fetchAllScores,state.refreshRate*1000);
}

// =====================
//  SETTINGS MODAL
// =====================
function openSettings(tab='sports'){
  document.getElementById('settingsOverlay').style.display='flex';
  switchTab(tab);
  buildSportsTab();
  updateTbFavCount();
}

function closeSettings(){document.getElementById('settingsOverlay').style.display='none';}
function handleModalOverlay(e){if(e.target===document.getElementById('settingsOverlay'))closeSettings();}

function switchTab(tab){
  document.querySelectorAll('.modal-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  document.querySelectorAll('.tab-panel').forEach(p=>p.style.display='none');
  const panel=document.getElementById(`tab-${tab}`);if(panel)panel.style.display='block';
  if(tab==='teams'){buildTbTabs();loadTbSport(tbState.activeSport||getSPORTS()[0]?.id);}
}

// =====================
//  SPORTS SETTINGS TAB
// =====================
function buildSportsTab(){
  ['pro','ncaam','ncaaw'].forEach(group=>{
    const suffix=group==='pro'?'pro':group==='ncaam'?'ncaam':'ncaaw';
    const c=document.getElementById(`sg-${suffix}`);if(!c)return;c.innerHTML='';
    ALL_SPORTS.filter(s=>s.group===group).forEach(sport=>{
      const on=state.enabledSports.has(sport.id);
      const row=document.createElement('div');
      row.className=`sport-setting-row${on?' enabled':''}`;
      row.innerHTML=`
        <div class="sport-setting-info">
          <div style="width:8px;height:8px;border-radius:2px;background:${sport.color}"></div>
          <span class="sport-setting-name">${sport.emoji} ${sport.name}</span>
        </div>
        <div class="small-toggle${on?' on':''}" id="ss-toggle-${sport.id}" onclick="toggleSportEnabled('${sport.id}',this)"></div>`;
      c.appendChild(row);
    });
  });
}

function toggleSportEnabled(id,toggleEl){
  if(state.enabledSports.has(id))state.enabledSports.delete(id);else state.enabledSports.add(id);
  const on=state.enabledSports.has(id);
  toggleEl.classList.toggle('on',on);
  toggleEl.closest('.sport-setting-row').classList.toggle('enabled',on);
  saveEnabledSports();
  buildSportToggles();
  renderScoreboard();
}

// =====================
//  ESPN API
// =====================
function buildHistoricalUrl(sport,daysAgo){
  const d=new Date();d.setDate(d.getDate()-daysAgo);
  return sport.url+`?dates=${d.toISOString().slice(0,10).replace(/-/g,'')}`;
}

function parseGame(ev,sport){
  const comp=ev.competitions?.[0],status=ev.status,statusType=status?.type?.name||'STATUS_SCHEDULED',periodDesc=status?.type?.shortDetail||'';
  const teams=(comp?.competitors||[]).map(c=>({
    abbr:c.team?.abbreviation||'???',name:c.team?.displayName||c.team?.name||'Unknown',
    score:c.score||'0',color:c.team?.color?`#${c.team.color}`:'#333',
    logo:c.team?.logo||null,homeAway:c.homeAway,winner:c.winner||false,
  }));
  let stats=[];
  try{stats=(comp?.leaders||[]).slice(0,3).map(l=>({label:l.abbreviation||l.name,value:l.leaders?.[0]?.displayValue||'‚Äì'}));}catch(e){}
  return{id:ev.id,sport:sport.id,sportName:sport.name,sportColor:sport.color,sportEmoji:sport.emoji,
    name:ev.name||'',date:ev.date,statusType,periodDesc,teams,stats,
    isLive:statusType==='STATUS_IN_PROGRESS',isFinal:statusType==='STATUS_FINAL',isScheduled:statusType==='STATUS_SCHEDULED'};
}

function getSeasonMeta(t,n){
  const m={1:{key:'pre',label:n||'Preseason',isOff:false},2:{key:'reg',label:'Regular Season',isOff:false},3:{key:'post',label:'Postseason',isOff:false},4:{key:'off',label:'Off Season',isOff:true}};
  return m[t]||{key:'reg',label:'',isOff:false};
}

const MOCK={
  nfl:[],
  nba:[
    {id:'b1',sport:'nba',sportName:'NBA',sportColor:'#c9082a',sportEmoji:'üèÄ',isLive:true,isFinal:false,isScheduled:false,periodDesc:'Q4 2:15',date:new Date().toISOString(),stats:[],teams:[{abbr:'LAL',name:'Los Angeles Lakers',score:'108',color:'#552583',logo:null,homeAway:'away',winner:false},{abbr:'BOS',name:'Boston Celtics',score:'112',color:'#007A33',logo:null,homeAway:'home',winner:false}]},
    {id:'b2',sport:'nba',sportName:'NBA',sportColor:'#c9082a',sportEmoji:'üèÄ',isLive:false,isFinal:false,isScheduled:true,periodDesc:'',date:new Date(Date.now()+7200000).toISOString(),stats:[],teams:[{abbr:'GSW',name:'Golden State Warriors',score:'0',color:'#1D428A',logo:null,homeAway:'away',winner:false},{abbr:'MIA',name:'Miami Heat',score:'0',color:'#98002E',logo:null,homeAway:'home',winner:false}]},
  ],
  mlb:[
    {id:'m1',sport:'mlb',sportName:'MLB',sportColor:'#002d72',sportEmoji:'‚öæ',isLive:false,isFinal:true,isScheduled:false,periodDesc:'Final',date:new Date(Date.now()-86400000).toISOString(),stats:[],teams:[{abbr:'NYY',name:'New York Yankees',score:'5',color:'#003087',logo:null,homeAway:'away',winner:true},{abbr:'BOS',name:'Boston Red Sox',score:'3',color:'#BD3039',logo:null,homeAway:'home',winner:false}]},
  ],
  nhl:[
    {id:'h1',sport:'nhl',sportName:'NHL',sportColor:'#00b7e0',sportEmoji:'üèí',isLive:true,isFinal:false,isScheduled:false,periodDesc:'3rd 4:30',date:new Date().toISOString(),stats:[],teams:[{abbr:'TOR',name:'Toronto Maple Leafs',score:'2',color:'#00205B',logo:null,homeAway:'away',winner:false},{abbr:'MTL',name:'Montreal Canadiens',score:'3',color:'#AF1E2D',logo:null,homeAway:'home',winner:false}]},
  ],
  ncaamb:[{id:'cb1',sport:'ncaamb',sportName:"NCAA Men's Basketball",sportColor:'#ff6600',sportEmoji:'üèÄ',isLive:false,isFinal:true,isScheduled:false,periodDesc:'Final',date:new Date(Date.now()-86400000).toISOString(),stats:[],teams:[{abbr:'TEX',name:'Texas Longhorns',score:'78',color:'#BF5700',logo:null,homeAway:'away',winner:true},{abbr:'KU',name:'Kansas Jayhawks',score:'71',color:'#0051A5',logo:null,homeAway:'home',winner:false}]}],
  ncaawb:[],ncaabase:[],ncaasb:[],ncaafb:[],
};

async function fetchSport(sport){
  try{
    const ctrl=new AbortController();setTimeout(()=>ctrl.abort(),7000);
    const res=await fetch(sport.url,{signal:ctrl.signal});
    if(!res.ok)throw new Error();
    const data=await res.json();
    const sType=data.season?.type||data.leagues?.[0]?.season?.type||2;
    const sName=data.season?.displayName||data.leagues?.[0]?.season?.displayName||'';
    state.seasonMeta[sport.id]=getSeasonMeta(sType,sName);
    let games=(data.events||[]).map(ev=>parseGame(ev,sport));
    const sportDays=state.daysPerSport[sport.id]||1;
    if(state.showEnded&&state.endedLeagues.has(sport.id)&&sportDays>0){
      const fetches=[];
      for(let i=1;i<=sportDays;i++)fetches.push(fetch(buildHistoricalUrl(sport,i)).then(r=>r.ok?r.json():null).catch(()=>null));
      const results=await Promise.all(fetches);
      results.forEach(d=>{if(!d)return;(d.events||[]).forEach(ev=>{const g=parseGame(ev,sport);if(g.isFinal&&!games.find(x=>x.id===g.id))games.push(g);});});
    }
    games.sort((a,b)=>(a.isLive?0:a.isScheduled?1:2)-(b.isLive?0:b.isScheduled?1:2));
    state.games[sport.id]=games;state.usingMock=false;
  }catch(e){
    console.info(`[${sport.name}] using demo data`);
    state.games[sport.id]=(MOCK[sport.id]||[]).map(g=>({...g}));
    const ms={nfl:4,nba:2,mlb:2,nhl:2,ncaamb:3,ncaawb:2,ncaabase:1,ncaasb:1,ncaafb:4};
    const mn={nfl:'Off Season',nba:'Regular Season',mlb:'Regular Season',nhl:'Regular Season',ncaamb:'Postseason',ncaawb:'Regular Season',ncaabase:'',ncaasb:'',ncaafb:'Off Season'};
    state.seasonMeta[sport.id]=getSeasonMeta(ms[sport.id]||2,mn[sport.id]||'');
    state.usingMock=true;
  }
  const el=document.getElementById(`count-${sport.id}`);if(el)el.textContent=state.games[sport.id].length;
}

async function fetchAllScores(){
  const btn=document.getElementById('refreshBtn');
  if(btn){btn.innerHTML='‚Üª Fetching...';btn.style.opacity='0.6';}
  showLoadingState();
  await Promise.all(getSPORTS().map(s=>fetchSport(s)));
  refreshSportToggles();updateTopbar();renderScoreboard();
  const el=document.getElementById('lastUpdate');
  if(el)el.textContent=`Updated: ${new Date().toLocaleTimeString()}${state.usingMock?' (demo)':''}`;
  if(btn){btn.innerHTML='<span>‚Üª</span> Refresh Scores';btn.style.opacity='1';}
}

// =====================
//  RENDER
// =====================
function showLoadingState(){const sb=document.getElementById('scoreboard');if(sb)sb.innerHTML=Array(4).fill('<div class="loading-skeleton"></div>').join('');}

function updateTopbar(){
  let live=0,total=0;
  getSPORTS().forEach(s=>{const g=state.games[s.id]||[];live+=g.filter(x=>x.isLive).length;total+=g.length;});
  const lc=document.getElementById('liveCount'),tc=document.getElementById('totalCount');
  if(lc)lc.textContent=live;if(tc)tc.textContent=total;
}

function renderScoreboard(){
  const sb=document.getElementById('scoreboard');if(!sb)return;sb.innerHTML='';
  const hasFavs=state.favTeams.size>0||state.favLeagues.size>0;
  const favsOnly=state.filterMode==='favorites';
  const sports=getSPORTS();

  if(hasFavs&&!favsOnly){
    const pinned=[];
    sports.forEach(sport=>{
      if(!state.enabledSports.has(sport.id))return;
      (state.games[sport.id]||[]).forEach(g=>{
        if(g.isFinal&&(!state.showEnded||!state.endedLeagues.has(sport.id)))return;
        if(g.isFinal&&state.endedFilter[sport.id]==='favs-only'&&!isGameFavorited(g))return;
        if(isGameFavorited(g))pinned.push(g);
      });
    });
    if(pinned.length){
      const sec=document.createElement('div');sec.className='pinned-section';
      sec.innerHTML=`<div class="pinned-header"><div class="pinned-stripe"></div><div class="pinned-title">‚≠ê My Teams</div><div class="pinned-count">${pinned.length} game${pinned.length!==1?'s':''}</div></div>`;
      const grid=document.createElement('div');grid.className=`games-grid ${state.layout}-mode`;
      pinned.forEach(g=>grid.appendChild(buildGameCard(g)));sec.appendChild(grid);sb.appendChild(sec);
    }
  }

  let anyGame=false;
  sports.forEach(sport=>{
    const season=state.seasonMeta[sport.id];
    let games=state.games[sport.id]||[];
    if(season?.isOff&&games.length===0)return;
    if(state.filterMode==='live')games=games.filter(g=>g.isLive);
    else if(favsOnly)games=games.filter(g=>isGameFavorited(g));
    if(!state.showEnded||!state.endedLeagues.has(sport.id))games=games.filter(g=>!g.isFinal);
    else{
      const ef=state.endedFilter[sport.id]||'all';
      if(ef==='favs-only'&&hasFavs)games=games.filter(g=>!g.isFinal||isGameFavorited(g));
      else if(ef==='favs-first'&&hasFavs){
        const ff=games.filter(g=>g.isFinal&&isGameFavorited(g)),nff=games.filter(g=>g.isFinal&&!isGameFavorited(g)),nf=games.filter(g=>!g.isFinal);
        games=[...nf,...ff,...nff];
      }
    }
    if(!games.length)return;anyGame=true;
    const isFavL=state.favLeagues.has(sport.id);
    let sbadge='';
    if(season&&(season.key==='pre'||season.key==='post'))sbadge=`<span class="league-season-badge ${season.key}">${season.label}</span>`;
    const sec=document.createElement('div');sec.className=`league-section${isFavL?' fav-league':''}`;
    sec.innerHTML=`<div class="league-header"><div class="league-stripe" style="background:${isFavL?'#ffd700':sport.color}"></div><div class="league-name">${sport.emoji} ${sport.name}</div>${sbadge}<button class="league-star-btn ${isFavL?'starred':''}" onclick="toggleFavLeague('${sport.id}')">‚≠ê</button><div class="league-game-count">${games.length} game${games.length!==1?'s':''}</div></div>`;
    const grid=document.createElement('div');grid.className=`games-grid ${state.layout}-mode`;
    games.forEach(g=>grid.appendChild(buildGameCard(g)));sec.appendChild(grid);sb.appendChild(sec);
  });

  if(!anyGame&&!sb.querySelector('.pinned-section')){
    sb.innerHTML=`<div class="empty-state"><div class="empty-icon">${favsOnly?'‚≠ê':'üì∫'}</div><div class="empty-text">${favsOnly?'No favorites playing':'No games to show'}</div><div style="font-size:12px;color:var(--text-dim);margin-top:8px;">${favsOnly?'Star a team or league, or switch to All':state.filterMode==='live'?'No live games right now':'Enable sports in Settings or turn on Ended Games'}</div></div>`;
  }
}

function buildGameCard(g){return state.layout==='ticker'?buildTickerCard(g):buildFullCard(g);}

function buildTickerCard(g){
  const card=document.createElement('div');card.className=`game-card${g.isLive?' live':''}${g.isFinal?' is-final':''}`;
  const away=g.teams.find(t=>t.homeAway==='away')||g.teams[0],home=g.teams.find(t=>t.homeAway==='home')||g.teams[1];
  const sh=g.isLive?`<div class="status-live"><div class="status-live-dot"></div>${g.periodDesc}</div>`:g.isFinal?'<span class="status-final">FINAL</span>':`<span class="status-upcoming">${formatTime(g.date)}</span>`;
  card.innerHTML=`<div class="ticker-row"><div style="width:6px;height:18px;border-radius:2px;background:${g.sportColor};flex-shrink:0"></div><div class="ticker-teams">${away?.abbr||'‚Äì'} vs ${home?.abbr||'‚Äì'}</div><div class="ticker-score">${away?.score??'‚Äì'} ‚Äì ${home?.score??'‚Äì'}</div><div class="ticker-period">${sh}</div></div>`;
  return card;
}

function buildFullCard(g){
  const card=document.createElement('div'),favd=isGameFavorited(g);
  card.className=`game-card${g.isLive?' live':''}${g.isFinal?' is-final':''}${favd?' favorited':''}`;
  const away=g.teams.find(t=>t.homeAway==='away')||g.teams[0],home=g.teams.find(t=>t.homeAway==='home')||g.teams[1];
  const as=parseInt(away?.score||0),hs=parseInt(home?.score||0);
  const aw=g.isFinal&&as>hs,hw=g.isFinal&&hs>as;
  const af=away&&(state.favTeams.has(away.name)||state.favTeams.has(away.abbr));
  const hf=home&&(state.favTeams.has(home.name)||state.favTeams.has(home.abbr));
  const an=(away?.name||'').replace(/'/g,"\\'"),hn=(home?.name||'').replace(/'/g,"\\'");
  const sh=g.isLive?`<div class="status-live"><div class="status-live-dot"></div>${g.periodDesc}</div>`:g.isFinal?'<span class="status-final">FINAL</span>':`<span class="status-upcoming">${formatTime(g.date)}</span>`;
  card.innerHTML=`
    <div class="card-status">${sh}<span class="game-period" style="color:${g.sportColor}">${g.sportEmoji} ${g.sportName}</span></div>
    <div class="card-body">
      <div class="teams-container">
        <div class="team-row${aw?' winning':g.isFinal?' losing':''}">
          ${teamLogo(away)}
          <div class="team-name-block"><div class="team-abbr">${away?.abbr||'‚Äì'}</div><div class="team-full-name">${away?.name||''} ¬∑ Away</div></div>
          <button class="star-btn ${af?'starred':''}" onclick="toggleFavTeam('${an}')">‚≠ê</button>
          <div class="team-score">${g.isScheduled?'‚Äì':away?.score??'‚Äì'}</div>
        </div>
        <div style="height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:2px 0;"></div>
        <div class="team-row${hw?' winning':g.isFinal?' losing':''}">
          ${teamLogo(home)}
          <div class="team-name-block"><div class="team-abbr">${home?.abbr||'‚Äì'}</div><div class="team-full-name">${home?.name||''} ¬∑ Home</div></div>
          <button class="star-btn ${hf?'starred':''}" onclick="toggleFavTeam('${hn}')">‚≠ê</button>
          <div class="team-score">${g.isScheduled?'‚Äì':home?.score??'‚Äì'}</div>
        </div>
      </div>
      ${buildStats(g)}
    </div>`;
  return card;
}

function teamLogo(team){
  if(!team)return'';
  const bg=team.color||'#1a2a3a',text=(team.abbr||'?').substring(0,3);
  if(team.logo)return`<div class="team-logo-placeholder" style="background:#${bg.replace('#','')};padding:3px"><img src="${team.logo}" style="width:100%;height:100%;object-fit:contain;border-radius:4px" onerror="this.parentNode.textContent='${text}'"></div>`;
  return`<div class="team-logo-placeholder" style="background:#${bg.replace('#','')};color:white">${text}</div>`;
}

function buildStats(g){
  if(state.statsDepth==='basic'||!g.stats?.length)return'';
  const cells=g.stats.map(s=>`<div class="stat-cell"><span class="stat-val">${s.value}</span><span class="stat-lbl">${s.label}</span></div>`).join('');
  return cells?`<div class="stats-bar">${cells}</div>`:'';
}

function formatTime(d){if(!d)return'TBD';try{return new Date(d).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}catch(e){return'TBD';}}

// =====================
//  TEAM BROWSER
// =====================
const TEAM_URLS={
  nfl:'https://site.api.espn.com/apis/site/v2/sports/football/nfl/teams?limit=50',
  nba:'https://site.api.espn.com/apis/site/v2/sports/basketball/nba/teams?limit=50',
  mlb:'https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams?limit=50',
  nhl:'https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/teams?limit=50',
  ncaamb:'https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/teams?limit=200',
  ncaawb:'https://site.api.espn.com/apis/site/v2/sports/basketball/womens-college-basketball/teams?limit=200',
  ncaabase:'https://site.api.espn.com/apis/site/v2/sports/baseball/college-baseball/teams?limit=200',
  ncaasb:'https://site.api.espn.com/apis/site/v2/sports/baseball/college-softball/teams?limit=200',
  ncaafb:'https://site.api.espn.com/apis/site/v2/sports/football/college-football/teams?limit=200',
};

// Static fallback for major pro teams
const MOCK_TEAMS={
  nfl:[{abbr:'ARI',name:'Arizona Cardinals',color:'97233F'},{abbr:'ATL',name:'Atlanta Falcons',color:'A71930'},{abbr:'BAL',name:'Baltimore Ravens',color:'241773'},{abbr:'BUF',name:'Buffalo Bills',color:'00338D'},{abbr:'CAR',name:'Carolina Panthers',color:'0085CA'},{abbr:'CHI',name:'Chicago Bears',color:'0B162A'},{abbr:'CIN',name:'Cincinnati Bengals',color:'FB4F14'},{abbr:'CLE',name:'Cleveland Browns',color:'311D00'},{abbr:'DAL',name:'Dallas Cowboys',color:'003594'},{abbr:'DEN',name:'Denver Broncos',color:'FB4F14'},{abbr:'DET',name:'Detroit Lions',color:'0076B6'},{abbr:'GB',name:'Green Bay Packers',color:'203731'},{abbr:'HOU',name:'Houston Texans',color:'03202F'},{abbr:'IND',name:'Indianapolis Colts',color:'002C5F'},{abbr:'JAX',name:'Jacksonville Jaguars',color:'006778'},{abbr:'KC',name:'Kansas City Chiefs',color:'E31837'},{abbr:'LAC',name:'Los Angeles Chargers',color:'0080C6'},{abbr:'LAR',name:'Los Angeles Rams',color:'003594'},{abbr:'LV',name:'Las Vegas Raiders',color:'000000'},{abbr:'MIA',name:'Miami Dolphins',color:'008E97'},{abbr:'MIN',name:'Minnesota Vikings',color:'4F2683'},{abbr:'NE',name:'New England Patriots',color:'002244'},{abbr:'NO',name:'New Orleans Saints',color:'D3BC8D'},{abbr:'NYG',name:'New York Giants',color:'0B2265'},{abbr:'NYJ',name:'New York Jets',color:'125740'},{abbr:'PHI',name:'Philadelphia Eagles',color:'004C54'},{abbr:'PIT',name:'Pittsburgh Steelers',color:'FFB612'},{abbr:'SEA',name:'Seattle Seahawks',color:'002244'},{abbr:'SF',name:'San Francisco 49ers',color:'AA0000'},{abbr:'TB',name:'Tampa Bay Buccaneers',color:'D50A0A'},{abbr:'TEN',name:'Tennessee Titans',color:'0C2340'},{abbr:'WSH',name:'Washington Commanders',color:'5A1414'}],
  nba:[{abbr:'ATL',name:'Atlanta Hawks',color:'E03A3E'},{abbr:'BOS',name:'Boston Celtics',color:'007A33'},{abbr:'BKN',name:'Brooklyn Nets',color:'000000'},{abbr:'CHA',name:'Charlotte Hornets',color:'1D1160'},{abbr:'CHI',name:'Chicago Bulls',color:'CE1141'},{abbr:'CLE',name:'Cleveland Cavaliers',color:'860038'},{abbr:'DAL',name:'Dallas Mavericks',color:'00538C'},{abbr:'DEN',name:'Denver Nuggets',color:'0E2240'},{abbr:'DET',name:'Detroit Pistons',color:'C8102E'},{abbr:'GSW',name:'Golden State Warriors',color:'1D428A'},{abbr:'HOU',name:'Houston Rockets',color:'CE1141'},{abbr:'IND',name:'Indiana Pacers',color:'002D62'},{abbr:'LAC',name:'LA Clippers',color:'C8102E'},{abbr:'LAL',name:'Los Angeles Lakers',color:'552583'},{abbr:'MEM',name:'Memphis Grizzlies',color:'5D76A9'},{abbr:'MIA',name:'Miami Heat',color:'98002E'},{abbr:'MIL',name:'Milwaukee Bucks',color:'00471B'},{abbr:'MIN',name:'Minnesota Timberwolves',color:'0C2340'},{abbr:'NOP',name:'New Orleans Pelicans',color:'0C2340'},{abbr:'NYK',name:'New York Knicks',color:'006BB6'},{abbr:'OKC',name:'Oklahoma City Thunder',color:'007AC1'},{abbr:'ORL',name:'Orlando Magic',color:'0077C0'},{abbr:'PHI',name:'Philadelphia 76ers',color:'006BB6'},{abbr:'PHX',name:'Phoenix Suns',color:'1D1160'},{abbr:'POR',name:'Portland Trail Blazers',color:'E03A3E'},{abbr:'SAC',name:'Sacramento Kings',color:'5A2D81'},{abbr:'SAS',name:'San Antonio Spurs',color:'C4CED4'},{abbr:'TOR',name:'Toronto Raptors',color:'CE1141'},{abbr:'UTA',name:'Utah Jazz',color:'002B5C'},{abbr:'WAS',name:'Washington Wizards',color:'002B5C'}],
  mlb:[{abbr:'ARI',name:'Arizona Diamondbacks',color:'A71930'},{abbr:'ATL',name:'Atlanta Braves',color:'CE1141'},{abbr:'BAL',name:'Baltimore Orioles',color:'DF4601'},{abbr:'BOS',name:'Boston Red Sox',color:'BD3039'},{abbr:'CHC',name:'Chicago Cubs',color:'0E3386'},{abbr:'CWS',name:'Chicago White Sox',color:'27251F'},{abbr:'CIN',name:'Cincinnati Reds',color:'C6011F'},{abbr:'CLE',name:'Cleveland Guardians',color:'00385D'},{abbr:'COL',name:'Colorado Rockies',color:'33006F'},{abbr:'DET',name:'Detroit Tigers',color:'0C2340'},{abbr:'HOU',name:'Houston Astros',color:'002D62'},{abbr:'KC',name:'Kansas City Royals',color:'004687'},{abbr:'LAA',name:'Los Angeles Angels',color:'BA0021'},{abbr:'LAD',name:'Los Angeles Dodgers',color:'005A9C'},{abbr:'MIA',name:'Miami Marlins',color:'00A3E0'},{abbr:'MIL',name:'Milwaukee Brewers',color:'FFC52F'},{abbr:'MIN',name:'Minnesota Twins',color:'002B5C'},{abbr:'NYM',name:'New York Mets',color:'002D72'},{abbr:'NYY',name:'New York Yankees',color:'003087'},{abbr:'OAK',name:'Oakland Athletics',color:'003831'},{abbr:'PHI',name:'Philadelphia Phillies',color:'E81828'},{abbr:'PIT',name:'Pittsburgh Pirates',color:'27251F'},{abbr:'SD',name:'San Diego Padres',color:'2F241D'},{abbr:'SF',name:'San Francisco Giants',color:'FD5A1E'},{abbr:'SEA',name:'Seattle Mariners',color:'0C2C56'},{abbr:'STL',name:'St. Louis Cardinals',color:'C41E3A'},{abbr:'TB',name:'Tampa Bay Rays',color:'092C5C'},{abbr:'TEX',name:'Texas Rangers',color:'003278'},{abbr:'TOR',name:'Toronto Blue Jays',color:'134A8E'},{abbr:'WSH',name:'Washington Nationals',color:'AB0003'}],
  nhl:[{abbr:'ANA',name:'Anaheim Ducks',color:'F47A38'},{abbr:'BOS',name:'Boston Bruins',color:'FCB514'},{abbr:'BUF',name:'Buffalo Sabres',color:'002654'},{abbr:'CGY',name:'Calgary Flames',color:'C8102E'},{abbr:'CAR',name:'Carolina Hurricanes',color:'CC0000'},{abbr:'CHI',name:'Chicago Blackhawks',color:'CF0A2C'},{abbr:'COL',name:'Colorado Avalanche',color:'6F263D'},{abbr:'CBJ',name:'Columbus Blue Jackets',color:'002654'},{abbr:'DAL',name:'Dallas Stars',color:'006847'},{abbr:'DET',name:'Detroit Red Wings',color:'CE1126'},{abbr:'EDM',name:'Edmonton Oilers',color:'FF4C00'},{abbr:'FLA',name:'Florida Panthers',color:'041E42'},{abbr:'LAK',name:'Los Angeles Kings',color:'111111'},{abbr:'MIN',name:'Minnesota Wild',color:'154734'},{abbr:'MTL',name:'Montreal Canadiens',color:'AF1E2D'},{abbr:'NSH',name:'Nashville Predators',color:'FFB81C'},{abbr:'NJD',name:'New Jersey Devils',color:'CE1126'},{abbr:'NYI',name:'New York Islanders',color:'00539B'},{abbr:'NYR',name:'New York Rangers',color:'0038A8'},{abbr:'OTT',name:'Ottawa Senators',color:'C2912C'},{abbr:'PHI',name:'Philadelphia Flyers',color:'F74902'},{abbr:'PIT',name:'Pittsburgh Penguins',color:'FCB514'},{abbr:'SJS',name:'San Jose Sharks',color:'006D75'},{abbr:'SEA',name:'Seattle Kraken',color:'001628'},{abbr:'STL',name:'St. Louis Blues',color:'002F87'},{abbr:'TBL',name:'Tampa Bay Lightning',color:'002868'},{abbr:'TOR',name:'Toronto Maple Leafs',color:'00205B'},{abbr:'VAN',name:'Vancouver Canucks',color:'00205B'},{abbr:'VGK',name:'Vegas Golden Knights',color:'B4975A'},{abbr:'WSH',name:'Washington Capitals',color:'041E42'},{abbr:'WPG',name:'Winnipeg Jets',color:'041E42'}],
  ncaamb:[],ncaawb:[],ncaabase:[],ncaasb:[],ncaafb:[],
};

const tbState={activeSport:'nfl',teamCache:{},searchQuery:''};

// Enhanced search: checks abbr, name, AND NCAA_NAMES lookup terms
function teamMatchesQuery(team,query){
  const q=query.toLowerCase();
  if(team.abbr.toLowerCase().includes(q)||team.name.toLowerCase().includes(q))return true;
  const extra=NCAA_NAMES[team.abbr.toUpperCase()];
  if(extra)return extra.some(term=>term.toLowerCase().includes(q));
  return false;
}

async function fetchTeamsForSport(sid){
  if(tbState.teamCache[sid])return tbState.teamCache[sid];
  try{
    const ctrl=new AbortController();setTimeout(()=>ctrl.abort(),6000);
    const res=await fetch(TEAM_URLS[sid],{signal:ctrl.signal});
    if(!res.ok)throw new Error();
    const data=await res.json();
    const raw=data.sports?.[0]?.leagues?.[0]?.teams||data.teams||[];
    const teams=raw.map(t=>{
      const team=t.team||t;
      const abbr=team.abbreviation||team.abbr||'??';
      // Enrich name with full school name if available
      const extra=NCAA_NAMES[abbr.toUpperCase()];
      const displayName=extra?extra[0]:(team.displayName||team.name||'Unknown');
      return{abbr,name:displayName,shortName:team.displayName||team.name||'Unknown',color:team.color||team.alternateColor||'333333',logo:team.logos?.[0]?.href||null};
    }).sort((a,b)=>a.name.localeCompare(b.name));
    tbState.teamCache[sid]=teams;return teams;
  }catch(e){
    const teams=(MOCK_TEAMS[sid]||[]).map(t=>{
      const extra=NCAA_NAMES[t.abbr.toUpperCase()];
      return{...t,name:extra?extra[0]:t.name,shortName:t.name};
    }).sort((a,b)=>a.name.localeCompare(b.name));
    tbState.teamCache[sid]=teams;return teams;
  }
}

function buildTbTabs(){
  const c=document.getElementById('tbTabs');if(!c)return;c.innerHTML='';
  getSPORTS().forEach(sport=>{
    const tab=document.createElement('div');
    tab.style.cssText='padding:6px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:20px;font-family:Barlow Condensed,sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);cursor:pointer;white-space:nowrap;transition:all 0.15s;flex-shrink:0;';
    tab.textContent=`${sport.emoji} ${sport.name}`;
    if(sport.id===tbState.activeSport)tab.style.cssText+='background:rgba(0,212,255,0.12);border-color:var(--accent);color:var(--accent);';
    tab.onclick=()=>{
      tbState.searchQuery='';const si=document.getElementById('tbSearch');if(si)si.value='';
      document.getElementById('tbTabs').querySelectorAll('div').forEach(t=>t.style.cssText=t.style.cssText.replace('background:rgba(0,212,255,0.12);border-color:var(--accent);color:var(--accent);',''));
      tab.style.cssText+='background:rgba(0,212,255,0.12);border-color:var(--accent);color:var(--accent);';
      tbState.activeSport=sport.id;loadTbSport(sport.id);
    };
    c.appendChild(tab);
  });
}

async function loadTbSport(sid){
  const list=document.getElementById('tbTeamList');if(!list)return;
  list.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--text-dim);">Loading teams...</div>';
  tbState.activeSport=sid;
  const teams=await fetchTeamsForSport(sid);
  renderTbTeams(teams);
}

function filterTeams(query){
  tbState.searchQuery=query;
  const teams=tbState.teamCache[tbState.activeSport]||[];
  renderTbTeams(teams);
}

function renderTbTeams(teams){
  const list=document.getElementById('tbTeamList');if(!list)return;
  const q=tbState.searchQuery;
  const filtered=q?teams.filter(t=>teamMatchesQuery(t,q)):teams;
  if(!filtered.length){list.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--text-dim);">No teams found for "${q}"</div>`;return;}
  list.innerHTML='';
  filtered.forEach(team=>{
    const starred=state.favTeams.has(team.name)||state.favTeams.has(team.abbr)||state.favTeams.has(team.shortName);
    const card=document.createElement('div');
    card.style.cssText=`display:flex;align-items:center;gap:10px;padding:8px 11px;background:var(--bg-card);border:1px solid ${starred?'rgba(255,215,0,0.4)':'var(--border)'};border-radius:8px;cursor:pointer;transition:all 0.15s;${starred?'background:rgba(255,215,0,0.05);':''}`;
    const logoHtml=team.logo?`<img src="${team.logo}" style="width:100%;height:100%;object-fit:contain;border-radius:4px" onerror="this.parentNode.textContent='${team.abbr}'">`:`<span style="font-family:Barlow Condensed,sans-serif;font-weight:900;font-size:9px;color:white;">${team.abbr}</span>`;
    card.innerHTML=`
      <div style="width:28px;height:28px;border-radius:6px;background:#${team.color.replace('#','')};display:flex;align-items:center;justify-content:center;flex-shrink:0;">${logoHtml}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-family:Barlow Condensed,sans-serif;font-weight:800;font-size:12px;letter-spacing:0.5px;color:var(--text-primary);line-height:1;">${team.abbr}</div>
        <div class="tb-team-full">${team.name}</div>
      </div>
      <span style="font-size:14px;filter:${starred?'grayscale(0) opacity(1) drop-shadow(0 0 3px rgba(255,215,0,0.5))':'grayscale(1) opacity(0.25)'};transition:all 0.15s;">‚≠ê</span>`;
    card.onclick=()=>{
      const nm=team.name;
      if(state.favTeams.has(nm)){state.favTeams.delete(nm);state.favTeams.delete(team.abbr);state.favTeams.delete(team.shortName);}
      else state.favTeams.add(nm);
      saveFavs();updateTbFavCount();renderTbTeams(teams);
    };
    list.appendChild(card);
  });
  updateTbFavCount();
}

function updateTbFavCount(){
  const el=document.getElementById('tbFavCount');
  if(el)el.innerHTML=`‚≠ê <span style="color:#ffd700;">${state.favTeams.size}</span> team${state.favTeams.size!==1?'s':''} favorited`;
}

// =====================
//  DISPATCHARR
// =====================
const API_BASE='http://localhost:5000';

async function testConnection(){
  const el=document.getElementById('testResult');el.style.display='block';el.className='dispatcharr-test-result';el.textContent='Testing...';
  try{
    const r=await fetch(`${API_BASE}/health`,{signal:AbortSignal.timeout(5000)});
    const d=await r.json();
    if(r.ok){
      el.className='dispatcharr-test-result ok';el.textContent=`‚úÖ API connected ‚Äî ${d.version||'ok'}`;
      const ds=await fetch(`${API_BASE}/dispatcharr/status`);const dd=await ds.json();
      el.textContent+=dd.connected?'\n‚úÖ Dispatcharr reachable':'\n‚ö†Ô∏è Dispatcharr not reachable ‚Äî check DISPATCHARR_URL in .env';
      updateDsStatus(dd.connected);
    }else throw new Error(r.status);
  }catch(e){el.className='dispatcharr-test-result err';el.textContent=`‚ùå Cannot reach API at ${API_BASE}\nMake sure the scorestream-api container is running.`;updateDsStatus(false,'error');}
}

async function createChannels(mode){
  const el=document.getElementById('channelResult');el.style.display='block';el.textContent='Creating channels...';
  try{
    const group=document.getElementById('dGroupInput')?.value||'ScoreStream';
    const start=parseInt(document.getElementById('dChannelStart')?.value||'900');
    const sports=getSPORTS().map(s=>s.name);
    const r=await fetch(`${API_BASE}/dispatcharr/create`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode,sports,group,start}),signal:AbortSignal.timeout(15000)});
    const d=await r.json();
    el.textContent=`‚úÖ Created ${d.created?.length||0} channel(s)${d.errors?.length?`\n‚ö†Ô∏è ${d.errors.length} error(s)`:''}\n${(d.created||[]).map(c=>`#${c.number} ${c.name}`).join('\n')}`;
  }catch(e){el.textContent=`‚ùå Error: ${e.message}`;}
}

function updateDsStatus(connected,state2=''){
  const dot=document.getElementById('dsDot'),label=document.getElementById('dsLabel');
  if(!dot||!label)return;
  if(connected){dot.className='ds-dot connected';label.className='ds-label connected';label.textContent='Dispatcharr: Connected';}
  else if(state2==='error'){dot.className='ds-dot error';label.className='ds-label error';label.textContent='Dispatcharr: Error';}
  else{dot.className='ds-dot';label.className='ds-label';label.textContent='Dispatcharr: Not configured';}
}

// =====================
//  CLOCK
// =====================
function startClock(){
  const el=document.getElementById('clockDisplay');if(!el)return;
  setInterval(()=>{const n=new Date();el.innerHTML=`<span>üïê</span> <span class="val">${n.toLocaleTimeString()}</span>`;},1000);
}

// =====================
//  WIRE UP UI
// =====================
document.querySelectorAll('.layout-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.layout-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');state.layout=btn.dataset.layout;renderScoreboard();
  });
});

document.querySelectorAll('.pill-opt').forEach(opt=>{
  opt.addEventListener('click',()=>{
    document.querySelectorAll(`.pill-opt[data-opt="${opt.dataset.opt}"]`).forEach(o=>o.classList.remove('active'));
    opt.classList.add('active');
    if(opt.dataset.opt==='stats')state.statsDepth=opt.dataset.val;
    if(opt.dataset.opt==='filter')state.filterMode=opt.dataset.val;
    renderScoreboard();
  });
});

document.getElementById('refreshBtn').addEventListener('click',fetchAllScores);

// =====================
//  INIT
// =====================
const savedRate=parseInt(ss.get('ss_refresh_rate')||'60');
state.refreshRate=savedRate;
initDisplayControls();
buildSportToggles();
startClock();
renderFavSummary();
fetchAllScores();
startAutoRefresh();
setRefreshRate(savedRate);
</script>
</body>
</html>