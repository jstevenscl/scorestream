<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ScoreStream</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@300;400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary:#080b10; --bg-secondary:#0d1117; --bg-card:#111722;
  --bg-card-hover:#161e2e; --border:#1e2d42; --border-bright:#2a4060;
  --accent:#00d4ff; --accent2:#ff6b00; --accent-green:#00ff88;
  --accent-red:#ff3b5c; --text-primary:#e8f0fe; --text-secondary:#7a9ab8;
  --text-dim:#3d5a78;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg-primary);color:var(--text-primary);font-family:'Barlow',sans-serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,212,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
#app{position:relative;z-index:1;display:flex;height:100vh;}

/* SIDEBAR */
#sidebar{width:270px;min-width:270px;background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;}
.sidebar-header{padding:16px 20px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,#080b10,#0d1825);}
.logo{display:flex;align-items:center;gap:10px;margin-bottom:4px;}
.logo-icon{width:30px;height:30px;background:linear-gradient(135deg,var(--accent),#0066ff);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;}
.logo-text{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:19px;letter-spacing:2px;text-transform:uppercase;}
.logo-text span{color:var(--accent);}
.logo-sub{font-size:10px;color:var(--text-dim);letter-spacing:3px;text-transform:uppercase;padding-left:40px;}
.live-badge{display:flex;align-items:center;gap:6px;padding:3px 10px;background:rgba(255,59,92,0.15);border:1px solid rgba(255,59,92,0.3);border-radius:4px;margin-top:10px;width:fit-content;}
.live-dot{width:7px;height:7px;background:var(--accent-red);border-radius:50%;animation:pulse-red 1.5s infinite;}
.live-badge span{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--accent-red);}
@keyframes pulse-red{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(255,59,92,0.5);}50%{opacity:0.6;box-shadow:0 0 0 4px rgba(255,59,92,0);}}

.sidebar-section{padding:14px 18px;border-bottom:1px solid var(--border);}
.section-label{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--text-dim);margin-bottom:10px;}

/* Layout buttons */
.layout-btns{display:flex;gap:5px;}
.layout-btn{flex:1;padding:9px 4px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;transition:all 0.2s;color:var(--text-secondary);}
.layout-btn:hover{border-color:var(--accent);color:var(--accent);}
.layout-btn.active{background:rgba(0,212,255,0.1);border-color:var(--accent);color:var(--accent);}
.layout-btn .icon{font-size:16px;}.layout-btn .lbl{font-size:9px;font-weight:600;letter-spacing:1px;text-transform:uppercase;}

/* Filter pills */
.pill-toggle{display:flex;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;overflow:hidden;}
.pill-opt{padding:4px 9px;font-size:10px;font-weight:600;letter-spacing:1px;cursor:pointer;transition:all 0.2s;color:var(--text-dim);text-transform:uppercase;font-family:'Barlow Condensed',sans-serif;}
.pill-opt.active{background:var(--accent);color:var(--bg-primary);}
.option-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.option-label{font-size:12px;color:var(--text-secondary);font-weight:500;}

/* Sport toggles */
.sport-toggle{display:flex;align-items:center;justify-content:space-between;padding:8px 11px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;margin-bottom:5px;cursor:pointer;transition:all 0.2s;}
.sport-toggle:hover{border-color:var(--border-bright);}
.sport-toggle.active{border-color:var(--accent);background:rgba(0,212,255,0.06);}
.sport-toggle.off-season{opacity:0.45;border-style:dashed;}
.sport-toggle.off-season:hover{opacity:0.75;}
.sport-info{display:flex;align-items:center;gap:8px;}
.sport-dot{width:7px;height:7px;border-radius:2px;}
.sport-name{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:1px;color:var(--text-primary);}
.sport-count{font-size:10px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;}
.sport-season-badge{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:2px 5px;border-radius:3px;border:1px solid;white-space:nowrap;}
.sport-season-badge.off{color:var(--text-dim);border-color:var(--text-dim);}
.sport-season-badge.pre{color:#ff9500;border-color:rgba(255,149,0,0.4);background:rgba(255,149,0,0.08);}
.sport-season-badge.post{color:#ff6b00;border-color:rgba(255,107,0,0.4);background:rgba(255,107,0,0.08);}
.toggle-switch{width:30px;height:17px;background:var(--bg-primary);border-radius:9px;border:1px solid var(--border);position:relative;transition:all 0.2s;flex-shrink:0;}
.sport-toggle.active .toggle-switch{background:var(--accent);border-color:var(--accent);}
.toggle-switch::after{content:'';position:absolute;width:11px;height:11px;background:var(--text-dim);border-radius:50%;top:2px;left:2px;transition:all 0.2s;}
.sport-toggle.active .toggle-switch::after{left:15px;background:white;}

/* Ended games */
.ended-master-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.ended-label{font-size:12px;color:var(--text-secondary);font-weight:500;}
.big-toggle{width:38px;height:21px;background:var(--bg-primary);border-radius:11px;border:1px solid var(--border);position:relative;cursor:pointer;transition:all 0.25s;flex-shrink:0;}
.big-toggle.on{background:var(--accent);border-color:var(--accent);}
.big-toggle::after{content:'';position:absolute;width:15px;height:15px;background:var(--text-dim);border-radius:50%;top:2px;left:2px;transition:all 0.25s;}
.big-toggle.on::after{left:19px;background:white;}
.small-toggle{width:26px;height:15px;background:var(--bg-primary);border-radius:8px;border:1px solid var(--border);position:relative;cursor:pointer;transition:all 0.2s;flex-shrink:0;}
.small-toggle.on{background:var(--accent);border-color:var(--accent);}
.small-toggle::after{content:'';position:absolute;width:9px;height:9px;background:var(--text-dim);border-radius:50%;top:2px;left:2px;transition:all 0.2s;}
.small-toggle.on::after{left:13px;background:white;}
.ended-leagues{margin-top:8px;border-top:1px solid var(--border);padding-top:8px;display:flex;flex-direction:column;gap:6px;}
.ended-league-row{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;overflow:hidden;}
.ended-league-row.active{border-color:rgba(0,212,255,0.3);}
.ended-league-header{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;cursor:pointer;}
.ended-league-name{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;color:var(--text-secondary);display:flex;align-items:center;gap:5px;}
.ended-league-row.active .ended-league-name{color:var(--text-primary);}
.ended-league-slider-wrap{padding:5px 10px 8px;border-top:1px solid var(--border);display:none;}
.ended-league-row.active .ended-league-slider-wrap{display:block;}
.league-days-row{display:flex;align-items:center;gap:8px;}
.league-days-label{font-size:10px;color:var(--text-dim);white-space:nowrap;font-family:'Barlow Condensed',sans-serif;}
.league-days-val{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--accent);min-width:20px;text-align:right;}
input[type=range]{flex:1;-webkit-appearance:none;height:4px;border-radius:2px;background:var(--border);outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 5px rgba(0,212,255,0.4);}
.ended-filter-row{display:flex;gap:3px;margin-top:6px;}
.ended-filter-pill{flex:1;padding:3px 3px;background:var(--bg-primary);border:1px solid var(--border);border-radius:5px;font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--text-dim);cursor:pointer;text-align:center;transition:all 0.15s;white-space:nowrap;}
.ended-filter-pill:hover{border-color:var(--border-bright);color:var(--text-secondary);}
.ended-filter-pill.active{background:rgba(0,212,255,0.12);border-color:var(--accent);color:var(--accent);}
.ended-filter-pill.active.fav{background:rgba(255,215,0,0.1);border-color:rgba(255,215,0,0.5);color:#ffd700;}

/* Favorites */
.fav-summary{display:flex;flex-wrap:wrap;gap:4px;min-height:18px;}
.fav-tag{display:flex;align-items:center;gap:4px;padding:2px 7px 2px 5px;background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.2);border-radius:20px;font-size:10px;color:#ffd700;font-family:'Barlow Condensed',sans-serif;font-weight:700;letter-spacing:0.5px;cursor:pointer;transition:all 0.2s;}
.fav-tag:hover{background:rgba(255,215,0,0.15);border-color:rgba(255,215,0,0.5);}
.fav-tag .remove-fav{font-size:9px;color:rgba(255,215,0,0.5);margin-left:1px;}
.fav-tag:hover .remove-fav{color:#ffd700;}
.no-favs-hint{font-size:11px;color:var(--text-dim);font-style:italic;line-height:1.5;}

/* Sidebar buttons */
.sidebar-btn{width:100%;padding:9px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px;margin-top:6px;}
.sidebar-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(0,212,255,0.06);}
.refresh-btn{width:100%;padding:10px;background:linear-gradient(135deg,rgba(0,212,255,0.15),rgba(0,102,255,0.15));border:1px solid var(--accent);border-radius:8px;color:var(--accent);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;}
.refresh-btn:hover{background:linear-gradient(135deg,rgba(0,212,255,0.25),rgba(0,102,255,0.25));box-shadow:0 0 20px rgba(0,212,255,0.2);}
.last-update{text-align:center;font-size:10px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;margin-top:6px;}
.sidebar-footer{margin-top:auto;padding:12px 18px;border-top:1px solid var(--border);font-size:10px;color:var(--text-dim);text-align:center;letter-spacing:1px;}

/* Scoreboard selector */
#sbSelectorSection{padding:12px 18px;border-bottom:1px solid var(--border);background:var(--bg-secondary);}
.sb-selector-label{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--text-dim);margin-bottom:8px;}
.sb-selector-pills{display:flex;flex-wrap:wrap;gap:5px;}
.sb-selector-pill{padding:4px 10px;font-size:10px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:all 0.2s;color:var(--text-dim);text-transform:uppercase;font-family:'Barlow Condensed',sans-serif;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;}
.sb-selector-pill:hover{border-color:var(--accent);color:var(--accent);}
.sb-selector-pill.active{background:rgba(0,212,255,0.12);border-color:var(--accent);color:var(--accent);}
.sb-selector-pill.all-sports{border-color:var(--border-bright);}
.sb-selector-pill.all-sports.active{background:rgba(0,255,136,0.1);border-color:var(--accent-green);color:var(--accent-green);}

/* Preview banner shown in topbar when viewing a custom scoreboard */
#previewBanner{display:none;font-size:11px;font-family:'Barlow Condensed',sans-serif;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent);background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.2);border-radius:4px;padding:2px 10px;margin-left:10px;}

/* Sidebar default sections wrapper ‚Äî hidden when custom scoreboard selected */
#sidebarDefaultSections{display:block;}

/* Dispatcharr status in sidebar */
.dispatcharr-status{display:flex;align-items:center;gap:6px;padding:5px 10px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;margin-top:6px;cursor:pointer;transition:all 0.2s;}
.dispatcharr-status:hover{border-color:var(--accent);}
.ds-dot{width:7px;height:7px;border-radius:50%;background:var(--text-dim);flex-shrink:0;}
.ds-dot.connected{background:var(--accent-green);box-shadow:0 0 6px rgba(0,255,136,0.5);}
.ds-dot.error{background:var(--accent-red);}
.ds-dot.configured{background:#f5a623;box-shadow:0 0 6px rgba(245,166,35,0.4);}
.profile-multiselect{position:relative;flex:1;min-width:0;}
.profile-ms-trigger{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--input-bg,#1a1a2e);border:1px solid var(--border,#333);border-radius:4px;cursor:pointer;font-size:13px;color:var(--text,#ccc);min-height:34px;user-select:none;}
.profile-ms-trigger:hover{border-color:var(--accent,#7c6af7);}
.profile-ms-dropdown{position:absolute;top:calc(100% + 2px);left:0;right:0;background:var(--modal-bg,#12122a);border:1px solid var(--border,#333);border-radius:4px;z-index:9999;max-height:220px;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.5);}
.profile-ms-item{display:flex;align-items:center;gap:8px;padding:6px 10px;cursor:pointer;font-size:13px;color:var(--text,#ccc);}
.profile-ms-item:hover{background:rgba(124,106,247,0.12);}
.profile-ms-item input[type=checkbox]{accent-color:var(--accent,#7c6af7);width:14px;height:14px;cursor:pointer;}
.profile-ms-all{font-weight:600;color:var(--accent,#7c6af7);}
.profile-ms-divider{height:1px;background:var(--border,#333);margin:2px 0;}
.grp-filter-btn{font-size:10px;padding:2px 8px;border-radius:10px;border:1px solid var(--border,#333);background:transparent;color:var(--text-dim);cursor:pointer;font-family:'Barlow Condensed',sans-serif;letter-spacing:0.5px;}
.grp-filter-btn:hover{border-color:var(--accent,#7c6af7);color:var(--accent,#7c6af7);}
.grp-filter-btn.active{background:var(--accent,#7c6af7);border-color:var(--accent,#7c6af7);color:#fff;}
.ds-label{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;color:var(--text-dim);}
.ds-label.connected{color:var(--accent-green);}
.ds-label.error{color:var(--accent-red);}

/* MAIN */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.topbar{padding:12px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--bg-secondary);}
.topbar-title{font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:20px;letter-spacing:2px;text-transform:uppercase;}
.topbar-meta{display:flex;align-items:center;gap:14px;}
/* Stream mode ‚Äî topbar elements scaled up for readability at 1920x1080 */
body.stream-mode .topbar{padding:14px 28px;}
body.stream-mode .topbar-title{font-size:26px;}
body.stream-mode .topbar-meta{font-size:15px;gap:20px;}
body.stream-mode .topbar-meta .val{font-size:15px;}
body.stream-mode #clockDisplay{font-size:15px;}

/* ‚îÄ‚îÄ Stream Canvas Layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
body.stream-mode #main{overflow:hidden;height:100vh;}
body.stream-mode #scoreboard{padding:0;overflow:hidden;flex:1;position:relative;display:flex;flex-direction:column;}
body.stream-mode .star-btn{display:none;}
body.stream-mode .game-card{cursor:default;animation:none;}
body.stream-mode .game-card:hover{transform:none;box-shadow:none;border-color:var(--border);}
body.stream-mode .game-card.live:hover{border-color:rgba(0,255,136,0.3);}

#stream-canvas{flex:1;overflow:hidden;position:relative;}
#stream-pages{width:100%;height:100%;position:relative;}
.stream-page{
  position:absolute;top:0;left:0;width:100%;height:100%;
  padding:10px 14px;box-sizing:border-box;
  overflow:hidden;
  opacity:0;transition:opacity 0.5s ease;
  pointer-events:none;
}
.stream-page.active{opacity:1;pointer-events:auto;}

#stream-pagination{
  display:flex;align-items:center;justify-content:center;
  gap:8px;padding:6px 0;min-height:26px;flex-shrink:0;
}
.stream-dot{
  width:7px;height:7px;border-radius:50%;
  background:rgba(255,255,255,0.2);
  transition:background 0.3s,transform 0.3s;
}
.stream-dot.active{background:rgba(255,255,255,0.8);transform:scale(1.35);}

/* Score update flash ‚Äî subtle highlight when value changes */
.score-updated{animation:scoreFlash 0.6s ease forwards;}
@keyframes scoreFlash{0%{color:var(--accent-green);}100%{color:inherit;}}
.meta-item{font-size:11px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;display:flex;align-items:center;gap:5px;}
.meta-item .val{color:var(--accent);}
#scoreboard{flex:1;overflow-y:auto;padding:18px 22px;}
#scoreboard::-webkit-scrollbar{width:4px;}
#scoreboard::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* LEAGUE / GAME CARDS */
.league-section{margin-bottom:26px;}
.league-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.league-stripe{width:4px;height:22px;border-radius:2px;}
.league-name{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:15px;letter-spacing:3px;text-transform:uppercase;color:var(--text-primary);}
.league-game-count{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);padding:2px 7px;background:var(--bg-card);border-radius:4px;border:1px solid var(--border);}
.league-season-badge{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:800;letter-spacing:2px;text-transform:uppercase;padding:2px 7px;border-radius:4px;border:1px solid;white-space:nowrap;}
.league-season-badge.pre{color:#ff9500;border-color:rgba(255,149,0,0.45);background:rgba(255,149,0,0.08);}
.league-season-badge.post{color:#ff6b00;border-color:rgba(255,107,0,0.45);background:rgba(255,107,0,0.1);animation:postGlow 2.5s ease-in-out infinite;}
.league-season-badge.off{color:var(--text-dim);border-color:var(--border);background:transparent;}
@keyframes postGlow{0%,100%{box-shadow:0 0 0 rgba(255,107,0,0);}50%{box-shadow:0 0 8px rgba(255,107,0,0.35);}}

.games-grid{display:grid;gap:9px;}
.games-grid.grid-mode{grid-template-columns:repeat(auto-fill,minmax(300px,1fr));}
.games-grid.fullscreen-mode,.games-grid.ticker-mode{grid-template-columns:1fr;}
.game-card{background:var(--bg-card);border:1px solid var(--border);border-radius:11px;overflow:hidden;transition:all 0.25s;animation:cardIn 0.4s ease forwards;}
.network-badges{display:flex;gap:3px;align-items:center;flex-shrink:0;}
.network-badge{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:800;letter-spacing:0.5px;padding:2px 6px;border-radius:4px;white-space:nowrap;text-transform:uppercase;line-height:1.4;}
.nb-espn{background:#cc0000;color:#fff;}
.nb-espn2{background:#990000;color:#fff;}
.nb-espnplus{background:#009ddc;color:#fff;}
.nb-abc{background:#1a1a1a;color:#fff;border:1px solid #555;}
.nb-nbc{background:#dd4f00;color:#fff;}
.nb-peacock{background:#00b3a4;color:#fff;}
.nb-cbs{background:#1a4a8a;color:#fff;}
.nb-fox{background:#e8a800;color:#000;}
.nb-fs1{background:#cc1a00;color:#fff;}
.nb-fs2{background:#aa1500;color:#fff;}
.nb-tnt{background:#1a3a7a;color:#fff;}
.nb-tbs{background:#0080b8;color:#fff;}
.nb-mlbtv{background:#002d72;color:#fff;}
.nb-nhltv{background:#00205b;color:#fff;}
.nb-nbatv{background:#17408b;color:#fff;}
.nb-nfln{background:#013369;color:#fff;}
.nb-default{background:rgba(255,255,255,0.12);color:#ccc;border:1px solid rgba(255,255,255,0.2);}
.nb-local{background:rgba(255,255,255,0.08);color:#aaa;border:1px solid rgba(255,255,255,0.15);}
.nb-rsn{background:rgba(255,255,255,0.08);color:#999;border:1px solid rgba(255,255,255,0.15);font-style:italic;}
@keyframes cardIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.game-card:hover{border-color:var(--border-bright);background:var(--bg-card-hover);transform:translateY(-1px);box-shadow:0 8px 30px rgba(0,0,0,0.4);}
.game-card.live{border-color:rgba(0,255,136,0.3);}
.game-card.favorited{border-color:rgba(255,215,0,0.35);background:linear-gradient(180deg,rgba(255,215,0,0.04) 0%,var(--bg-card) 60%);}
.game-card.is-final{opacity:0.82;}.game-card.is-final:hover{opacity:1;}
.card-status{padding:5px 13px;display:flex;align-items:center;justify-content:space-between;gap:6px;border-bottom:1px solid var(--border);background:rgba(0,0,0,0.2);}
.status-live{display:flex;align-items:center;gap:5px;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--accent-green);}
.status-live-dot{width:6px;height:6px;background:var(--accent-green);border-radius:50%;animation:pulse-green 1.5s infinite;}
@keyframes pulse-green{0%,100%{opacity:1;}50%{opacity:0.4;}}
.status-final{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--text-dim);}
.status-upcoming{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--accent);}
.game-period{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-secondary);}
.card-body{padding:12px 14px;}
.teams-container{display:flex;flex-direction:column;gap:9px;}
.team-row{display:flex;align-items:center;gap:10px;}
.team-logo-placeholder{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:10px;flex-shrink:0;text-align:center;line-height:1.1;}
.team-name-block{flex:1;min-width:0;}
.team-abbr{font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:var(--card-abbr-size,18px);letter-spacing:1px;text-transform:uppercase;color:var(--text-primary);line-height:1;}
.team-full-name{font-size:var(--card-name-size,11px);color:var(--card-name-color,var(--text-dim));white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.team-score{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:var(--card-score-size,34px);line-height:1;color:var(--text-primary);min-width:48px;text-align:right;}
.team-row.winning .team-score{color:white;}.team-row.losing .team-score{color:var(--text-secondary);}
.vs-line{height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:2px 0;}
.star-btn{background:none;border:none;cursor:pointer;font-size:14px;line-height:1;transition:transform 0.2s,filter 0.2s;padding:0 2px;filter:grayscale(1) opacity(0.35);}
.star-btn:hover{transform:scale(1.25);filter:grayscale(0) opacity(0.8);}
.star-btn.starred{filter:grayscale(0) opacity(1) drop-shadow(0 0 4px rgba(255,215,0,0.6));}
.stats-bar{margin-top:9px;padding-top:9px;border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(3,1fr);gap:5px;}
.stat-cell{text-align:center;}
.stat-val{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:15px;color:var(--text-primary);display:block;}
.stat-lbl{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;display:block;}
.fullscreen-mode .game-card{max-width:680px;margin:0 auto;}
.fullscreen-mode .team-score{font-size:calc(var(--card-score-size,34px) + 16px);}
.fullscreen-mode .team-abbr{font-size:calc(var(--card-abbr-size,18px) + 6px);}
.ticker-row{display:flex;align-items:center;padding:9px 14px;gap:12px;}
.ticker-teams{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:14px;color:var(--text-primary);flex:1;}
.ticker-score{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:17px;color:var(--accent);letter-spacing:2px;}
.ticker-period{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);min-width:60px;text-align:right;}
.pinned-section{margin-bottom:26px;}
.pinned-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,215,0,0.25);}
.pinned-stripe{width:4px;height:22px;border-radius:2px;background:linear-gradient(180deg,#ffd700,#ff9500);}
.pinned-title{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:15px;letter-spacing:3px;text-transform:uppercase;color:#ffd700;}
.pinned-count{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);padding:2px 7px;background:rgba(255,215,0,0.08);border-radius:4px;border:1px solid rgba(255,215,0,0.2);}
.loading-skeleton{background:linear-gradient(90deg,var(--bg-card) 25%,var(--bg-card-hover) 50%,var(--bg-card) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:11px;height:110px;margin-bottom:9px;}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-dim);}
.empty-icon{font-size:44px;margin-bottom:12px;}
.empty-text{font-family:'Barlow Condensed',sans-serif;font-size:15px;letter-spacing:2px;text-transform:uppercase;}

/* ==================== SETTINGS MODAL ==================== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(6px);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.2s ease;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.modal{background:var(--bg-secondary);border:1px solid var(--border-bright);border-radius:18px;width:700px;max-width:100%;max-height:88vh;display:flex;flex-direction:column;box-shadow:0 30px 100px rgba(0,0,0,0.8);animation:slideUp 0.25s ease;}
@keyframes slideUp{from{transform:translateY(24px);opacity:0;}to{transform:translateY(0);opacity:1;}}
.modal-header{padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.modal-title{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;letter-spacing:2px;text-transform:uppercase;}
.modal-close{background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:20px;padding:4px 8px;border-radius:6px;transition:all 0.15s;}
.modal-close:hover{color:var(--text-primary);background:var(--bg-card);}
.modal-tabs{display:flex;gap:3px;padding:12px 18px 0;border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;}
.modal-tabs::-webkit-scrollbar{display:none;}
.modal-tab{padding:8px 14px;background:none;border:none;border-bottom:2px solid transparent;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);cursor:pointer;transition:all 0.2s;white-space:nowrap;}
.modal-tab:hover{color:var(--text-secondary);}
.modal-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.modal-body{flex:1;overflow-y:auto;padding:20px 22px;}
.modal-body::-webkit-scrollbar{width:4px;}
.modal-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.modal-section{margin-bottom:24px;}
.modal-section-title{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--text-dim);margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.modal-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.modal-label{font-size:13px;color:var(--text-secondary);}
.modal-sublabel{font-size:11px;color:var(--text-dim);margin-top:2px;}
.modal-input{padding:7px 11px;background:var(--bg-card);border:1px solid var(--border);border-radius:7px;color:var(--text-primary);font-family:'Barlow',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;width:200px;}
.modal-input:focus{border-color:var(--accent);}
.modal-input::placeholder{color:var(--text-dim);}
.modal-input.full{width:100%;margin-top:6px;}
.modal-btn{padding:8px 18px;background:linear-gradient(135deg,rgba(0,212,255,0.15),rgba(0,102,255,0.15));border:1px solid var(--accent);border-radius:8px;color:var(--accent);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;}
.modal-btn:hover{background:rgba(0,212,255,0.25);}
.modal-btn.danger{border-color:var(--accent-red);color:var(--accent-red);background:rgba(255,59,92,0.08);}
.modal-btn.success{border-color:var(--accent-green);color:var(--accent-green);background:rgba(0,255,136,0.08);}
.modal-slider-row{display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:10px;margin-bottom:12px;}
.modal-slider-label{font-size:13px;color:var(--text-secondary);}
.modal-slider-val{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--accent);min-width:40px;text-align:right;}

/* Sport grid in settings */
.sport-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.sport-setting-row{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;transition:all 0.2s;}
.sport-setting-row.enabled{border-color:rgba(0,212,255,0.3);}
.sport-setting-info{display:flex;align-items:center;gap:8px;}
.sport-setting-name{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:0.5px;color:var(--text-primary);}

/* Refresh rate pills */
.rate-pills{display:flex;gap:5px;flex-wrap:wrap;}
.rate-pill{padding:5px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:20px;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;color:var(--text-dim);cursor:pointer;transition:all 0.15s;}
.rate-pill:hover{border-color:var(--border-bright);color:var(--text-secondary);}
.rate-pill.active{background:rgba(0,212,255,0.12);border-color:var(--accent);color:var(--accent);}

/* Color picker row */
.color-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.color-swatch{width:32px;height:32px;border-radius:6px;border:2px solid var(--border);cursor:pointer;overflow:hidden;flex-shrink:0;}
.color-swatch input[type=color]{width:100%;height:100%;border:none;padding:0;cursor:pointer;opacity:0;position:absolute;}
.color-swatch-wrap{position:relative;width:32px;height:32px;}

/* Dispatcharr status in modal */
.dispatcharr-test-result{margin-top:10px;padding:9px 13px;border-radius:8px;font-family:'Share Tech Mono',monospace;font-size:12px;display:none;}
.dispatcharr-test-result.ok{background:rgba(0,255,136,0.08);border:1px solid rgba(0,255,136,0.3);color:var(--accent-green);}
.dispatcharr-test-result.err{background:rgba(255,59,92,0.08);border:1px solid rgba(255,59,92,0.3);color:var(--accent-red);}
.channel-result{margin-top:10px;padding:9px 13px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;font-size:12px;color:var(--text-secondary);display:none;}

/* NCAA team search ‚Äî full names visible */
.tb-team-full{font-size:10px;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* ==================== SETTINGS FULL PAGE ==================== */
.settings-page{position:fixed;inset:0;z-index:300;display:flex;background:var(--bg-primary);animation:fadeIn 0.2s ease;}
.settings-sidebar{width:220px;flex-shrink:0;background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;}
.settings-sidebar-header{padding:22px 18px 16px;border-bottom:1px solid var(--border);}
.settings-logo{font-size:28px;margin-bottom:4px;}
.settings-title{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:22px;letter-spacing:3px;text-transform:uppercase;color:var(--text-primary);}
.settings-nav{flex:1;padding:12px 10px;display:flex;flex-direction:column;gap:3px;overflow-y:auto;}
.snav-btn{display:flex;align-items:center;gap:10px;padding:10px 12px;background:none;border:none;border-radius:8px;color:var(--text-dim);font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all 0.15s;text-align:left;width:100%;}
.snav-btn:hover{background:var(--bg-card);color:var(--text-secondary);}
.snav-btn.active{background:rgba(0,212,255,0.1);color:var(--accent);border:1px solid rgba(0,212,255,0.2);}
.snav-icon{font-size:16px;flex-shrink:0;}
.settings-sidebar-footer{padding:14px 10px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:8px;}
.snav-close{padding:9px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-dim);font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;}
.snav-close:hover{border-color:var(--border-bright);color:var(--text-primary);}
.settings-content{flex:1;overflow-y:auto;padding:32px 36px;}
.settings-content::-webkit-scrollbar{width:4px;}
.settings-content::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.settings-section{display:none;max-width:760px;}
.settings-section.active{display:block;}
.settings-section-header{margin-bottom:28px;}
.settings-section-header h2{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:28px;letter-spacing:3px;text-transform:uppercase;color:var(--text-primary);margin:0 0 6px;}
.settings-section-header p{font-size:13px;color:var(--text-dim);margin:0;}

/* Scoreboard cards */
.sb-cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-bottom:16px;}
.sb-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;transition:all 0.2s;position:relative;}
.sb-card:hover{border-color:var(--border-bright);}
.sb-card.is-default{border-color:rgba(0,212,255,0.3);}
.sb-card-name{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;letter-spacing:1px;color:var(--text-primary);margin-bottom:4px;}
.sb-card-meta{font-size:11px;color:var(--text-dim);margin-bottom:12px;line-height:1.6;}
.sb-card-status{display:inline-flex;align-items:center;gap:5px;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:0.5px;padding:3px 8px;border-radius:12px;margin-bottom:12px;}
.sb-card-status.live{background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);color:var(--accent-green);}
.sb-card-status.unpushed{background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-dim);}
.sb-card-actions{display:flex;gap:6px;flex-wrap:wrap;}
.sb-action-btn{padding:5px 12px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all 0.15s;}
.sb-action-btn:hover{border-color:var(--accent);color:var(--accent);}
.sb-action-btn.primary{border-color:var(--accent);color:var(--accent);background:rgba(0,212,255,0.08);}
.sb-action-btn.danger{border-color:var(--accent-red);color:var(--accent-red);}
.sb-action-btn.stream-url{border-color:rgba(0,255,136,0.4);color:var(--accent-green);}
.sb-action-btn.stream-url.copied{background:rgba(0,255,136,0.12);border-color:var(--accent-green);}

/* Scoreboard editor */
.sb-editor{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:20px;}
.sb-editor-header{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
.sb-editor-back{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:20px;padding:4px;border-radius:6px;transition:color 0.15s;}
.sb-editor-back:hover{color:var(--text-primary);}
.sb-editor-title{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;letter-spacing:2px;text-transform:uppercase;}
.sb-editor-steps{display:flex;gap:6px;margin-bottom:24px;overflow-x:auto;padding-bottom:4px;}
.sb-editor-step{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;white-space:nowrap;transition:all 0.15s;}
.sb-editor-step.active{background:rgba(0,212,255,0.12);border-color:var(--accent);color:var(--accent);}
.sb-editor-step.done{background:rgba(0,255,136,0.08);border-color:rgba(0,255,136,0.3);color:var(--accent-green);}

/* Push wizard */
.wizard-header{display:flex;align-items:center;gap:14px;margin-bottom:20px;}
.wizard-header h3{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;letter-spacing:2px;text-transform:uppercase;margin:0;}
.wizard-steps{display:flex;gap:0;margin-bottom:24px;border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.wizard-step{flex:1;padding:10px 6px;text-align:center;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--text-dim);background:var(--bg-secondary);border-right:1px solid var(--border);transition:all 0.2s;}
.wizard-step:last-child{border-right:none;}
.wizard-step.active{background:rgba(0,212,255,0.1);color:var(--accent);}
.wizard-step.done{background:rgba(0,255,136,0.06);color:var(--accent-green);}
.wizard-panel{display:none;}
.wizard-panel.active{display:block;}
.wizard-nav{display:flex;align-items:center;gap:10px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border);}
.wiz-field{margin-bottom:16px;}
.wiz-label{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);margin-bottom:6px;}
.wiz-input{width:100%;padding:9px 12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:'Barlow',sans-serif;font-size:13px;outline:none;box-sizing:border-box;transition:border-color 0.2s;}
.wiz-input:focus{border-color:var(--accent);}
.wiz-sublabel{font-size:11px;color:var(--text-dim);margin-top:4px;}
.wiz-review-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;}
.wiz-review-key{color:var(--text-dim);font-family:'Barlow Condensed',sans-serif;letter-spacing:1px;text-transform:uppercase;font-size:11px;}
.wiz-review-val{color:var(--text-primary);font-weight:600;}
.wiz-update-banner{padding:10px 14px;background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.25);border-radius:8px;font-size:12px;color:var(--accent);margin-bottom:16px;}
</style>
</head>
<body>
<div id="app">
<aside id="sidebar">
  <div class="sidebar-header">
    <div class="logo">
      <div class="logo-icon">&#x1F4E1;</div>
      <div class="logo-text">Score<span>Stream</span></div>
    </div>
    <div class="logo-sub">Pro Scoreboard</div>
    <div class="live-badge"><div class="live-dot"></div><span>Live Data</span></div>
  </div>

  <!-- Scoreboard selector ‚Äî populated on load from API -->
  <div id="sbSelectorSection">
    <div class="sb-selector-label">Scoreboard</div>
    <div class="sb-selector-pills" id="sbSelectorPills">
      <div class="sb-selector-pill all-sports active" data-slug="__all__" onclick="selectSidebarScoreboard('__all__')">&#x1F4CA; All Sports</div>
    </div>
  </div>

  <!-- Default sections: only shown when "All Sports" is selected -->
  <div id="sidebarDefaultSections">

  <div class="sidebar-section">
    <div class="section-label">Display Layout</div>
    <div class="layout-btns">
      <button class="layout-btn" data-layout="fullscreen"><div class="icon">&#x2B1B;</div><div class="lbl">Full</div></button>
      <button class="layout-btn active" data-layout="grid"><div class="icon">&#x229E;</div><div class="lbl">Grid</div></button>
      <button class="layout-btn" data-layout="ticker"><div class="icon">&#x25AC;</div><div class="lbl">Ticker</div></button>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="section-label">Filter</div>
    <div class="pill-toggle">
      <div class="pill-opt active" data-opt="filter" data-val="all">All</div>
      <div class="pill-opt" data-opt="filter" data-val="live">Live</div>
      <div class="pill-opt" data-opt="filter" data-val="favorites">&#x2B50; Mine</div>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="section-label">Active Sports</div>
    <div id="sport-toggles"></div>
  </div>

  <div class="sidebar-section" id="endedSection">
    <div class="section-label">Ended Games</div>
    <div class="ended-master-row">
      <span class="ended-label">&#x1F3C1; Show Final Games</span>
      <div class="big-toggle" id="endedMasterToggle" onclick="toggleEndedMaster()"></div>
    </div>
    <div id="endedControls" style="display:none">
      <div class="ended-leagues" id="endedLeagueToggles"></div>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="section-label">&#x2B50; My Favorites</div>
    <div class="fav-summary" id="favSummary">
      <div class="no-favs-hint">Star a team or league to pin it here</div>
    </div>
  </div>

  </div><!-- end #sidebarDefaultSections -->

  <div class="sidebar-section">
    <button class="refresh-btn" id="refreshBtn"><span>&#x21BB;</span> Refresh Scores</button>
    <div class="last-update" id="lastUpdate">Last updated: --</div>
    <button id="sidebarSaveBtn" onclick="manualSave()" style="display:none;width:100%;padding:9px;background:linear-gradient(135deg,rgba(255,107,0,0.2),rgba(255,59,92,0.15));border:1px solid var(--accent2);border-radius:8px;color:var(--accent2);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;margin-bottom:6px;">&#x1F4BE; Save Settings</button>
    <div class="dispatcharr-status" id="dsStatus" onclick="openSettings('dispatcharr')">
      <div class="ds-dot" id="dsDot"></div>
      <span class="ds-label" id="dsLabel">Dispatcharr: Not Configured</span>
    </div>
    <button class="sidebar-btn" onclick="openSettings('scoreboards')">&#x2699;&#xFE0F; Settings</button>
  </div>

  <div class="sidebar-footer">ScoreStream v0.0.1-beta &middot; ESPN Data</div>
</aside>

<div id="main">
  <div class="topbar">
    <div class="topbar-title" id="topbarTitle">All Sports Scoreboard</div>
    <div id="previewBanner"></div>
    <div class="topbar-meta">
      <div class="meta-item">Live: <span class="val" id="liveCount">&ndash;</span></div>
      <div class="meta-item">Total: <span class="val" id="totalCount">&ndash;</span></div>
    </div>
    <div class="meta-item" id="clockDisplay"></div>
  </div>
  <div id="scoreboard"></div>
</div>
</div>

<!-- SETTINGS MODAL -->
<!-- SETTINGS FULL PAGE PANEL -->
<div class="settings-page" id="settingsPage" style="display:none;">
  <div class="settings-sidebar">
    <div class="settings-sidebar-header">
      <div class="settings-logo">‚öôÔ∏è</div>
      <div class="settings-title">Settings</div>
    </div>
    <nav class="settings-nav">
      <button class="snav-btn active" data-section="scoreboards" onclick="switchSection('scoreboards')">
        <span class="snav-icon">üì∫</span><span>My Scoreboards</span>
      </button>
      <button class="snav-btn" data-section="display" onclick="switchSection('display')">
        <span class="snav-icon">üé®</span><span>Display &amp; Data</span>
      </button>
      <button class="snav-btn" data-section="dispatcharr" onclick="switchSection('dispatcharr')">
        <span class="snav-icon">üì°</span><span>Integrations</span>
      </button>

    </nav>
    <div class="settings-sidebar-footer">
      <span id="saveStatusBadge" style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:1px;transition:opacity 0.4s;opacity:0;"></span>
      <button id="modalSaveBtn" onclick="manualSave()" style="display:none;padding:5px 14px;background:linear-gradient(135deg,rgba(0,212,255,0.2),rgba(0,102,255,0.2));border:1px solid var(--accent);border-radius:6px;color:var(--accent);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:11px;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;">Save</button>
      <button class="snav-close" onclick="closeSettings()">‚úï Close</button>
    </div>
  </div>
  <div class="settings-content">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 1: MY SCOREBOARDS (default/active on open)
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="section-scoreboards" class="settings-section active">
      <div class="settings-section-header">
        <h2>My Scoreboards</h2>
        <p>Create and manage named scoreboards. Each can have its own sports, teams, and Dispatcharr channel assignment.</p>
      </div>
      <div id="sbListView">
        <div id="sbCards" class="sb-cards-grid"></div>
        <button class="modal-btn" onclick="createNewScoreboard()" style="margin-top:14px;padding:10px 24px;">+ New Scoreboard</button>
      </div>
      <!-- Push wizard (replaces list view) -->
      <div id="sbPushWizard" style="display:none;">
        <div class="wizard-header">
          <button onclick="closePushWizard()" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:22px;line-height:1;padding:0 8px 0 0;">‚Üê</button>
          <h3 id="wizardTitle">Push to Dispatcharr</h3>
        </div>
        <div class="wizard-steps">
          <div class="wizard-step active" data-step="1">1. Channel</div>
          <div class="wizard-step" data-step="2">2. Group</div>
          <div class="wizard-step" data-step="3">3. Profiles</div>
          <div class="wizard-step" data-step="4">4. Stream</div>
          <div class="wizard-step" data-step="5">5. Logo</div>
          <div class="wizard-step" data-step="6">6. Review</div>
        </div>
        <div id="wizardBody" style="min-height:200px;"></div>
        <div class="wizard-nav">
          <button class="modal-btn" id="wizPrevBtn" onclick="wizardNav(-1)" style="display:none;">‚Üê Back</button>
          <div style="flex:1;"></div>
          <button class="modal-btn" id="wizNextBtn" onclick="wizardNav(1)">Next ‚Üí</button>
          <button class="modal-btn" id="wizPushBtn" onclick="executeWizardPush()"
            style="display:none;background:linear-gradient(135deg,rgba(0,212,255,0.2),rgba(0,102,255,0.2));border-color:var(--accent);">
            üöÄ Push to Dispatcharr
          </button>
        </div>
        <div id="wizardResult" style="display:none;margin-top:14px;padding:12px 16px;border-radius:8px;border:1px solid var(--border);font-size:13px;"></div>
      </div>
    </div>

    <!-- SECTION 4: DISPLAY & DATA -->
    <div id="section-display" class="settings-section">
      <div class="settings-section-header">
        <h2>Display &amp; Data</h2>
        <p>Appearance, auto-save, refresh rate, and data source settings.</p>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Save Mode</div>
        <div class="modal-row">
          <div>
            <div class="modal-label">Auto-save settings</div>
            <div class="modal-sublabel">When off, a Save button appears so you can review changes before applying.</div>
          </div>
          <div class="big-toggle" id="autoSaveToggle" onclick="toggleAutoSave()"></div>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Auto-Refresh Rate</div>
        <div class="rate-pills" id="ratePills">
          <div class="rate-pill" data-rate="0" onclick="setRefreshRate(0)">Manual only</div>
          <div class="rate-pill" data-rate="30" onclick="setRefreshRate(30)">30 sec</div>
          <div class="rate-pill active" data-rate="60" onclick="setRefreshRate(60)">1 min</div>
          <div class="rate-pill" data-rate="120" onclick="setRefreshRate(120)">2 min</div>
          <div class="rate-pill" data-rate="300" onclick="setRefreshRate(300)">5 min</div>
        </div>
        <div style="margin-top:10px;font-size:11px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;" id="rateStatus">Auto-refresh: every 60 seconds</div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Card Typography</div>
        <div class="modal-slider-row">
          <span class="modal-slider-label">Team Abbreviation Size</span>
          <input type="range" min="14" max="28" value="18" id="sl-abbr" oninput="applyDisplay()">
          <span class="modal-slider-val" id="val-abbr">18px</span>
        </div>
        <div class="modal-slider-row">
          <span class="modal-slider-label">Score Size</span>
          <input type="range" min="24" max="52" value="34" id="sl-score" oninput="applyDisplay()">
          <span class="modal-slider-val" id="val-score">34px</span>
        </div>
        <div class="modal-slider-row">
          <span class="modal-slider-label">Team Name Size</span>
          <input type="range" min="9" max="16" value="11" id="sl-name" oninput="applyDisplay()">
          <span class="modal-slider-val" id="val-name">11px</span>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Team Name Color</div>
        <div class="modal-row">
          <div>
            <div class="modal-label">Name / Subtitle Color</div>
            <div class="modal-sublabel">The small text below the abbreviation</div>
          </div>
          <div class="color-row" style="margin:0;">
            <div class="color-swatch-wrap">
              <div class="color-swatch" id="nameColorSwatch" style="background:#3d5a78;"></div>
              <input type="color" id="nameColorPicker" value="#3d5a78" style="position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;" oninput="applyDisplay()">
            </div>
            <span style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-dim);" id="nameColorVal">#3d5a78</span>
          </div>
        </div>
        <div class="modal-row" style="margin-top:10px;">
          <span class="modal-label">Presets</span>
          <div style="display:flex;gap:5px;">
            <div onclick="setNameColor('#3d5a78')" style="width:24px;height:24px;border-radius:5px;background:#3d5a78;cursor:pointer;border:2px solid var(--border);" title="Default dim"></div>
            <div onclick="setNameColor('#7a9ab8')" style="width:24px;height:24px;border-radius:5px;background:#7a9ab8;cursor:pointer;border:2px solid var(--border);" title="Medium"></div>
            <div onclick="setNameColor('#b0c4de')" style="width:24px;height:24px;border-radius:5px;background:#b0c4de;cursor:pointer;border:2px solid var(--border);" title="Light blue"></div>
            <div onclick="setNameColor('#e8f0fe')" style="width:24px;height:24px;border-radius:5px;background:#e8f0fe;cursor:pointer;border:2px solid var(--border);" title="White"></div>
            <div onclick="setNameColor('#00d4ff')" style="width:24px;height:24px;border-radius:5px;background:#00d4ff;cursor:pointer;border:2px solid var(--border);" title="Accent cyan"></div>
          </div>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Stats</div>
        <div class="modal-row">
          <span class="modal-label">Stats Depth</span>
          <div class="pill-toggle">
            <div class="pill-opt active" data-opt="stats" data-val="basic">Basic</div>
            <div class="pill-opt" data-opt="stats" data-val="deep">Deep</div>
          </div>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Data Source</div>
        <div style="font-size:13px;color:var(--text-secondary);line-height:1.7;">
          ScoreStream uses the unofficial ESPN Scoreboard API. Data is fetched directly from your browser ‚Äî no proxy needed.<br><br>
          <span style="color:var(--text-dim);font-size:11px;">If scores show "demo" it means ESPN blocked the request from your network (CORS). This is normal inside some Docker/reverse proxy setups.</span>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 5: INTEGRATIONS
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- SECTION: INTEGRATIONS (Dispatcharr) -->
    <div id="section-dispatcharr" class="settings-section">
      <div class="settings-section-header">
        <h2>Integrations</h2>
        <p>Connect ScoreStream to Dispatcharr to push live scoreboards as TV channels.</p>
      </div>



      <!-- CREDENTIALS -->
      <div class="modal-section">
        <div class="modal-section-title">Dispatcharr Credentials</div>
        <div class="modal-sublabel" style="margin-bottom:10px;">Stored securely in the ScoreStream API container ‚Äî never in your browser.</div>
        <div class="modal-row" style="margin-bottom:6px;">
          <span class="modal-label">Dispatcharr URL</span>
          <input type="text" class="modal-input" id="dsUrl" placeholder="http://dispatcharr:9191" style="flex:1;min-width:0;">
        </div>
        <div class="modal-row" style="margin-bottom:6px;">
          <span class="modal-label">Username</span>
          <input type="text" class="modal-input" id="dsUser" placeholder="admin" style="flex:1;min-width:0;" autocomplete="username">
        </div>
        <div class="modal-row" style="margin-bottom:10px;">
          <span class="modal-label">Password</span>
          <input type="password" class="modal-input" id="dsPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="flex:1;min-width:0;" autocomplete="current-password">
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="modal-btn" onclick="saveCredentials()">Save Credentials</button>
          <button class="modal-btn" onclick="testConnection()">Test Connection</button>
        </div>
        <div class="dispatcharr-test-result" id="testResult" style="display:none;margin-top:8px;"></div>
      </div>

      <!-- CHANNEL GROUP & PROFILE -->
      <div class="modal-section">
        <div class="modal-section-title">Channel Defaults</div>

        <!-- CHANNEL GROUP -->
        <div class="modal-row" style="margin-bottom:4px;">
          <span class="modal-label" style="min-width:130px;">Channel Group</span>
          <div style="display:flex;gap:6px;flex:1;min-width:0;">
            <select class="modal-input" id="dGroupSelect" style="flex:1;min-width:0;">
              <option value="">‚Äî connect to load groups ‚Äî</option>
            </select>
            <button class="modal-btn" onclick="loadDsGroups()" title="Refresh groups" style="padding:4px 10px;font-size:16px;">‚Üª</button>
          </div>
        </div>
        <!-- Group source filter pills -->
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:4px;padding-left:136px;">
          <span style="font-size:11px;opacity:0.5;">Show:</span>
          <button class="grp-filter-btn active" data-filter="dispatcharr" onclick="setGroupFilter('dispatcharr')">Dispatcharr</button>
          <button class="grp-filter-btn" data-filter="m3u" onclick="setGroupFilter('m3u')">M3U</button>
          <button class="grp-filter-btn" data-filter="all" onclick="setGroupFilter('all')">Both</button>
        </div>
        <!-- New group inline creation -->
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:10px;padding-left:136px;">
          <input type="text" class="modal-input" id="dNewGroupName" placeholder="New group name..." style="flex:1;font-size:12px;padding:4px 8px;">
          <button class="modal-btn" onclick="createNewGroup()" style="font-size:12px;padding:4px 10px;white-space:nowrap;">+ Create Group</button>
        </div>
        <div id="newGroupResult" style="display:none;font-size:11px;padding-left:136px;margin-bottom:8px;"></div>

        <!-- CHANNEL PROFILE -->
        <div class="modal-row" style="margin-bottom:6px;">
          <span class="modal-label" style="min-width:130px;">Channel Profile</span>
          <div style="display:flex;gap:6px;flex:1;min-width:0;">
            <div class="profile-multiselect" id="dProfileMultiselect">
              <div class="profile-ms-trigger" id="dProfileTrigger" onclick="toggleProfileDropdown()">
                <span id="dProfileLabel">‚Äî connect to load profiles ‚Äî</span>
                <span style="margin-left:auto;opacity:0.5;">‚ñæ</span>
              </div>
              <div class="profile-ms-dropdown" id="dProfileDropdown" style="display:none;">
                <label class="profile-ms-item profile-ms-all">
                  <input type="checkbox" id="dProfileAll" onchange="onProfileAllChange(this)">
                  <span>All Profiles</span>
                </label>
                <div class="profile-ms-divider"></div>
                <div id="dProfileList"><!-- populated by loadDsProfiles --></div>
              </div>
            </div>
            <button class="modal-btn" onclick="loadDsProfiles()" title="Refresh profiles" style="padding:4px 10px;font-size:16px;">‚Üª</button>
          </div>
        </div>

        <!-- STREAM PROFILE -->
        <div class="modal-row" style="margin-bottom:4px;">
          <span class="modal-label" style="min-width:130px;">Stream Profile</span>
          <div style="display:flex;gap:6px;flex:1;min-width:0;">
            <select class="modal-input" id="dStreamProfileSelect" style="flex:1;min-width:0;">
              <option value="">‚Äî connect to load profiles ‚Äî</option>
            </select>
            <button class="modal-btn" onclick="loadStreamProfiles()" title="Refresh stream profiles" style="padding:4px 10px;font-size:16px;">‚Üª</button>
          </div>
        </div>
        <!-- Custom stream profile creation -->
        <div id="customStreamPanel" style="display:none;padding-left:136px;margin-bottom:6px;">
          <div style="font-size:11px;opacity:0.6;margin-bottom:4px;">Custom ffmpeg parameters:</div>
          <textarea class="modal-input" id="dCustomStreamParams" rows="3" style="width:100%;font-size:11px;font-family:monospace;resize:vertical;" placeholder="-re -fflags +genpts -user_agent {userAgent} -i {streamUrl} -c copy -f mpegts pipe:1"></textarea>
          <div style="display:flex;gap:6px;margin-top:4px;">
            <input type="text" class="modal-input" id="dCustomStreamName" placeholder="Profile name..." style="flex:1;font-size:12px;padding:4px 8px;">
            <button class="modal-btn" onclick="createStreamProfile()" style="font-size:12px;padding:4px 10px;white-space:nowrap;">+ Create Profile</button>
          </div>
          <div id="customStreamResult" style="font-size:11px;margin-top:4px;"></div>
        </div>
      </div>

      <!-- CHANNEL NUMBERING MODE -->
      <div class="modal-section">
        <div class="modal-section-title">Channel Numbering</div>
        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <button class="modal-btn active" id="numModeAuto" onclick="setNumMode('auto')" style="flex:1;">Auto Assign</button>
          <button class="modal-btn" id="numModeManual" onclick="setNumMode('manual')" style="flex:1;">Manual Assign</button>
        </div>

        <!-- Auto mode -->
        <div id="numAutoPanel">
          <div class="modal-row">
            <span class="modal-label">Starting Channel #</span>
            <input type="number" class="modal-input" id="dChannelStart" placeholder="900" value="900" style="width:100px;">
          </div>
        </div>

        <!-- Manual mode: per-sport channel # and group override -->
        <div id="numManualPanel" style="display:none;">
          <div class="modal-sublabel" style="margin-bottom:8px;">Assign a channel number and group for each enabled sport:</div>
          <div id="manualSportRows"></div>
        </div>
      </div>

      <!-- CREATE CHANNELS -->
      <div class="modal-section">
        <div class="modal-section-title">Create Channels in Dispatcharr</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div class="modal-row">
            <div>
              <div class="modal-label">Combined channel</div>
              <div class="modal-sublabel">One channel showing all sports</div>
            </div>
            <button class="modal-btn" onclick="createChannels('combined')">Create</button>
          </div>
          <div class="modal-row">
            <div>
              <div class="modal-label">Per-sport channels</div>
              <div class="modal-sublabel">Separate channel per active sport</div>
            </div>
            <button class="modal-btn" onclick="createChannels('per_sport')">Create</button>
          </div>
          <div class="modal-row">
            <div>
              <div class="modal-label">Both</div>
              <div class="modal-sublabel">Combined + individual sport channels</div>
            </div>
            <button class="modal-btn" onclick="createChannels('both')">Create All</button>
          </div>
        </div>
        <div class="channel-result" id="channelResult" style="display:none;"></div>
      </div>
    </div>
    </div><!-- /section-dispatcharr -->

    <!-- ‚îÄ‚îÄ NCAA Teams Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="section-ncaa" class="settings-section" style="display:none;">
      <div class="section-header">
        <div class="section-title">üè´ NCAA Teams</div>
        <div class="section-subtitle">Search, add, edit, or remove NCAA programs from your database. The ESPN sync populates most teams automatically.</div>
      </div>

      <!-- Sync status + trigger -->
      <div id="ncaaSyncBar" style="display:flex;align-items:center;gap:12px;margin-bottom:18px;padding:12px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;">
        <div style="flex:1;">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);margin-bottom:2px;">ESPN Sync</div>
          <div id="ncaaSyncStatus" style="font-size:13px;color:var(--text-secondary);">Checking...</div>
        </div>
        <button onclick="triggerNcaaSync()" id="ncaaSyncBtn" style="padding:7px 16px;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:7px;color:var(--accent);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;">‚Üª Sync Now</button>
      </div>

      <!-- Filters row -->
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:14px;flex-wrap:wrap;">
        <input id="ncaaSearchInput" type="text" placeholder="Search teams..." oninput="ncaaFilterTeams()"
          style="flex:1;min-width:160px;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:'Barlow Condensed',sans-serif;font-size:14px;outline:none;">
        <select id="ncaaSportFilter" onchange="ncaaFilterTeams()"
          style="padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);font-family:'Barlow Condensed',sans-serif;font-size:13px;cursor:pointer;">
          <option value="">All Sports</option>
          <option value="ncaafb">Football</option>
          <option value="ncaamb">Men's Basketball</option>
          <option value="ncaawb">Women's Basketball</option>
          <option value="ncaabase">Baseball</option>
          <option value="ncaasb">Softball</option>
        </select>
        <select id="ncaaDivFilter" onchange="ncaaFilterTeams()"
          style="padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);font-family:'Barlow Condensed',sans-serif;font-size:13px;cursor:pointer;">
          <option value="">All Divisions</option>
          <option value="d1">D1</option>
          <option value="d2">D2</option>
          <option value="d3">D3</option>
        </select>
        <button onclick="openNcaaAddModal()" style="padding:8px 16px;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:8px;color:var(--accent);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;white-space:nowrap;">+ Add Team</button>
      </div>

      <!-- Team count -->
      <div id="ncaaTeamCount" style="font-size:12px;color:var(--text-dim);margin-bottom:10px;font-family:'Barlow Condensed',sans-serif;letter-spacing:1px;"></div>

      <!-- Teams list -->
      <div id="ncaaTeamList" style="display:flex;flex-direction:column;gap:6px;max-height:480px;overflow-y:auto;"></div>
    </div><!-- /section-ncaa -->

    <!-- NCAA Add/Edit Modal -->
    <div id="ncaaModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
      <div style="background:var(--bg-panel);border:1px solid var(--border);border-radius:14px;padding:28px;width:480px;max-width:95vw;max-height:90vh;overflow-y:auto;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;letter-spacing:2px;text-transform:uppercase;color:var(--text-primary);margin-bottom:20px;" id="ncaaModalTitle">Add NCAA Team</div>
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div>
            <label style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);display:block;margin-bottom:5px;">School Name *</label>
            <input id="ncaaModalSchool" type="text" placeholder="e.g. University of Miami"
              style="width:100%;box-sizing:border-box;padding:9px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:'Barlow Condensed',sans-serif;font-size:14px;outline:none;">
          </div>
          <div>
            <label style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);display:block;margin-bottom:5px;">Abbreviation *</label>
            <input id="ncaaModalAbbr" type="text" placeholder="e.g. MIA" maxlength="8"
              style="width:100%;box-sizing:border-box;padding:9px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:'Barlow Condensed',sans-serif;font-size:14px;outline:none;">
          </div>
          <div>
            <label style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);display:block;margin-bottom:5px;">Nickname</label>
            <input id="ncaaModalNick" type="text" placeholder="e.g. Hurricanes"
              style="width:100%;box-sizing:border-box;padding:9px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:'Barlow Condensed',sans-serif;font-size:14px;outline:none;">
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);display:block;margin-bottom:5px;">Sport *</label>
              <select id="ncaaModalSport" style="width:100%;padding:9px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);font-family:'Barlow Condensed',sans-serif;font-size:13px;cursor:pointer;">
                <option value="ncaafb">Football</option>
                <option value="ncaamb">Men's Basketball</option>
                <option value="ncaawb">Women's Basketball</option>
                <option value="ncaabase">Baseball</option>
                <option value="ncaasb">Softball</option>
              </select>
            </div>
            <div>
              <label style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);display:block;margin-bottom:5px;">Division</label>
              <select id="ncaaModalDiv" style="width:100%;padding:9px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);font-family:'Barlow Condensed',sans-serif;font-size:13px;cursor:pointer;">
                <option value="d1">D1</option>
                <option value="d2">D2</option>
                <option value="d3">D3</option>
              </select>
            </div>
          </div>
          <div>
            <label style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);display:block;margin-bottom:5px;">Team Color</label>
            <input id="ncaaModalColor" type="color" value="#333333"
              style="width:60px;height:36px;padding:2px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;cursor:pointer;">
          </div>
        </div>
        <div id="ncaaModalError" style="display:none;color:var(--accent-red);font-size:12px;margin-top:10px;font-family:'Barlow Condensed',sans-serif;"></div>
        <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end;">
          <button onclick="closeNcaaModal()" style="padding:9px 20px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text-dim);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;">Cancel</button>
          <button onclick="saveNcaaModal()" id="ncaaModalSaveBtn" style="padding:9px 20px;background:rgba(0,212,255,0.15);border:1px solid rgba(0,212,255,0.4);border-radius:8px;color:var(--accent);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;">Save</button>
        </div>
      </div>
    </div>

  </div><!-- settings-content -->
</div><!-- settings-page -->

<!-- Legacy modal overlay removed - settings now uses full-page panel -->

<script>
// =====================
//  SAFE STORAGE
// =====================
const mem={};
const ss={
  get:k=>{try{return localStorage.getItem(k);}catch(e){return mem[k]||null;}},
  set:(k,v)=>{try{localStorage.setItem(k,v);}catch(e){mem[k]=v;}}
};

// =====================
//  SCOREBOARDS
// =====================
let _scoreboards=[];
let _activeSbId=null;  // scoreboard being edited or pushed
let _wizardStep=1;
let _wizardData={};    // accumulated wizard form data

async function loadScoreboards(){
  const grid=document.getElementById('sbCards');
  if(!grid)return;
  grid.innerHTML='<div style="color:var(--text-dim);font-size:13px;">Loading...</div>';
  try{
    const r=await fetch(`${API_BASE}/scoreboards`);
    const d=await r.json();
    _scoreboards=d.scoreboards||[];
    renderSbCards();
  }catch(e){grid.innerHTML='<div style="color:var(--accent-red);font-size:13px;">Failed to load scoreboards</div>';}
}

function renderSbCards(){
  const grid=document.getElementById('sbCards');
  if(!grid)return;
  if(!_scoreboards.length){grid.innerHTML='<p style="color:var(--text-dim)">No scoreboards yet.</p>';return;}
  grid.innerHTML=_scoreboards.map(sb=>{
    const sportCount=Object.values(sb.sport_config||{}).filter(v=>v).length;
    const hasChannel=!!sb.dispatcharr_channel_id;
    const chNum=sb.dispatcharr_channel_number?`Ch ${sb.dispatcharr_channel_number}`:'';
    return `<div class="sb-card${sb.is_default?' is-default':''}" id="sbcard-${sb.id}">
      ${sb.is_default?'<div style="position:absolute;top:10px;right:10px;font-size:9px;font-family:\'Share Tech Mono\',monospace;letter-spacing:1px;color:var(--text-dim);background:var(--bg-secondary);padding:2px 7px;border-radius:10px;border:1px solid var(--border);">DEFAULT</div>':''}
      <div class="sb-card-name">${sb.name}</div>
      <div class="sb-card-meta">${sportCount} sport${sportCount!==1?'s':''} enabled${sb.slug!==sb.name.toLowerCase()?` ¬∑ slug: ${sb.slug}`:''}
      </div>
      <div class="sb-card-status ${hasChannel?'live':'unpushed'}">
        ${hasChannel?'üü¢ Live'+( chNum?' ¬∑ '+chNum:''):'‚ö´ Not pushed to Dispatcharr'}
      </div>
      <div class="sb-card-actions">
        <button class="sb-action-btn primary" onclick="openSbEditor(${sb.id})">Edit</button>
        <button class="sb-action-btn" onclick="duplicateScoreboard(${sb.id})">Duplicate</button>
        <button class="sb-action-btn stream-url" id="urlbtn-${sb.id}" onclick="copyStreamUrl('${sb.slug}',${sb.id})">üì° Stream URL</button>
        <button class="sb-action-btn primary" onclick="openPushWizard(${sb.id})">${hasChannel?'‚ü≥ Update Channel':'üöÄ Push to Dispatcharr'}</button>
        ${!sb.is_default?`<button class="sb-action-btn danger" onclick="deleteScoreboard(${sb.id})">Delete</button>`:''}
      </div>
    </div>`;
  }).join('');
}

async function copyStreamUrl(slug, id){
  // Build URL from current window location so it works on any host/port
  const base = window.location.protocol + '//' + window.location.host;
  const url = `${base}/hls/${slug}.m3u8`;
  try {
    await navigator.clipboard.writeText(url);
  } catch(e) {
    // Fallback for non-HTTPS contexts
    const ta = document.createElement('textarea');
    ta.value = url; ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  }
  const btn = document.getElementById(`urlbtn-${id}`);
  if(btn){ btn.textContent = '‚úÖ Copied!'; btn.classList.add('copied');
    setTimeout(()=>{ btn.textContent = 'üì° Stream URL'; btn.classList.remove('copied'); }, 2000); }
}

async function createNewScoreboard(){
  const name=prompt('Scoreboard name:','My Scoreboard');
  if(!name?.trim())return;
  const r=await fetch(`${API_BASE}/scoreboards`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name.trim()})});
  if(r.ok){const d=await r.json();_scoreboards.push(d);renderSbCards();initSidebarScoreboardSelector();openSbEditor(d.id);}
  else alert('Failed to create scoreboard');
}

async function duplicateScoreboard(id){
  const src=_scoreboards.find(s=>s.id===id);
  const name=prompt('New scoreboard name:',src?.name+' (Copy)');
  if(!name?.trim())return;
  const r=await fetch(`${API_BASE}/scoreboards/${id}/duplicate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name.trim()})});
  if(r.ok){const d=await r.json();_scoreboards.push(d);renderSbCards();initSidebarScoreboardSelector();}
  else alert('Failed to duplicate scoreboard');
}

async function deleteScoreboard(id){
  const sb=_scoreboards.find(s=>s.id===id);
  const hasChannel=sb&&sb.dispatcharr_channel_id;
  const msg=hasChannel
    ?`Delete "${sb.name}"? This will also remove its Dispatcharr channel and stream. This cannot be undone.`
    :`Delete "${sb?.name||'this scoreboard'}"? This cannot be undone.`;
  if(!confirm(msg))return;
  const r=await fetch(`${API_BASE}/scoreboards/${id}`,{method:'DELETE'});
  if(r.ok){_scoreboards=_scoreboards.filter(s=>s.id!==id);renderSbCards();initSidebarScoreboardSelector();}
  else alert('Failed to delete scoreboard');
}

// ‚îÄ‚îÄ Scoreboard Editor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ Scoreboard Editor (guided multi-step flow) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _editorStep = 1; // 1=Identity, 2=Sports, 3=Teams
let _editorDraft = {}; // accumulated changes before saving

function openSbEditor(id){
  const sb=_scoreboards.find(s=>s.id===id);
  if(!sb)return;
  _activeSbId=id;
  _editorStep=1;
  // Start draft from saved values
  _editorDraft={
    name: sb.name,
    sport_config: Object.assign({}, sb.sport_config||{}),
    team_config: (sb.team_config && !Array.isArray(sb.team_config)) ? JSON.parse(JSON.stringify(sb.team_config)) : {},
    display_config: Object.assign({}, sb.display_config||{})
  };

  // Hide list and push wizard
  document.getElementById('sbListView').style.display='none';
  document.getElementById('sbPushWizard').style.display='none';

  // Lock sidebar nav to prevent navigating away mid-edit
  document.querySelectorAll('.snav-btn').forEach(b=>{
    if(b.dataset.section!=='scoreboards') b.style.opacity='0.3';
    b.style.pointerEvents='none';
  });

  // Create or reuse editor panel
  let el=document.getElementById('sbEditorPanel');
  if(!el){
    el=document.createElement('div');
    el.id='sbEditorPanel';
    document.getElementById('section-scoreboards').insertBefore(el, document.getElementById('sbListView'));
  }
  el.style.display='block';
  renderEditorStep(sb);
}

function renderEditorStep(sbOverride){
  const sb=sbOverride||_scoreboards.find(s=>s.id===_activeSbId);
  if(!sb)return;
  const el=document.getElementById('sbEditorPanel');
  if(!el)return;

  const steps=['Identity','Sports & Leagues','Teams'];
  const stepNav=steps.map((s,i)=>`
    <div class="sb-editor-step${_editorStep===i+1?' active':_editorStep>i+1?' done':''}"
         onclick="jumpEditorStep(${i+1})">${i+1}. ${s}</div>`).join('');

  let body='';
  if(_editorStep===1){
    const tzOptions=['America/New_York','America/Chicago','America/Denver','America/Los_Angeles','America/Phoenix','America/Anchorage','Pacific/Honolulu','Europe/London','Europe/Paris','Europe/Berlin','Asia/Tokyo','Asia/Shanghai','Australia/Sydney'];
    const currentTz=_editorDraft.display_config.timezone||'America/New_York';
    body=`
      <div class="wiz-field">
        <div class="wiz-label">Scoreboard Name</div>
        <input class="wiz-input" id="sbEditName" value="${_editorDraft.name}" placeholder="e.g. Weekend Sports, NBA Only, My NFL Board">
        <div class="wiz-sublabel">This name also becomes the channel name when pushed to Dispatcharr</div>
      </div>
      <div class="wiz-field" style="margin-top:16px;">
        <div class="wiz-label">Description (optional)</div>
        <input class="wiz-input" id="sbEditDesc" value="${sb.description||''}" placeholder="What this scoreboard is for...">
      </div>
      <div class="wiz-field" style="margin-top:16px;">
        <div class="wiz-label">Timezone</div>
        <select class="wiz-input" id="sbEditTz">
          ${tzOptions.map(tz=>`<option value="${tz}"${tz===currentTz?' selected':''}>${tz.replace('_',' ')}</option>`).join('')}
        </select>
        <div class="wiz-sublabel">Clock displayed on the stream output uses this timezone</div>
      </div>
      <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border);">
        <div class="modal-section-title" style="margin-bottom:4px;">üì∫ Stream Output</div>
        <div class="wiz-sublabel" style="margin-bottom:14px;">Per-scoreboard stream display settings.</div>
        <div style="margin-bottom:12px;">
          <div class="wiz-label">Output Resolution</div>
          <select class="wiz-input" id="sbEditResolution" style="max-width:220px;">
            <option value="1920x1080" ${(_editorDraft.display_config.stream_resolution||'1920x1080')==='1920x1080'?'selected':''}>1920 √ó 1080 (1080p)</option>
            <option value="1280x720"  ${(_editorDraft.display_config.stream_resolution||'')==='1280x720'?'selected':''}>1280 √ó 720 (720p)</option>
            <option value="1280x1080" ${(_editorDraft.display_config.stream_resolution||'')==='1280x1080'?'selected':''}>1280 √ó 1080 (4:3 HD)</option>
            <option value="3840x2160" ${(_editorDraft.display_config.stream_resolution||'')==='3840x2160'?'selected':''}>3840 √ó 2160 (4K)</option>
          </select>
          <div class="wiz-sublabel">Stored for reference. To change output resolution, update <code style="font-family:monospace;font-size:10px;color:var(--accent);">STREAM_WIDTH</code> / <code style="font-family:monospace;font-size:10px;color:var(--accent);">STREAM_HEIGHT</code> in your Docker stack env vars and restart the stream container.</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <div class="wiz-label">Card Scale</div>
            <div style="display:flex;align-items:center;gap:8px;">
              <input type="number" class="wiz-input" id="sbEditCardScale"
                min="50" max="300" step="5"
                value="${Math.round((parseFloat(_editorDraft.display_config.stream_card_scale)||1.0)*100)}"
                oninput="sbPreviewCardScale(this.value/100)"
                style="width:80px;text-align:center;">
              <span style="color:var(--text-dim);font-size:12px;">%</span>
            </div>
            <div class="wiz-sublabel">Game card size on stream (50‚Äì300%)</div>
          </div>
          <div>
            <div class="wiz-label">Page Rotation</div>
            <select class="wiz-input" id="sbEditRotation">
              <option value="15" ${String(_editorDraft.display_config.stream_rotation_secs||'')==='15'?'selected':''}>15 seconds</option>
              <option value="20" ${String(_editorDraft.display_config.stream_rotation_secs||'')==='20'?'selected':''}>20 seconds</option>
              <option value="30" ${String(_editorDraft.display_config.stream_rotation_secs||'30')==='30'?'selected':''}>30 seconds</option>
              <option value="45" ${String(_editorDraft.display_config.stream_rotation_secs||'')==='45'?'selected':''}>45 seconds</option>
              <option value="60" ${String(_editorDraft.display_config.stream_rotation_secs||'')==='60'?'selected':''}>60 seconds</option>
              <option value="0"  ${String(_editorDraft.display_config.stream_rotation_secs||'')==='0'?'selected':''}>No rotation</option>
            </select>
            <div class="wiz-sublabel">How long each page shows before rotating</div>
          </div>
        </div>

        <div style="margin-top:16px;">
          <div class="wiz-label" style="margin-bottom:8px;">Card Scale Preview <span style="color:var(--text-dim);font-weight:400;font-size:10px;">(live)</span></div>
          <div style="background:#0a0e1a;border:1px solid var(--border);border-radius:10px;padding:14px 14px 10px;overflow:hidden;">
            <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;margin-bottom:10px;opacity:0.5;">STREAM OUTPUT ¬∑ 1920√ó1080</div>
            <div id="sbCardScaleWrap" style="overflow:hidden;">
              <div id="sbCardScaleInner" style="display:grid;grid-template-columns:1fr 1fr;gap:9px;transform-origin:top left;transition:transform 0.2s ease;">
                <div class="game-card live" style="pointer-events:none;">
                  <div class="card-status">
                    <div class="status-live"><div class="status-live-dot"></div>3rd ¬∑ 7:42</div>
                    <span style="font-size:9px;font-family:'Share Tech Mono',monospace;color:rgba(255,100,50,0.9);letter-spacing:0.5px;">ESPN</span>
                    <span class="game-period" style="color:#e05555;">üèí NHL</span>
                  </div>
                  <div class="card-body">
                    <div class="teams-container">
                      <div class="team-row">
                        <div style="width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,#003087,#00539b);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:9px;color:white;">TOR</div>
                        <div class="team-name-block"><div class="team-abbr">TOR</div><div class="team-full-name">Toronto Maple Leafs ¬∑ Away</div></div>
                        <div class="team-score">2</div>
                      </div>
                      <div style="height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:2px 0;"></div>
                      <div class="team-row winning">
                        <div style="width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,#c8102e,#a00d24);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:9px;color:white;">DET</div>
                        <div class="team-name-block"><div class="team-abbr">DET</div><div class="team-full-name">Detroit Red Wings ¬∑ Home</div></div>
                        <div class="team-score" style="color:white;">4</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="game-card" style="pointer-events:none;">
                  <div class="card-status">
                    <span class="status-upcoming">7:30 PM</span>
                    <span style="font-size:9px;font-family:'Share Tech Mono',monospace;color:rgba(255,180,0,0.9);letter-spacing:0.5px;">TNT</span>
                    <span class="game-period" style="color:#c9a227;">üèÄ NBA</span>
                  </div>
                  <div class="card-body">
                    <div class="teams-container">
                      <div class="team-row">
                        <div style="width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,#006bb6,#004f8a);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:9px;color:white;">NYK</div>
                        <div class="team-name-block"><div class="team-abbr">NYK</div><div class="team-full-name">New York Knicks ¬∑ Away</div></div>
                        <div class="team-score">‚Äì</div>
                      </div>
                      <div style="height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:2px 0;"></div>
                      <div class="team-row">
                        <div style="width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,#ce1141,#a00d32);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:9px;color:white;">MIA</div>
                        <div class="team-name-block"><div class="team-abbr">MIA</div><div class="team-full-name">Miami Heat ¬∑ Home</div></div>
                        <div class="team-score">‚Äì</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>`;
  // Init preview to current scale after render
  setTimeout(()=>{
    const sel=document.getElementById('sbEditCardScale');
    if(sel) sbPreviewCardScale(parseFloat(sel.value)/100);
  },0);
  }
  else if(_editorStep===2){
    const groups=[
      {key:'pro',   label:'Pro Leagues',   sports: ALL_SPORTS.filter(s=>s.group==='pro')},
      {key:'ncaam', label:"NCAA Men's",    sports: ALL_SPORTS.filter(s=>s.group==='ncaam')},
      {key:'ncaaw', label:"NCAA Women's",  sports: ALL_SPORTS.filter(s=>s.group==='ncaaw')},
    ];
    body=`<div class="wiz-sublabel" style="margin-bottom:16px;">Choose which sports appear on this scoreboard. Each scoreboard has its own independent selection.</div>`;
    groups.forEach(g=>{
      if(!g.sports.length)return;
      const allOn=g.sports.every(sp=>!!_editorDraft.sport_config[sp.id]);
      body+=`
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <div class="modal-section-title" style="margin-bottom:0;">${g.label}</div>
          <button onclick="sbEditorToggleGroup('${g.key}')"
            id="sbGroupBtn_${g.key}"
            style="padding:3px 12px;border-radius:12px;border:1px solid ${allOn?'var(--accent)':'var(--border)'};
              background:${allOn?'rgba(0,212,255,0.12)':'transparent'};
              color:${allOn?'var(--accent)':'var(--text-dim)'};
              font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;
              letter-spacing:0.5px;text-transform:uppercase;"
            data-all="${allOn?'1':'0'}">
            ${allOn?'‚úì All Selected':'Select All'}
          </button>
        </div>
        <div class="sport-grid" data-group="${g.key}" style="margin-bottom:18px;">`;
      g.sports.forEach(sp=>{
        const on=!!_editorDraft.sport_config[sp.id];
        body+=`<label class="sport-setting-row${on?' enabled':''}" style="cursor:pointer;">
          <div class="sport-setting-info">
            <span>${sp.emoji||'üèÜ'}</span>
            <span class="sport-setting-name">${sp.name}</span>
          </div>
          <input type="checkbox" data-sport="${sp.id}" ${on?'checked':''}
            onchange="this.closest('.sport-setting-row').classList.toggle('enabled',this.checked);sbEditorUpdateGroupBtn('${g.key}')"
            style="cursor:pointer;">
        </label>`;
      });
      body+='</div>';
    });

    // ‚îÄ‚îÄ Final Games section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const enabledForFinals = ALL_SPORTS.filter(sp => !!_editorDraft.sport_config[sp.id]);
    if (enabledForFinals.length) {
      const finals = _editorDraft.display_config.finals || {};
      body += `<div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border);">
        <div class="modal-section-title" style="margin-bottom:4px;">üìã Final Games</div>
        <div class="wiz-sublabel" style="margin-bottom:14px;">Show completed games for each sport. Only enabled sports are listed.</div>
        <div style="display:flex;flex-direction:column;gap:8px;">`;
      enabledForFinals.forEach(sp => {
        const cfg = finals[sp.id] || { show: false, days: 1 };
        body += `<div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:var(--bg-card);border-radius:8px;border:1px solid var(--border);">
            <span style="font-size:15px;">${sp.emoji}</span>
            <span style="flex:1;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--text-primary);">${sp.name}</span>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
              <span style="font-size:11px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;">Show Finals</span>
              <input type="checkbox" data-finals-sport="${sp.id}" ${cfg.show ? 'checked' : ''}
                onchange="sbEditorToggleFinals('${sp.id}', this.checked)"
                style="cursor:pointer;accent-color:var(--accent);width:15px;height:15px;">
            </label>
            <label style="display:flex;align-items:center;gap:6px;" id="sbFinalsDaysLabel_${sp.id}">
              <span style="font-size:11px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;">Days Back</span>
              <select data-finals-days="${sp.id}"
                style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:'Share Tech Mono',monospace;font-size:11px;padding:3px 6px;cursor:pointer;"
                onchange="sbEditorSetFinalsDays('${sp.id}', this.value)">
                ${[1,2,3,5,7].map(d => `<option value="${d}" ${cfg.days == d ? 'selected' : ''}>${d} day${d>1?'s':''}</option>`).join('')}
              </select>
            </label>
          </div>`;
      });
      body += `</div></div>`;
    }
  }
  else if(_editorStep===3){
    const enabledSportIds=Object.entries(_editorDraft.sport_config).filter(([,v])=>v).map(([k])=>k);
    if(!enabledSportIds.length){
      body=`<div style="color:var(--text-dim);font-size:13px;padding:20px 0;">
        No sports enabled on this scoreboard yet.<br>Go back to <strong>Sports &amp; Leagues</strong> and enable at least one sport first.
      </div>`;
    } else {
      // Build sport tabs from enabled sports only
      const enabledSports=ALL_SPORTS.filter(s=>enabledSportIds.includes(s.id));
      const firstSport=enabledSports[0]?.id||'';
      const tabHtml=enabledSports.map(sp=>`
        <div class="sb-team-tab${sp.id===firstSport?' active':''}"
          data-sport="${sp.id}"
          onclick="sbEditorSwitchTeamTab('${sp.id}')"
          style="padding:5px 12px;border-radius:20px;border:1px solid ${sp.id===firstSport?'var(--accent)':'var(--border)'};
            background:${sp.id===firstSport?'rgba(0,212,255,0.1)':'transparent'};
            color:${sp.id===firstSport?'var(--accent)':'var(--text-dim)'};
            font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;
            letter-spacing:0.5px;cursor:pointer;white-space:nowrap;text-transform:uppercase;">
          ${sp.emoji} ${sp.name}
        </div>`).join('');

      body=`
        <div class="wiz-sublabel" style="margin-bottom:12px;">
          Check a team to include it on this scoreboard (highlight badge on their games). Star ‚≠ê a team to mark it as a favorite (pinned to top, drives the Mine filter).
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <div style="display:flex;gap:5px;flex-wrap:wrap;overflow-x:auto;padding-bottom:4px;flex:1;" id="sbTeamTabs">
            ${tabHtml}
          </div>
          <button id="sbSelectAllBtn" onclick="sbEditorSelectAllTeams()"
            style="flex-shrink:0;padding:4px 12px;border-radius:20px;border:1px solid var(--border);
              background:transparent;color:var(--text-dim);font-family:'Share Tech Mono',monospace;
              font-size:10px;cursor:pointer;letter-spacing:0.5px;text-transform:uppercase;white-space:nowrap;">
            Select All
          </button>
        </div>
        <div style="position:relative;margin-bottom:10px;">
          <span style="position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:13px;">üîç</span>
          <input type="text" id="sbTeamSearch" placeholder="Search teams..."
            style="width:100%;padding:8px 12px 8px 32px;background:var(--bg-card);border:1px solid var(--border);
              border-radius:8px;color:var(--text-primary);font-family:'Barlow',sans-serif;font-size:13px;
              outline:none;box-sizing:border-box;"
            oninput="sbEditorFilterTeams(this.value)">
        </div>
        <div id="sbTeamDivPills" style="display:none;gap:5px;margin-bottom:10px;flex-wrap:wrap;">
          <button onclick="sbEditorSetDiv('d1')" id="sbDivD1" style="padding:3px 10px;border-radius:20px;border:1px solid var(--accent);background:rgba(0,212,255,0.12);color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;">D-I</button>
          <button onclick="sbEditorSetDiv('d2')" id="sbDivD2" style="padding:3px 10px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;">D-II</button>
          <button onclick="sbEditorSetDiv('d3')" id="sbDivD3" style="padding:3px 10px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;">D-III</button>
          <button onclick="sbEditorSetDiv('all')" id="sbDivAll" style="padding:3px 10px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;">ALL</button>
        </div>
        <div id="sbTeamList" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;max-height:340px;overflow-y:auto;"></div>
        <div style="margin-top:10px;font-size:11px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;" id="sbTeamCount">
          ‚úì ${Object.values(_editorDraft.team_config||{}).flat().length} team${Object.values(_editorDraft.team_config||{}).flat().length!==1?'s':''} selected for this scoreboard
        </div>`;
    }
  }

  el.innerHTML=`
    <div class="sb-editor">
      <div class="sb-editor-header">
        <button class="sb-editor-back" onclick="closeSbEditor()" title="Cancel editing">‚Üê Cancel</button>
        <div class="sb-editor-title">‚úèÔ∏è ${sb.name}</div>
        <button class="modal-btn" onclick="saveSbEditor()" style="margin-left:auto;padding:6px 16px;font-size:11px;">üíæ Save</button>
      </div>
      <div class="sb-editor-steps">${stepNav}</div>
      <div id="sbEditorBody" style="min-height:180px;">${body}</div>
      <div style="display:flex;gap:10px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
        ${_editorStep>1?'<button class="modal-btn" style="border-color:var(--border);color:var(--text-dim);" onclick="editorNav(-1)">‚Üê Back</button>':''}
        <div style="flex:1;"></div>
        ${_editorStep<3?'<button class="modal-btn" onclick="editorNav(1)">Next ‚Üí</button>':''}
        <button class="modal-btn" onclick="saveSbEditor()" style="background:linear-gradient(135deg,rgba(0,212,255,0.2),rgba(0,102,255,0.2));border-color:var(--accent);">
          ${_editorStep===3?'‚úÖ Save & Close':'üíæ Save'}
        </button>
      </div>
      <div id="sbEditResult" style="margin-top:10px;font-size:12px;min-height:20px;"></div>
    </div>`;

  // Auto-load team browser when on step 3
  if(_editorStep===3){
    const enabledSportIds=Object.entries(_editorDraft.sport_config).filter(([,v])=>v).map(([k])=>k);
    if(enabledSportIds.length){
      _sbTeamActiveSport = enabledSportIds[0];
      _sbTeamDivFilter = 'd1';
      setTimeout(()=>sbEditorLoadTeams(_sbTeamActiveSport), 50);
    }
  }
}

function jumpEditorStep(n){
  collectEditorStepData();
  _editorStep=n;
  renderEditorStep();
}

function editorNav(dir){
  collectEditorStepData();
  _editorStep=Math.max(1,Math.min(3,_editorStep+dir));
  renderEditorStep();
}

function collectEditorStepData(){
  if(_editorStep===1){
    const nameEl=document.getElementById('sbEditName');
    if(nameEl) _editorDraft.name=nameEl.value.trim()||_editorDraft.name;
    const tzEl=document.getElementById('sbEditTz');
    if(tzEl) _editorDraft.display_config.timezone=tzEl.value;
    const scaleEl=document.getElementById('sbEditCardScale');
    if(scaleEl) _editorDraft.display_config.stream_card_scale=parseFloat(scaleEl.value)/100;
    const resEl=document.getElementById('sbEditResolution');
    if(resEl) _editorDraft.display_config.stream_resolution=resEl.value;
    const rotEl=document.getElementById('sbEditRotation');
    if(rotEl) _editorDraft.display_config.stream_rotation_secs=parseInt(rotEl.value);
  }
  if(_editorStep===2){
    document.querySelectorAll('#sbEditorBody input[data-sport]').forEach(cb=>{
      _editorDraft.sport_config[cb.dataset.sport]=cb.checked;
    });
    // Collect finals config
    if (!_editorDraft.display_config.finals) _editorDraft.display_config.finals = {};
    document.querySelectorAll('#sbEditorBody input[data-finals-sport]').forEach(cb=>{
      const sid = cb.dataset.finalsSport;
      if (!_editorDraft.display_config.finals[sid]) _editorDraft.display_config.finals[sid] = { show: false, days: 1 };
      _editorDraft.display_config.finals[sid].show = cb.checked;
    });
    document.querySelectorAll('#sbEditorBody select[data-finals-days]').forEach(sel=>{
      const sid = sel.dataset.finalsDays;
      if (!_editorDraft.display_config.finals[sid]) _editorDraft.display_config.finals[sid] = { show: false, days: 1 };
      _editorDraft.display_config.finals[sid].days = parseInt(sel.value);
    });
  }
  // Step 3 team_config is updated live via sbEditorToggleTeam, no collection needed
}

// ‚îÄ‚îÄ Finals editor helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sbEditorToggleFinals(sportId, checked) {
  if (!_editorDraft.display_config.finals) _editorDraft.display_config.finals = {};
  if (!_editorDraft.display_config.finals[sportId]) _editorDraft.display_config.finals[sportId] = { show: false, days: 1 };
  _editorDraft.display_config.finals[sportId].show = checked;
  // Dim/enable days selector
  const label = document.getElementById(`sbFinalsDaysLabel_${sportId}`);
  if (label) { label.style.opacity = checked ? '1' : '0.4'; label.style.pointerEvents = checked ? '' : 'none'; }
}

function sbEditorSetFinalsDays(sportId, days) {
  if (!_editorDraft.display_config.finals) _editorDraft.display_config.finals = {};
  if (!_editorDraft.display_config.finals[sportId]) _editorDraft.display_config.finals[sportId] = { show: false, days: 1 };
  _editorDraft.display_config.finals[sportId].days = parseInt(days);
}

// ‚îÄ‚îÄ Per-scoreboard team browser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _sbTeamActiveSport = null;
let _sbTeamDivFilter = 'd1';
let _sbTeamAllTeams = [];

async function sbEditorSwitchTeamTab(sportId){
  _sbTeamActiveSport = sportId;
  // Update tab styles
  document.querySelectorAll('.sb-team-tab').forEach(t=>{
    const active = t.dataset.sport === sportId;
    t.style.borderColor = active ? 'var(--accent)' : 'var(--border)';
    t.style.background = active ? 'rgba(0,212,255,0.1)' : 'transparent';
    t.style.color = active ? 'var(--accent)' : 'var(--text-dim)';
  });
  // Show division pills for NCAA
  const pillEl = document.getElementById('sbTeamDivPills');
  if(pillEl) pillEl.style.display = sportId.startsWith('ncaa') ? 'flex' : 'none';
  await sbEditorLoadTeams(sportId);
}

async function sbEditorLoadTeams(sportId){
  const listEl = document.getElementById('sbTeamList');
  if(!listEl) return;
  listEl.innerHTML = '<div style="color:var(--text-dim);font-size:12px;padding:12px 0;grid-column:1/-1;">Loading...</div>';
  try {
    let teams = [];
    if(sportId.startsWith('ncaa')){
      teams = await fetchNcaaTeams(sportId, _sbTeamDivFilter);
    } else {
      teams = await loadTbSportData(sportId);
    }
    _sbTeamAllTeams = teams;
    const search = document.getElementById('sbTeamSearch')?.value || '';
    sbEditorRenderTeams(search);
  } catch(e){
    listEl.innerHTML = '<div style="color:var(--accent-red);font-size:12px;grid-column:1/-1;">Failed to load teams</div>';
  }
}

function sbEditorRenderTeams(query=''){
  const listEl = document.getElementById('sbTeamList');
  if(!listEl) return;
  const q = query.toLowerCase().trim();
  const selected = new Set((_editorDraft.team_config||{})[_sbTeamActiveSport] || []);
  let teams = _sbTeamAllTeams;
  if(q) teams = teams.filter(t=>
    (t.name||'').toLowerCase().includes(q) ||
    (t.abbr||'').toLowerCase().includes(q) ||
    (t.shortName||'').toLowerCase().includes(q) ||
    (t.location||'').toLowerCase().includes(q)
  );
  if(!teams.length){
    listEl.innerHTML = '<div style="color:var(--text-dim);font-size:12px;padding:12px 0;grid-column:1/-1;">No teams found</div>';
    return;
  }
  // Update Select All button label based on whether all visible teams are selected
  const selectAllBtn = document.getElementById('sbSelectAllBtn');
  if(selectAllBtn){
    const allKeys = (_sbTeamAllTeams||[]).map(t => t.name || t.abbr);
    const allSelected = allKeys.length > 0 && allKeys.every(k => selected.has(k));
    selectAllBtn.textContent = allSelected ? 'Deselect All' : 'Select All';
    selectAllBtn.style.borderColor = allSelected ? 'var(--accent)' : 'var(--border)';
    selectAllBtn.style.color = allSelected ? 'var(--accent)' : 'var(--text-dim)';
    selectAllBtn.style.background = allSelected ? 'rgba(0,212,255,0.08)' : 'transparent';
  }
  const favs = new Set((_editorDraft.display_config && _editorDraft.display_config.favTeams) || []);
  listEl.innerHTML = teams.map(t=>{
    const key = t.name || t.abbr;
    const on = selected.has(key);
    const fav = favs.has(key);
    const safeKey = key.replace(/'/g,"\\'");
    return `<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;
      background:${on?'rgba(0,212,255,0.08)':'var(--bg-card)'};
      border:1px solid ${on?'rgba(0,212,255,0.35)':'var(--border)'};
      border-radius:8px;transition:all 0.15s;">
      <label style="display:flex;align-items:center;gap:8px;flex:1;cursor:pointer;">
        <input type="checkbox" data-team-key="${key.replace(/"/g,'&quot;')}"
          ${on?'checked':''} onchange="sbEditorToggleTeam('${safeKey}',this.checked)"
          style="accent-color:var(--accent);cursor:pointer;">
        <span style="font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;color:var(--text-primary);">${t.abbr||t.name}</span>
        <span style="font-size:10px;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;">${t.name||''}</span>
      </label>
      <button onclick="sbEditorToggleFavTeam('${safeKey}')" title="Mark as favorite"
        style="background:none;border:none;cursor:pointer;font-size:14px;padding:0 2px;flex-shrink:0;
          filter:${fav?'grayscale(0) drop-shadow(0 0 3px rgba(255,215,0,0.6))':'grayscale(1) opacity(0.3)'};
          transition:filter 0.15s;">‚≠ê</button>
    </div>`;
  }).join('');
}

function sbEditorToggleTeam(key, checked){
  if(!_editorDraft.team_config || Array.isArray(_editorDraft.team_config)) _editorDraft.team_config = {};
  const sport = _sbTeamActiveSport;
  if(!_editorDraft.team_config[sport]) _editorDraft.team_config[sport] = [];
  if(checked){
    if(!_editorDraft.team_config[sport].includes(key)) _editorDraft.team_config[sport].push(key);
  } else {
    _editorDraft.team_config[sport] = _editorDraft.team_config[sport].filter(k=>k!==key);
    if(!_editorDraft.team_config[sport].length) delete _editorDraft.team_config[sport];
  }
  // Update count
  const total = Object.values(_editorDraft.team_config).flat().length;
  const countEl = document.getElementById('sbTeamCount');
  if(countEl) countEl.textContent = `‚úì ${total} team${total!==1?'s':''} selected for this scoreboard`;
  // Re-render current sport list to reflect checked state
  const search = document.getElementById('sbTeamSearch')?.value || '';
  sbEditorRenderTeams(search);
}

function sbPreviewCardScale(val){
  const scale = parseFloat(val) || 1.0;
  const inner = document.getElementById('sbCardScaleInner');
  const wrap  = document.getElementById('sbCardScaleWrap');
  if(!inner || !wrap) return;
  // Reset transform first to measure natural size
  inner.style.transform = '';
  inner.style.removeProperty('--card-score-size');
  inner.style.removeProperty('--card-abbr-size');
  const naturalW = inner.offsetWidth;
  const naturalH = inner.offsetHeight;
  // Apply scale
  inner.style.transform = `scale(${scale})`;
  inner.style.transformOrigin = 'top left';
  // Resize wrapper to match scaled dimensions (prevents gap / overflow)
  wrap.style.width  = Math.round(naturalW * scale) + 'px';
  wrap.style.height = Math.round(naturalH * scale) + 'px';
  // Update font sizes to match stream renderer
  inner.style.setProperty('--card-score-size', Math.round(34 * scale) + 'px');
  inner.style.setProperty('--card-abbr-size',  Math.round(18 * scale) + 'px');
}

function sbEditorFilterTeams(query){
  sbEditorRenderTeams(query);
}

// Toggle a team as a favorite within the scoreboard editor (independent of team_config checkbox)
function sbEditorToggleFavTeam(key){
  if(!_editorDraft.display_config) _editorDraft.display_config = {};
  if(!_editorDraft.display_config.favTeams) _editorDraft.display_config.favTeams = [];
  const favs = _editorDraft.display_config.favTeams;
  const idx = favs.indexOf(key);
  if(idx >= 0) favs.splice(idx, 1);
  else favs.push(key);
  // Re-render to reflect updated star state
  sbEditorRenderTeams(document.getElementById('sbTeamSearch')?.value || '');
}

function sbEditorSelectAllTeams(){
  if(!_sbTeamAllTeams || !_sbTeamAllTeams.length) return;
  if(!_editorDraft.team_config || Array.isArray(_editorDraft.team_config)) _editorDraft.team_config = {};
  const sport = _sbTeamActiveSport;
  const selected = new Set((_editorDraft.team_config[sport]) || []);
  const allKeys = _sbTeamAllTeams.map(t => t.name || t.abbr);
  const allSelected = allKeys.every(k => selected.has(k));
  if(allSelected){
    // Deselect all for this sport
    delete _editorDraft.team_config[sport];
  } else {
    // Select all for this sport
    _editorDraft.team_config[sport] = [...allKeys];
  }
  const total = Object.values(_editorDraft.team_config).flat().length;
  const countEl = document.getElementById('sbTeamCount');
  if(countEl) countEl.textContent = `‚úì ${total} team${total!==1?'s':''} selected for this scoreboard`;
  sbEditorRenderTeams(document.getElementById('sbTeamSearch')?.value || '');
}

function sbEditorSetDiv(div){
  _sbTeamDivFilter = div;
  ['d1','d2','d3','all'].forEach(d=>{
    const btn = document.getElementById(`sbDiv${d.charAt(0).toUpperCase()+d.slice(1)}`);
    if(btn){
      const active = d === div;
      btn.style.borderColor = active ? 'var(--accent)' : 'var(--border)';
      btn.style.background = active ? 'rgba(0,212,255,0.12)' : 'transparent';
      btn.style.color = active ? 'var(--accent)' : 'var(--text-dim)';
    }
  });
  if(_sbTeamActiveSport) sbEditorLoadTeams(_sbTeamActiveSport);
}
// Select All / Deselect All for a sport group
function sbEditorToggleGroup(groupKey){
  const grid = document.querySelector(`.sport-grid[data-group="${groupKey}"]`);
  if(!grid) return;
  const checkboxes = grid.querySelectorAll('input[data-sport]');
  const allChecked = [...checkboxes].every(cb=>cb.checked);
  const newState = !allChecked;
  checkboxes.forEach(cb=>{
    cb.checked = newState;
    cb.closest('.sport-setting-row').classList.toggle('enabled', newState);
    _editorDraft.sport_config[cb.dataset.sport] = newState;
  });
  sbEditorUpdateGroupBtn(groupKey);
}

function sbEditorUpdateGroupBtn(groupKey){
  const grid = document.querySelector(`.sport-grid[data-group="${groupKey}"]`);
  const btn = document.getElementById(`sbGroupBtn_${groupKey}`);
  if(!grid || !btn) return;
  const checkboxes = grid.querySelectorAll('input[data-sport]');
  const allOn = [...checkboxes].every(cb=>cb.checked);
  btn.textContent = allOn ? '‚úì All Selected' : 'Select All';
  btn.style.borderColor = allOn ? 'var(--accent)' : 'var(--border)';
  btn.style.background = allOn ? 'rgba(0,212,255,0.12)' : 'transparent';
  btn.style.color = allOn ? 'var(--accent)' : 'var(--text-dim)';
  btn.dataset.all = allOn ? '1' : '0';
}

// Helper: load pro sport teams via existing tbState cache
async function loadTbSportData(sid){
  // fetchTeamsForSport is the pure data function (no DOM side effects).
  // Never call loadTbSport() here ‚Äî that writes to the old Teams tab DOM
  // elements which don't exist inside the scoreboard editor.
  return fetchTeamsForSport(sid);
}


function closeSbEditor(){
  document.getElementById('sbEditorPanel')?.remove();
  // Re-enable sidebar nav
  document.querySelectorAll('.snav-btn').forEach(b=>{
    b.style.opacity='';b.style.pointerEvents='';
  });
  document.getElementById('sbListView').style.display='block';
  _activeSbId=null;
}

async function saveSbEditor(){
  collectEditorStepData();
  const result=document.getElementById('sbEditResult');
  if(result){result.style.color='var(--text-dim)';result.textContent='Saving...';}
  const r=await fetch(`${API_BASE}/scoreboards/${_activeSbId}`,{
    method:'PATCH',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name:_editorDraft.name, sport_config:_editorDraft.sport_config, display_config:_editorDraft.display_config, team_config:_editorDraft.team_config||{}})
  });
  if(r.ok){
    const d=await r.json();
    const idx=_scoreboards.findIndex(s=>s.id===_activeSbId);
    if(idx>=0)_scoreboards[idx]=d;
    if(result){result.style.color='var(--accent-green)';result.textContent='‚úÖ Saved';}
    setTimeout(()=>{closeSbEditor();renderSbCards();initSidebarScoreboardSelector();},600);
  }else{
    if(result){result.style.color='var(--accent-red)';result.textContent='‚ùå Save failed';}
  }
}


// ‚îÄ‚îÄ Push to Dispatcharr Wizard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openPushWizard(id){
  _activeSbId=id;
  _wizardStep=1;
  _wizardData={};
  const sb=_scoreboards.find(s=>s.id===id);
  if(!sb)return;

  // Pre-fill from stored Dispatcharr values
  _wizardData.channelName=sb.dispatcharr_channel_number?sb.name:sb.name;
  _wizardData.channelNumber=sb.dispatcharr_channel_number||'';
  _wizardData.groupId=sb.dispatcharr_group_id||'';
  _wizardData.profileIds=sb.dispatcharr_profile_ids||null;
  _wizardData.streamProfileId=sb.dispatcharr_stream_profile_id||'';
  _wizardData.isUpdate=!!sb.dispatcharr_channel_id;
  _wizardData.existingChannelId=sb.dispatcharr_channel_id||null;

  document.getElementById('sbListView').style.display='none';
  document.getElementById('sbEditorPanel')?.remove();
  const wiz=document.getElementById('sbPushWizard');
  wiz.style.display='block';
  document.getElementById('wizardTitle').textContent=(_wizardData.isUpdate?'Update':'Push')+ ': '+sb.name;
  document.getElementById('wizardResult').style.display='none';
  renderWizardStep();

  // Pre-load Dispatcharr data
  loadDsGroups();
  loadStreamProfiles();
}

function closePushWizard(){
  document.getElementById('sbPushWizard').style.display='none';
  document.getElementById('sbListView').style.display='block';
  _activeSbId=null;
}

function renderWizardStep(){
  const totalSteps=6;
  // Update step indicators
  document.querySelectorAll('.wizard-step').forEach(s=>{
    const n=parseInt(s.dataset.step);
    s.classList.toggle('active',n===_wizardStep);
    s.classList.toggle('done',n<_wizardStep);
  });
  // Prev/Next/Push buttons
  document.getElementById('wizPrevBtn').style.display=_wizardStep>1?'block':'none';
  document.getElementById('wizNextBtn').style.display=_wizardStep<totalSteps?'block':'none';
  document.getElementById('wizPushBtn').style.display=_wizardStep===totalSteps?'block':'none';

  const body=document.getElementById('wizardBody');
  const sb=_scoreboards.find(s=>s.id===_activeSbId)||{};

  if(_wizardStep===1){
    body.innerHTML=`
      ${_wizardData.isUpdate?`<div class="wiz-update-banner">‚ü≥ This scoreboard already has a Dispatcharr channel (Ch ${sb.dispatcharr_channel_number||'?'}). Saving will update the existing channel.</div>`:''}
      <div class="wiz-field">
        <div class="wiz-label">Channel Name</div>
        <input class="wiz-input" id="wiz_channelName" value="${_wizardData.channelName||sb.name}" placeholder="Channel name in Dispatcharr">
        <div class="wiz-sublabel">This is the name that will appear in Dispatcharr</div>
      </div>
      <div class="wiz-field">
        <div class="wiz-label">Channel Number</div>
        <input class="wiz-input" id="wiz_channelNum" type="number" value="${_wizardData.channelNumber||''}" placeholder="e.g. 900" style="width:140px;">
        <div class="wiz-sublabel">The channel number users tune to in Dispatcharr</div>
      </div>`;
  }
  else if(_wizardStep===2){
    body.innerHTML=`
      <div class="wiz-field">
        <div class="wiz-label">Channel Group</div>
        <div style="display:flex;gap:6px;margin-bottom:6px;">
          <select class="wiz-input" id="wiz_groupSel" style="flex:1;">
            <option value="">‚Äî loading groups ‚Äî</option>
          </select>
          <button class="modal-btn" onclick="wizRefreshGroups()" style="padding:8px 12px;">‚Üª</button>
        </div>
        <div style="display:flex;gap:6px;margin-bottom:6px;">
          <button class="grp-filter-btn active" data-filter="dispatcharr" onclick="wizSetGroupFilter('dispatcharr',this)">Dispatcharr</button>
          <button class="grp-filter-btn" data-filter="m3u" onclick="wizSetGroupFilter('m3u',this)">M3U</button>
          <button class="grp-filter-btn" data-filter="all" onclick="wizSetGroupFilter('all',this)">Both</button>
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;">
          <input class="wiz-input" id="wiz_newGroupName" placeholder="Create new group..." style="flex:1;">
          <button class="modal-btn" onclick="wizCreateGroup()" style="padding:8px 12px;white-space:nowrap;">+ Create</button>
        </div>
        <div id="wiz_groupResult" style="font-size:11px;margin-top:4px;"></div>
      </div>`;
    // Populate group dropdown
    setTimeout(wizPopulateGroups,100);
  }
  else if(_wizardStep===3){
    body.innerHTML=`
      <div class="wiz-field">
        <div class="wiz-label">Channel Profiles</div>
        <div class="wiz-sublabel" style="margin-bottom:10px;">Select which user groups get access to this channel</div>
        <div class="profile-multiselect" id="wizProfileMulti">
          <div class="profile-ms-trigger" onclick="toggleWizProfileDropdown()">
            <span id="wizProfileLabel">‚Äî loading profiles ‚Äî</span>
            <span style="margin-left:auto;opacity:0.5;">‚ñæ</span>
          </div>
          <div class="profile-ms-dropdown" id="wizProfileDropdown" style="display:none;">
            <label class="profile-ms-item profile-ms-all">
              <input type="checkbox" id="wizProfileAll" onchange="onWizProfileAllChange(this)">
              <span>All Profiles</span>
            </label>
            <div class="profile-ms-divider"></div>
            <div id="wizProfileList"></div>
          </div>
        </div>
      </div>`;
    setTimeout(wizLoadProfiles,100);
  }
  else if(_wizardStep===4){
    // HLS-correct ffmpeg profile for ScoreStream
    const hlsParams='-re -fflags +genpts -i {streamUrl} -c copy -f mpegts pipe:1';
    body.innerHTML=`
      <div class="wiz-field">
        <div class="wiz-label">Stream Profile (ffmpeg)</div>
        <div class="wiz-sublabel" style="margin-bottom:6px;">How Dispatcharr pulls and re-streams the ScoreStream HLS feed</div>
        <div style="padding:10px 12px;background:rgba(0,255,136,0.06);border:1px solid rgba(0,255,136,0.2);border-radius:8px;margin-bottom:10px;font-size:12px;color:var(--accent-green);">
          üí° <strong>ScoreStream outputs HLS</strong> ‚Äî select a profile below or create the recommended one. The default Dispatcharr profile may fail with HLS streams; the "ScoreStream HLS" profile below is pre-configured correctly.
        </div>
        <div style="display:flex;gap:6px;">
          <select class="wiz-input" id="wiz_streamProf" style="flex:1;" onchange="onWizStreamProfChange()">
            <option value="">‚Äî loading ‚Äî</option>
          </select>
          <button class="modal-btn" onclick="loadStreamProfiles().then(wizPopulateStreamProfiles)" style="padding:8px 12px;">‚Üª</button>
        </div>
        <div id="wiz_customStreamPanel" style="margin-top:12px;">
          <div class="wiz-label" style="margin-bottom:6px;">Create Recommended Profile</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);padding:8px 12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;word-break:break-all;">${hlsParams}</div>
          <div style="display:flex;gap:6px;">
            <input class="wiz-input" id="wiz_customName" value="ScoreStream HLS" placeholder="Profile name..." style="flex:1;">
            <button class="modal-btn" onclick="wizCreateHlsProfile()" style="padding:8px 12px;white-space:nowrap;">+ Create &amp; Use</button>
          </div>
          <div id="wiz_customStreamResult" style="font-size:11px;margin-top:6px;"></div>
        </div>
      </div>
      <div class="wiz-field">
        <div class="wiz-label">Stream URL (auto-generated)</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--accent);padding:8px 12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;">
          ${sb.slug?`${window.location.origin}/hls/${sb.slug}.m3u8`:'(STREAM_BASE_URL not configured)'}
        </div>
        <div class="wiz-sublabel">This URL is stored as the stream source in Dispatcharr. If blank, set STREAM_BASE_URL in your docker-compose env.</div>
      </div>`;
    setTimeout(wizPopulateStreamProfiles,100);
  }
  else if(_wizardStep===5){
    // Logo step
    body.innerHTML=`
      <div class="wiz-field">
        <div class="wiz-label">Channel Logo</div>
        <div class="wiz-sublabel" style="margin-bottom:12px;">Optional. Assign a logo that appears in Dispatcharr and on IPTV clients.</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;">
          <div id="wiz_logoPreview" style="width:80px;height:80px;border-radius:10px;border:1px solid var(--border);background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;font-size:32px;flex-shrink:0;">
            ${_wizardData.logoId?'üñºÔ∏è':'üì°'}
          </div>
          <div style="flex:1;min-width:200px;">
            <div class="wiz-sublabel" style="margin-bottom:8px;">Enter a public image URL for the logo:</div>
            <div style="display:flex;gap:6px;">
              <input class="wiz-input" id="wiz_logoUrl" placeholder="https://example.com/logo.png" style="flex:1;" value="${_wizardData.logoUrl||''}">
              <button class="modal-btn" onclick="wizPreviewLogo()" style="padding:8px 10px;">Preview</button>
            </div>
            <div class="wiz-sublabel" style="margin-top:6px;">Leave blank to skip logo assignment. You can set it later in Dispatcharr directly.</div>
          </div>
        </div>
        <div id="wiz_logoResult" style="font-size:11px;margin-top:4px;"></div>
      </div>`;
  }
  else if(_wizardStep===6){
    const sb2=_scoreboards.find(s=>s.id===_activeSbId)||{};
    const logoDisplay=_wizardData.logoUrl?`<img src="${_wizardData.logoUrl}" style="height:32px;border-radius:4px;vertical-align:middle;margin-left:8px;" onerror="this.style.display='none'">`:'(none)';
    body.innerHTML=`
      <div style="margin-bottom:16px;">
        <div class="wiz-label" style="margin-bottom:12px;">Review &amp; Confirm</div>
        ${_wizardData.isUpdate?'<div class="wiz-update-banner">‚ü≥ This will UPDATE the existing Dispatcharr channel</div>':''}
        <div class="wiz-review-row"><span class="wiz-review-key">Scoreboard</span><span class="wiz-review-val">${sb2.name}</span></div>
        <div class="wiz-review-row"><span class="wiz-review-key">Channel Name</span><span class="wiz-review-val">${_wizardData.channelName||sb2.name}</span></div>
        <div class="wiz-review-row"><span class="wiz-review-key">Channel #</span><span class="wiz-review-val">${_wizardData.channelNumber||'(auto)'}</span></div>
        <div class="wiz-review-row"><span class="wiz-review-key">Group</span><span class="wiz-review-val">${_wizardData.groupName||'(none)'}</span></div>
        <div class="wiz-review-row"><span class="wiz-review-key">Profiles</span><span class="wiz-review-val">${_wizardData.profileIds==='all'?'All Profiles':Array.isArray(_wizardData.profileIds)&&_wizardData.profileIds.length?_wizardData.profileIds.length+' selected':'(none)'}</span></div>
        <div class="wiz-review-row"><span class="wiz-review-key">Stream Profile</span><span class="wiz-review-val">${_wizardData.streamProfileName||'(default)'}</span></div>
        <div class="wiz-review-row"><span class="wiz-review-key">Logo</span><span class="wiz-review-val">${logoDisplay}</span></div>
        <div class="wiz-review-row"><span class="wiz-review-key">Stream URL</span><span class="wiz-review-val" style="font-family:monospace;font-size:10px;">${sb2.slug?`${window.location.origin}/hls/${sb2.slug}.m3u8`:'(not set ‚Äî configure STREAM_BASE_URL)'}</span></div>
      </div>`;
  }
}

// Helper: create the recommended HLS ffmpeg profile and select it
async function wizCreateHlsProfile(){
  const name=document.getElementById('wiz_customName')?.value?.trim()||'ScoreStream HLS';
  const params='-re -fflags +genpts -i {streamUrl} -c copy -f mpegts pipe:1';
  const res=document.getElementById('wiz_customStreamResult');
  res.style.color='var(--text-dim)';res.textContent='Creating...';
  const r=await fetch(`${API_BASE}/dispatcharr/streamprofiles`,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name,parameters:params})
  });
  const d=await r.json();
  if(r.ok&&d.id){
    _cachedStreamProfiles=null;
    _wizardData.streamProfileId=d.id;
    _wizardData.streamProfileName=d.name||name;
    res.style.color='var(--accent-green)';res.textContent=`‚úÖ Profile "${d.name||name}" created and selected`;
    await loadStreamProfiles();
    await wizPopulateStreamProfiles();
    const sel=document.getElementById('wiz_streamProf');
    if(sel) sel.value=String(d.id);
  }else{
    res.style.color='var(--accent-red)';res.textContent='‚ùå '+(d.error||'Failed ‚Äî may already exist, select it above');
  }
}

function wizPreviewLogo(){
  const url=document.getElementById('wiz_logoUrl')?.value?.trim();
  const preview=document.getElementById('wiz_logoPreview');
  const result=document.getElementById('wiz_logoResult');
  if(!url){result.textContent='Enter a URL first';return;}
  preview.innerHTML=`<img src="${url}" style="width:76px;height:76px;object-fit:contain;border-radius:8px;" onerror="this.parentElement.innerHTML='‚ùå';document.getElementById('wiz_logoResult').textContent='Could not load image';">`;
  _wizardData.logoUrl=url;
  result.textContent='';
}

// Step navigation ‚Äî collect form values before moving
function wizardNav(dir){
  // Collect current step data before advancing
  if(_wizardStep===1){
    _wizardData.channelName=document.getElementById('wiz_channelName')?.value||'';
    _wizardData.channelNumber=document.getElementById('wiz_channelNum')?.value||'';
  }
  if(_wizardStep===2){
    const sel=document.getElementById('wiz_groupSel');
    _wizardData.groupId=sel?.value||'';
    _wizardData.groupName=sel?.options[sel?.selectedIndex]?.text||'';
  }
  if(_wizardStep===3){
    _wizardData.profileIds=getWizProfileIds();
  }
  if(_wizardStep===4){
    const sel=document.getElementById('wiz_streamProf');
    const val=sel?.value;
    _wizardData.streamProfileId=(val&&val!=='__custom__')?val:'';
    _wizardData.streamProfileName=val&&val!=='__custom__'?sel?.options[sel?.selectedIndex]?.text:'(custom/none)';
  }
  if(_wizardStep===5){
    const urlEl=document.getElementById('wiz_logoUrl');
    if(urlEl) _wizardData.logoUrl=urlEl.value.trim();
  }
  const newStep=_wizardStep+dir;
  if(newStep<1||newStep>6)return;
  _wizardStep=newStep;
  renderWizardStep();
}

async function executeWizardPush(){
  const resultEl=document.getElementById('wizardResult');
  resultEl.style.display='block';
  resultEl.style.color='var(--text-dim)';
  resultEl.textContent='‚è≥ Pushing to Dispatcharr...';
  document.getElementById('wizPushBtn').disabled=true;

  const payload={
    channelName:_wizardData.channelName,
    logoUrl:_wizardData.logoUrl||null,
    channelNumber:_wizardData.channelNumber?parseInt(_wizardData.channelNumber):null,
    groupId:_wizardData.groupId?parseInt(_wizardData.groupId):null,
    profileIds:_wizardData.profileIds||null,
    streamProfileId:_wizardData.streamProfileId?parseInt(_wizardData.streamProfileId):null,
  };

  try{
    const r=await fetch(`${API_BASE}/scoreboards/${_activeSbId}/push`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload),signal:AbortSignal.timeout(30000)
    });
    const d=await r.json();
    if(r.ok){
      resultEl.style.color='var(--accent-green)';
      resultEl.textContent=`‚úÖ ${d.action==='updated'?'Channel updated':'Channel created'}: ${d.channel_name}${d.channel_number?' (Ch '+d.channel_number+')':''}`;
      // Update local scoreboard record
      if(d.scoreboard){
        const idx=_scoreboards.findIndex(s=>s.id===_activeSbId);
        if(idx>=0)_scoreboards[idx]=d.scoreboard;
      }
      document.getElementById('wizPushBtn').textContent='‚úÖ Done';
      setTimeout(()=>{closePushWizard();renderSbCards();},2000);
    }else{
      resultEl.style.color='var(--accent-red)';
      resultEl.textContent='‚ùå '+(d.error||'Push failed');
      document.getElementById('wizPushBtn').disabled=false;
    }
  }catch(e){
    resultEl.style.color='var(--accent-red)';
    resultEl.textContent='‚ùå '+e.message;
    document.getElementById('wizPushBtn').disabled=false;
  }
}

// Wizard group helpers
let _wizGroupFilter='dispatcharr';
function wizPopulateGroups(){
  const sel=document.getElementById('wiz_groupSel');
  if(!sel||!_allGroups.length){
    if(sel)sel.innerHTML='<option value="">‚Äî loading... ‚Äî</option>';
    loadDsGroups().then(()=>setTimeout(wizPopulateGroups,500));
    return;
  }
  let filtered=_allGroups;
  if(_wizGroupFilter==='dispatcharr') filtered=_allGroups.filter(g=>g.m3u_count===0);
  else if(_wizGroupFilter==='m3u') filtered=_allGroups.filter(g=>g.m3u_count>0);
  if(!filtered.length)filtered=_allGroups;
  sel.innerHTML='<option value="">‚Äî no group ‚Äî</option>'+
    filtered.map(g=>`<option value="${g.id}"${_wizardData.groupId==g.id?' selected':''}>${g.name}${g.m3u_count>0?' (M3U)':''}</option>`).join('');
}
function wizSetGroupFilter(f,btn){
  _wizGroupFilter=f;
  document.querySelectorAll('#wiz_groupSel').length&&wizPopulateGroups();
  document.querySelectorAll('.grp-filter-btn').forEach(b=>b.classList.toggle('active',b.dataset.filter===f));
}
async function wizRefreshGroups(){ _allGroups=[]; await loadDsGroups(); wizPopulateGroups(); }
async function wizCreateGroup(){
  const name=document.getElementById('wiz_newGroupName')?.value?.trim();
  const res=document.getElementById('wiz_groupResult');
  if(!name)return;
  res.style.color='var(--text-dim)';res.textContent='Creating...';
  const r=await fetch(`${API_BASE}/dispatcharr/groups`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});
  const d=await r.json();
  if(r.ok&&d.id){
    _allGroups.push({id:d.id,name:d.name,m3u_count:0});
    _allGroups.sort((a,b)=>a.name.localeCompare(b.name));
    _wizardData.groupId=d.id;
    wizPopulateGroups();
    res.style.color='var(--accent-green)';res.textContent='‚úÖ Group "'+d.name+'" created';
    document.getElementById('wiz_newGroupName').value='';
  }else{res.style.color='var(--accent-red)';res.textContent='‚ùå '+(d.error||'Failed');}
}

// Wizard profiles helpers
async function wizLoadProfiles(){
  const listEl=document.getElementById('wizProfileList');
  if(!listEl)return;
  listEl.innerHTML='<div style="padding:8px;color:var(--text-dim);font-size:12px;">Loading...</div>';
  const r=await fetch(`${API_BASE}/dispatcharr/profiles`,{signal:AbortSignal.timeout(50000)});
  const d=await r.json();
  if(r.ok&&d.profiles?.length){
    listEl.innerHTML=d.profiles.map(p=>`<label class="profile-ms-item"><input type="checkbox" class="wiz-profile-cb" value="${p.id}" onchange="onWizProfileCbChange()"><span>${p.name}</span></label>`).join('');
    // Restore previous selection
    if(_wizardData.profileIds==='all'){document.getElementById('wizProfileAll').checked=true;}
    else if(Array.isArray(_wizardData.profileIds)){
      document.querySelectorAll('.wiz-profile-cb').forEach(cb=>{if(_wizardData.profileIds.includes(parseInt(cb.value)))cb.checked=true;});
    }
    updateWizProfileLabel();
  }else{listEl.innerHTML='<div style="padding:8px;color:var(--text-dim);font-size:12px;">No profiles found</div>';}
}
function toggleWizProfileDropdown(){
  const dd=document.getElementById('wizProfileDropdown');
  if(dd)dd.style.display=dd.style.display==='none'?'block':'none';
}
function onWizProfileAllChange(cb){
  if(cb.checked)document.querySelectorAll('.wiz-profile-cb').forEach(c=>c.checked=false);
  updateWizProfileLabel();
}
function onWizProfileCbChange(){
  if([...document.querySelectorAll('.wiz-profile-cb')].some(c=>c.checked))
    document.getElementById('wizProfileAll').checked=false;
  updateWizProfileLabel();
}
function updateWizProfileLabel(){
  const allCb=document.getElementById('wizProfileAll');
  const checked=[...document.querySelectorAll('.wiz-profile-cb:checked')];
  const label=document.getElementById('wizProfileLabel');
  if(!label)return;
  if(allCb?.checked)label.textContent='All Profiles';
  else if(checked.length===0)label.textContent='‚Äî none selected ‚Äî';
  else if(checked.length===1)label.textContent=checked[0].nextElementSibling?.textContent||'1 profile';
  else label.textContent=`${checked.length} profiles selected`;
}
function getWizProfileIds(){
  const allCb=document.getElementById('wizProfileAll');
  if(allCb?.checked)return 'all';
  const ids=[...document.querySelectorAll('.wiz-profile-cb:checked')].map(c=>parseInt(c.value));
  return ids.length?ids:null;
}

// Wizard stream profile helpers
async function wizPopulateStreamProfiles(){
  const sel=document.getElementById('wiz_streamProf');
  if(!sel)return;
  if(!_cachedStreamProfiles?.length){
    await loadStreamProfiles();
  }
  if(!_cachedStreamProfiles?.length){sel.innerHTML='<option value="">‚Äî none available ‚Äî</option>';return;}
  sel.innerHTML='<option value="">‚Äî default (none) ‚Äî</option>'+
    '<option value="__custom__">+ Create custom ffmpeg profile...</option>'+
    '<optgroup label="Built-in">'+_cachedStreamProfiles.filter(p=>p.locked).map(p=>`<option value="${p.id}"${_wizardData.streamProfileId==p.id?' selected':''}>${p.name}</option>`).join('')+'</optgroup>'+
    (_cachedStreamProfiles.filter(p=>!p.locked).length?
      '<optgroup label="Custom">'+_cachedStreamProfiles.filter(p=>!p.locked).map(p=>`<option value="${p.id}"${_wizardData.streamProfileId==p.id?' selected':''}>${p.name}</option>`).join('')+'</optgroup>':'');
  sel.onchange=onWizStreamProfChange;
}
function onWizStreamProfChange(){
  const sel=document.getElementById('wiz_streamProf');
  const panel=document.getElementById('wiz_customStreamPanel');
  if(panel)panel.style.display=sel?.value==='__custom__'?'block':'none';
}
async function wizCreateStreamProfile(){
  const name=document.getElementById('wiz_customName')?.value?.trim();
  const params=document.getElementById('wiz_customParams')?.value?.trim();
  const res=document.getElementById('wiz_customStreamResult');
  if(!name||!params){res.style.color='var(--accent-red)';res.textContent='Name and parameters required.';return;}
  res.style.color='var(--text-dim)';res.textContent='Creating...';
  const r=await fetch(`${API_BASE}/dispatcharr/streamprofiles`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,parameters:params})});
  const d=await r.json();
  if(r.ok&&d.id){
    _cachedStreamProfiles=null; // clear cache
    res.style.color='var(--accent-green)';res.textContent='‚úÖ Created: '+d.name;
    _wizardData.streamProfileId=d.id;
    _wizardData.streamProfileName=d.name;
    await wizPopulateStreamProfiles();
    document.getElementById('wiz_customStreamPanel').style.display='none';
  }else{res.style.color='var(--accent-red)';res.textContent='‚ùå '+(d.error||'Failed');}
}

// Cache for stream profiles used across settings and wizard
let _cachedStreamProfiles=null;
const _origLoadStreamProfiles=typeof loadStreamProfiles!=='undefined'?loadStreamProfiles:null;


const ALL_SPORTS=[
  // Pro
  {id:'nfl',   name:'NFL',                  group:'pro',   color:'#4169e1',emoji:'üèà',url:'https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard'},
  {id:'nba',   name:'NBA',                  group:'pro',   color:'#c9082a',emoji:'üèÄ',url:'https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard'},
  {id:'mlb',   name:'MLB',                  group:'pro',   color:'#002d72',emoji:'‚öæ',url:'https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/scoreboard'},
  {id:'nhl',   name:'NHL',                  group:'pro',   color:'#00b7e0',emoji:'üèí',url:'https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard'},
  // NCAA Men
  {id:'ncaamb',name:"NCAA Men's Basketball",group:'ncaam', color:'#ff6600',emoji:'üèÄ',url:'https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/scoreboard'},
  {id:'ncaafb',name:'NCAA Football',        group:'ncaam', color:'#8b0000',emoji:'üèà',url:'https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard'},
  {id:'ncaabase',name:"NCAA Men's Baseball",group:'ncaam', color:'#005c2e',emoji:'‚öæ',url:'https://site.api.espn.com/apis/site/v2/sports/baseball/college-baseball/scoreboard'},
  // NCAA Women
  {id:'ncaawb',name:"NCAA Women's Basketball",group:'ncaaw',color:'#c7006b',emoji:'üèÄ',url:'https://site.api.espn.com/apis/site/v2/sports/basketball/womens-college-basketball/scoreboard'},
  {id:'ncaasb',name:"NCAA Softball",        group:'ncaaw', color:'#7b3f99',emoji:'ü•é',url:'https://site.api.espn.com/apis/site/v2/sports/baseball/college-softball/scoreboard'},
];

// Default enabled sports
const DEFAULT_ENABLED=new Set(['nfl','nba','mlb','nhl','ncaamb','ncaabase']);

// =====================
//  NCAA FULL NAME MAP
// =====================
// This object is the bundled fallback ‚Äî used only when the API is unavailable.
// The authoritative data lives in the SQLite DB (/config/scorestream.db)
// and is served by the Flask API at /api/ncaa/teams.
// To add/edit/remove schools: update the DB directly or wait for the
// Manage NCAA Teams admin UI (Coming Soon).
//
// NCAA_CRUD_ENABLED = false  ‚Üê set true when admin UI is ready for release

const NCAA_CRUD_ENABLED = true;

const NCAA_NAMES_FALLBACK={
// ‚îÄ‚îÄ SEC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
'ALA':  {school:'University of Alabama',         nick:'Crimson Tide',   short:'Alabama',          sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'ARK':  {school:'University of Arkansas',        nick:'Razorbacks',     short:'Arkansas',         sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'AUB':  {school:'Auburn University',             nick:'Tigers',         short:'Auburn',           sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'FLA':  {school:'University of Florida',         nick:'Gators',         short:'Florida',          sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'UGA':  {school:'University of Georgia',         nick:'Bulldogs',       short:'Georgia',          sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'UK':   {school:'University of Kentucky',        nick:'Wildcats',       short:'Kentucky',         sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'LSU':  {school:'Louisiana State University',    nick:'Tigers',         short:'LSU',              sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'MISS': {school:'University of Mississippi',     nick:'Rebels',         short:'Ole Miss',         sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'MSST': {school:'Mississippi State University',  nick:'Bulldogs',       short:'Mississippi St',   sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'MO':   {school:'University of Missouri',        nick:'Tigers',         short:'Missouri',         sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'SC':   {school:'University of South Carolina',  nick:'Gamecocks',      short:'South Carolina',   sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'TAMU': {school:'Texas A&M University',          nick:'Aggies',         short:'Texas A&M',        sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'TA&M': {school:'Texas A&M University',          nick:'Aggies',         short:'Texas A&M',        sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'TENN': {school:'University of Tennessee',       nick:'Volunteers',     short:'Tennessee',        sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
'VAN':  {school:'Vanderbilt University',         nick:'Commodores',     short:'Vanderbilt',       sports:['ncaafb','ncaamb','ncaawb','ncaabase','ncaasb']},
};

// Runtime NCAA name map ‚Äî populated from API on load, falls back to NCAA_NAMES_FALLBACK
let NCAA_NAMES = {...NCAA_NAMES_FALLBACK};

async function loadNcaaFromApi() {
  try {
    // New two-table API: fetch all programs (one row per school+sport+division)
    const r = await fetch(`${API_BASE}/ncaa/programs`, {signal: AbortSignal.timeout(8000)});
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json();
    const programs = data.programs || [];
    if (!programs.length) throw new Error('empty');
    // Build NCAA_NAMES map: keyed by abbr, contains per-sport nick overrides
    const map = {};
    programs.forEach(p => {
      const abbr = (p.espn_abbr || '').toUpperCase();
      if (!abbr) return;
      if (!map[abbr]) {
        map[abbr] = {
          school: p.full_name,
          nick:   p.nick || p.short_name,
          short:  p.short_name || p.full_name,
          color:  p.color || '333333',
          logo:   p.logo_url || null,
          sports: [],
          // per-sport nick overrides (e.g. TENN womens = "Lady Volunteers")
          nickBySport: {},
          division: p.division || 'unknown',
        };
      }
      if (!map[abbr].sports.includes(p.sport_id)) map[abbr].sports.push(p.sport_id);
      map[abbr].nickBySport[p.sport_id + '_' + p.gender] = p.nick || p.short_name;
      // Prefer color/logo from any program (they're school-level)
      if (!map[abbr].color || map[abbr].color === '333333') map[abbr].color = p.color || '333333';
      if (!map[abbr].logo && p.logo_url) map[abbr].logo = p.logo_url;
    });
    Object.assign(NCAA_NAMES, map);
    // Bust NCAA sport caches so next load uses fresh data
    Object.keys(tbState.teamCache).forEach(k => { if (k.startsWith('ncaa')) delete tbState.teamCache[k]; });
    console.log('[NCAA] Loaded', programs.length, 'programs for', Object.keys(map).length, 'schools');
  } catch(e) {
    console.warn('[NCAA] API unavailable, using bundled fallback:', e.message);
  }
}
// =====================
//  STATE
// =====================
function loadEnabledSports(){
  try{const s=ss.get('ss_sports');return s?new Set(JSON.parse(s)):new Set(DEFAULT_ENABLED);}catch(e){return new Set(DEFAULT_ENABLED);}
}
function saveEnabledSports(){ss.set('ss_sports',JSON.stringify([...state.enabledSports]));}

function loadActiveSports(enabled){
  // activeSports defaults to all currently enabled sports
  try{const s=ss.get('ss_active_sports');return s?new Set(JSON.parse(s)):new Set(enabled);}catch(e){return new Set(enabled);}
}
function saveActiveSports(){ss.set('ss_active_sports',JSON.stringify([...state.activeSports]));}

const _enabledSports = new Set(ALL_SPORTS.map(s => s.id)); // All Sports view always shows all sports
const state={
  layout:'grid',
  enabledSports:_enabledSports,
  activeSports:loadActiveSports(_enabledSports),
  statsDepth:'basic',
  filterMode:'all',
  games:{},
  favTeams:loadFavs(),
  showEnded:false,
  daysPerSport:{nfl:7,nhl:2,nba:2,mlb:1,ncaamb:2,ncaawb:2,ncaabase:1,ncaasb:1,ncaafb:7},
  endedLeagues:new Set(ALL_SPORTS.map(s=>s.id)),
  endedFilter:Object.fromEntries(ALL_SPORTS.map(s=>[s.id,'all'])),
  seasonMeta:{},
  usingMock:false,
  refreshRate:60,
  display:{abbrSize:18,scoreSize:34,nameSize:11,nameColor:'#3d5a78'},
};

// getSPORTS: returns sports enabled in Settings AND active in sidebar (for scoreboard render)
function getSPORTS(){return ALL_SPORTS.filter(s=>state.enabledSports.has(s.id)&&state.activeSports.has(s.id));}
// getAllEnabledSports: returns all sports enabled in Settings (for team browser, fetch, etc.)
function getAllEnabledSports(){return ALL_SPORTS.filter(s=>state.enabledSports.has(s.id));}

function loadFavs(){try{return new Set(JSON.parse(ss.get('ss_favs')||'[]'));}catch(e){return new Set();}}
function saveFavs(){ss.set('ss_favs',JSON.stringify([...state.favTeams]));}
function saveDisplay(){ss.set('ss_display',JSON.stringify(state.display));}
function loadDisplay(){try{const d=ss.get('ss_display');if(d)Object.assign(state.display,JSON.parse(d));}catch(e){}}

// =====================
//  FAVORITES
// =====================
function toggleFavTeam(n){
  if(state.favTeams.has(n)) state.favTeams.delete(n); else state.favTeams.add(n);
  if(_activeSidebarSbId){
    saveSbFavs();  // save favTeams to display_config.favTeams ‚Äî never touches team_config
  } else {
    saveFavs();
  }
  renderScoreboard(); renderFavSummary();
}


// Save per-scoreboard favTeams to display_config via API (never touches team_config)
function saveSbFavs(){
  if(!_activeSidebarSbId) return;
  const sb = _scoreboards.find(s => s.id === _activeSidebarSbId);
  const dc = Object.assign({}, sb ? (sb.display_config || {}) : {});
  dc.favTeams = [...state.favTeams];
  if(sb) sb.display_config = dc;
  fetch(`${API_BASE}/scoreboards/${_activeSidebarSbId}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ display_config: dc })
  }).catch(e => console.warn('[favs] Failed to save sb favs:', e.message));
}
function isGameFavorited(g){return g.teams.some(t=>state.favTeams.has(t.name)||state.favTeams.has(t.abbr));}
function clearAllFavTeams(){
  state.favTeams.clear();
  if(_activeSidebarSbId){ saveSbFavs(); } else { saveFavs(); }
  renderScoreboard(); renderFavSummary();
}

function renderFavSummary(){
  const c=document.getElementById('favSummary');if(!c)return;
  const tags=[];
  state.favTeams.forEach(t=>{const safe=t.replace(/'/g,"\\'");tags.push(`<div class="fav-tag" onclick="toggleFavTeam('${safe}')">‚≠ê ${t} <span class="remove-fav">‚úï</span></div>`);});
  c.innerHTML=tags.length?tags.join(''):'<div class="no-favs-hint">Star a team or league to pin it here</div>';
}

// =====================
//  ENDED GAMES
// =====================
function buildEndedLeagueToggles(){
  const c=document.getElementById('endedLeagueToggles');if(!c)return;c.innerHTML='';
  // Only show sports that are enabled in Settings AND currently active in sidebar
  ALL_SPORTS.filter(s=>state.enabledSports.has(s.id)&&state.activeSports.has(s.id)).forEach(sport=>{
    const on=state.endedLeagues.has(sport.id),days=state.daysPerSport[sport.id]||1,filter=state.endedFilter[sport.id]||'all';
    const row=document.createElement('div');
    row.className=`ended-league-row${on?' active':''}`;row.id=`ended-row-${sport.id}`;
    row.innerHTML=`
      <div class="ended-league-header">
        <div class="ended-league-name"><div style="width:7px;height:7px;border-radius:2px;background:${sport.color}"></div>${sport.emoji} ${sport.name}</div>
        <div class="small-toggle${on?' on':''}" id="ended-toggle-${sport.id}" onclick="toggleEndedLeague('${sport.id}')"></div>
      </div>
      <div class="ended-league-slider-wrap">
        <div class="league-days-row">
          <span class="league-days-label">Days back:</span>
          <input type="range" min="1" max="7" value="${days}" id="days-slider-${sport.id}" oninput="onLeagueDaysChange('${sport.id}',this.value)">
          <span class="league-days-val" id="days-val-${sport.id}">${days}d</span>
        </div>
        <div class="ended-filter-row">
          <div class="ended-filter-pill ${filter==='all'?'active':''}" onclick="setEndedFilter('${sport.id}','all')" id="efp-all-${sport.id}">All</div>
          <div class="ended-filter-pill fav ${filter==='favs-first'?'active fav':''}" onclick="setEndedFilter('${sport.id}','favs-first')" id="efp-first-${sport.id}">‚≠ê First</div>
          <div class="ended-filter-pill fav ${filter==='favs-only'?'active fav':''}" onclick="setEndedFilter('${sport.id}','favs-only')" id="efp-only-${sport.id}">‚≠ê Only</div>
        </div>
      </div>`;
    c.appendChild(row);
  });
}

function setEndedFilter(sid,v){
  state.endedFilter[sid]=v;
  ['all','favs-first','favs-only'].forEach(x=>{
    const k=x==='all'?'all':x==='favs-first'?'first':'only';
    const el=document.getElementById(`efp-${k}-${sid}`);if(!el)return;
    el.classList.toggle('active',x===v);if(x!=='all')el.classList.toggle('fav',x===v);
  });
  renderScoreboard();
}

function toggleEndedMaster(){
  state.showEnded=!state.showEnded;
  document.getElementById('endedMasterToggle').classList.toggle('on',state.showEnded);
  document.getElementById('endedControls').style.display=state.showEnded?'block':'none';
  if(state.showEnded)buildEndedLeagueToggles();
  fetchAllScores();
}

function toggleEndedLeague(id){
  if(state.endedLeagues.has(id))state.endedLeagues.delete(id);else state.endedLeagues.add(id);
  document.getElementById(`ended-toggle-${id}`)?.classList.toggle('on',state.endedLeagues.has(id));
  document.getElementById(`ended-row-${id}`)?.classList.toggle('active',state.endedLeagues.has(id));
  fetchAllScores();
}

function onLeagueDaysChange(sid,v){
  state.daysPerSport[sid]=parseInt(v);
  const el=document.getElementById(`days-val-${sid}`);if(el)el.textContent=`${v}d`;
  fetchAllScores();
}

// =====================
//  SIDEBAR SPORT TOGGLES
// =====================
function buildSportToggles(){
  const c=document.getElementById('sport-toggles');c.innerHTML='';
  // Show all sports enabled in Settings; toggle controls active display
  ALL_SPORTS.filter(s=>state.enabledSports.has(s.id)).forEach(sport=>{
    const active=state.activeSports.has(sport.id);
    const season=state.seasonMeta[sport.id];
    const isOff=season?.isOff||false;
    const div=document.createElement('div');
    div.className=`sport-toggle${active?' active':''}${isOff?' off-season':''}`;
    div.id=`sport-toggle-${sport.id}`;
    div.dataset.sport=sport.id;
    let badge='';
    if(season&&season.key!=='reg')badge=`<span class="sport-season-badge ${season.key}">${season.label}</span>`;
    div.innerHTML=`
      <div class="sport-info">
        <div class="sport-dot" style="background:${sport.color}"></div>
        <div><span class="sport-name">${sport.name}</span>${badge}</div>
      </div>
      <div style="display:flex;align-items:center;gap:5px;">
        <span class="sport-count" id="count-${sport.id}">‚Äì</span>
        <div class="toggle-switch"></div>
      </div>`;
    div.addEventListener('click',()=>{
      if(state.activeSports.has(sport.id)){
        state.activeSports.delete(sport.id);
        div.classList.remove('active');
      } else {
        state.activeSports.add(sport.id);
        div.classList.add('active');
      }
      settingsSave(saveActiveSports);
      if(state.showEnded) buildEndedLeagueToggles();
      renderScoreboard();
    });
    c.appendChild(div);
  });
}

function refreshSportToggles(){buildSportToggles();}

// =====================
//  DISPLAY SETTINGS
// =====================
function applyDisplay(){
  const abbrEl=document.getElementById('sl-abbr'),scoreEl=document.getElementById('sl-score'),nameEl=document.getElementById('sl-name'),colorEl=document.getElementById('nameColorPicker');
  if(abbrEl){state.display.abbrSize=parseInt(abbrEl.value);document.getElementById('val-abbr').textContent=abbrEl.value+'px';}
  if(scoreEl){state.display.scoreSize=parseInt(scoreEl.value);document.getElementById('val-score').textContent=scoreEl.value+'px';}
  if(nameEl){state.display.nameSize=parseInt(nameEl.value);document.getElementById('val-name').textContent=nameEl.value+'px';}
  if(colorEl){state.display.nameColor=colorEl.value;document.getElementById('nameColorVal').textContent=colorEl.value;document.getElementById('nameColorSwatch').style.background=colorEl.value;}
  const root=document.documentElement;
  root.style.setProperty('--card-abbr-size',state.display.abbrSize+'px');
  root.style.setProperty('--card-score-size',state.display.scoreSize+'px');
  root.style.setProperty('--card-name-size',state.display.nameSize+'px');
  root.style.setProperty('--card-name-color',state.display.nameColor);
  settingsSave(saveDisplay);
}

function setNameColor(c){
  document.getElementById('nameColorPicker').value=c;
  applyDisplay();
}

function initDisplayControls(){
  loadDisplay();
  const root=document.documentElement;
  root.style.setProperty('--card-abbr-size',state.display.abbrSize+'px');
  root.style.setProperty('--card-score-size',state.display.scoreSize+'px');
  root.style.setProperty('--card-name-size',state.display.nameSize+'px');
  root.style.setProperty('--card-name-color',state.display.nameColor);
  const abbrEl=document.getElementById('sl-abbr');if(abbrEl){abbrEl.value=state.display.abbrSize;document.getElementById('val-abbr').textContent=state.display.abbrSize+'px';}
  const scoreEl=document.getElementById('sl-score');if(scoreEl){scoreEl.value=state.display.scoreSize;document.getElementById('val-score').textContent=state.display.scoreSize+'px';}
  const nameEl=document.getElementById('sl-name');if(nameEl){nameEl.value=state.display.nameSize;document.getElementById('val-name').textContent=state.display.nameSize+'px';}
  const colorEl=document.getElementById('nameColorPicker');if(colorEl){colorEl.value=state.display.nameColor;document.getElementById('nameColorSwatch').style.background=state.display.nameColor;document.getElementById('nameColorVal').textContent=state.display.nameColor;}
}

// =====================
//  REFRESH RATE
// =====================
let autoRefreshTimer=null;
function setRefreshRate(r){
  state.refreshRate=r;
  document.querySelectorAll('.rate-pill').forEach(p=>p.classList.toggle('active',parseInt(p.dataset.rate)===r));
  const el=document.getElementById('rateStatus');
  if(el)el.textContent=r===0?'Auto-refresh: disabled':`Auto-refresh: every ${r<60?r+' seconds':r/60+' minute(s)'}`;
  startAutoRefresh();
  settingsSave(() => ss.set('ss_refresh_rate',String(r)));
}

function startAutoRefresh(){
  clearInterval(autoRefreshTimer);
  if(state.refreshRate>0)autoRefreshTimer=setInterval(fetchAllScores,state.refreshRate*1000);
}

// =====================
//  SETTINGS MODAL
// =====================
// =====================
//  SETTINGS PAGE
// =====================
function openSettings(section='scoreboards'){
  document.getElementById('settingsPage').style.display='flex';
  document.body.style.overflow='hidden';
  updateSaveUI();
  initAutoSaveToggle();
  switchSection(section);
}

function closeSettings(){
  if(_dirty) flushSave();
  document.getElementById('settingsPage').style.display='none';
  document.body.style.overflow='';
  // Always return to All Sports view when closing settings
  selectSidebarScoreboard('__all__');
}

function switchSection(section){
  document.querySelectorAll('.snav-btn').forEach(b=>b.classList.toggle('active',b.dataset.section===section));
  document.querySelectorAll('.settings-section').forEach(s=>s.classList.remove('active'));
  const panel=document.getElementById(`section-${section}`);
  if(panel) panel.classList.add('active');
  // Section-specific init
  if(section==='scoreboards') loadScoreboards();
  if(section==='sports') buildSportsTab();
  if(section==='teams'){buildTbTabs();loadTbSport(tbState.activeSport||getSPORTS()[0]?.id);}
  if(section==='dispatcharr') initDsTab();
  if(section==='ncaa') initNcaaSection();
}

// Legacy compat ‚Äî old tab references
function switchTab(tab){ switchSection(tab==='display'?'display':tab==='data'?'display':tab); }
function handleModalOverlay(e){}

// =====================
//  SPORTS SETTINGS TAB
// =====================
function buildSportsTab(){
  ['pro','ncaam','ncaaw'].forEach(group=>{
    const suffix=group==='pro'?'pro':group==='ncaam'?'ncaam':'ncaaw';
    const c=document.getElementById(`sg-${suffix}`);if(!c)return;c.innerHTML='';
    ALL_SPORTS.filter(s=>s.group===group).forEach(sport=>{
      const on=state.enabledSports.has(sport.id);
      const row=document.createElement('div');
      row.className=`sport-setting-row${on?' enabled':''}`;
      row.innerHTML=`
        <div class="sport-setting-info">
          <div style="width:8px;height:8px;border-radius:2px;background:${sport.color}"></div>
          <span class="sport-setting-name">${sport.emoji} ${sport.name}</span>
        </div>
        <div class="small-toggle${on?' on':''}" id="ss-toggle-${sport.id}" onclick="toggleSportEnabled('${sport.id}',this)"></div>`;
      c.appendChild(row);
    });
  });
}

function toggleSportEnabled(id,toggleEl){
  if(state.enabledSports.has(id)){
    state.enabledSports.delete(id);
    // Also remove from activeSports when disabled in settings
    state.activeSports.delete(id);
  } else {
    state.enabledSports.add(id);
    // Auto-activate when enabled in settings
    state.activeSports.add(id);
  }
  const on=state.enabledSports.has(id);
  toggleEl.classList.toggle('on',on);
  toggleEl.closest('.sport-setting-row').classList.toggle('enabled',on);
  settingsSave(saveEnabledSports);
  settingsSave(saveActiveSports);
  buildSportToggles();
  if(state.showEnded) buildEndedLeagueToggles();
  renderScoreboard();
}

// =====================
//  ESPN API
// =====================
function buildHistoricalUrl(sport,daysAgo){
  const d=new Date();d.setDate(d.getDate()-daysAgo);
  return sport.url+`?dates=${d.toISOString().slice(0,10).replace(/-/g,'')}`;
}

function parseGame(ev,sport){
  const comp=ev.competitions?.[0],status=ev.status,statusType=status?.type?.name||'STATUS_SCHEDULED',periodDesc=status?.type?.shortDetail||'';
  const teams=(comp?.competitors||[]).map(c=>({
    abbr:c.team?.abbreviation||'???',name:c.team?.displayName||c.team?.name||'Unknown',
    score:c.score||'0',color:c.team?.color?`#${c.team.color}`:'#333',
    logo:c.team?.logo||null,homeAway:c.homeAway,winner:c.winner||false,
  }));
  let stats=[];
  try{stats=(comp?.leaders||[]).slice(0,3).map(l=>({label:l.abbreviation||l.name,value:l.leaders?.[0]?.displayValue||'‚Äì'}));}catch(e){}
  // Extract broadcast networks ‚Äî resolve to canonical names, collapse regionals to RSN
  const bcast=(comp?.broadcasts||[]);
  const allNames=[...new Set(
    bcast.filter(b=>b.market==='national').flatMap(b=>b.names||[])
    .concat(bcast.filter(b=>b.market!=='national').flatMap(b=>b.names||[]))
  )];
  const resolvedLabels=[], seenLabels=new Set();
  let hasRSN=false;
  allNames.forEach(n=>{
    const r=resolveNetwork(n);
    if(r){
      if(!seenLabels.has(r.label)){seenLabels.add(r.label);resolvedLabels.push(r.label);}
    } else {
      hasRSN=true; // regional/local ‚Äî bucket as RSN
    }
  });
  // Show up to 2 resolved nationals, then RSN if any regionals exist and no nationals filled the slots
  if(hasRSN && resolvedLabels.length<2) resolvedLabels.push('RSN');
  const networks=resolvedLabels.slice(0,2);
  return{id:ev.id,sport:sport.id,sportName:sport.name,sportColor:sport.color,sportEmoji:sport.emoji,
    name:ev.name||'',date:ev.date,statusType,periodDesc,teams,stats,networks,
    isLive:statusType==='STATUS_IN_PROGRESS',isFinal:statusType==='STATUS_FINAL',isScheduled:statusType==='STATUS_SCHEDULED'};
}

function getSeasonMeta(t,n){
  const m={1:{key:'pre',label:n||'Preseason',isOff:false},2:{key:'reg',label:'Regular Season',isOff:false},3:{key:'post',label:'Postseason',isOff:false},4:{key:'off',label:'Off Season',isOff:true}};
  return m[t]||{key:'reg',label:'',isOff:false};
}

const MOCK={
  nfl:[],
  nba:[
    {id:'b1',sport:'nba',sportName:'NBA',sportColor:'#c9082a',sportEmoji:'üèÄ',isLive:true,isFinal:false,isScheduled:false,periodDesc:'Q4 2:15',date:new Date().toISOString(),stats:[],teams:[{abbr:'LAL',name:'Los Angeles Lakers',score:'108',color:'#552583',logo:null,homeAway:'away',winner:false},{abbr:'BOS',name:'Boston Celtics',score:'112',color:'#007A33',logo:null,homeAway:'home',winner:false}]},
    {id:'b2',sport:'nba',sportName:'NBA',sportColor:'#c9082a',sportEmoji:'üèÄ',isLive:false,isFinal:false,isScheduled:true,periodDesc:'',date:new Date(Date.now()+7200000).toISOString(),stats:[],teams:[{abbr:'GSW',name:'Golden State Warriors',score:'0',color:'#1D428A',logo:null,homeAway:'away',winner:false},{abbr:'MIA',name:'Miami Heat',score:'0',color:'#98002E',logo:null,homeAway:'home',winner:false}]},
  ],
  mlb:[
    {id:'m1',sport:'mlb',sportName:'MLB',sportColor:'#002d72',sportEmoji:'‚öæ',isLive:false,isFinal:true,isScheduled:false,periodDesc:'Final',date:new Date(Date.now()-86400000).toISOString(),stats:[],teams:[{abbr:'NYY',name:'New York Yankees',score:'5',color:'#003087',logo:null,homeAway:'away',winner:true},{abbr:'BOS',name:'Boston Red Sox',score:'3',color:'#BD3039',logo:null,homeAway:'home',winner:false}]},
  ],
  nhl:[
    {id:'h1',sport:'nhl',sportName:'NHL',sportColor:'#00b7e0',sportEmoji:'üèí',isLive:true,isFinal:false,isScheduled:false,periodDesc:'3rd 4:30',date:new Date().toISOString(),stats:[],teams:[{abbr:'TOR',name:'Toronto Maple Leafs',score:'2',color:'#00205B',logo:null,homeAway:'away',winner:false},{abbr:'MTL',name:'Montreal Canadiens',score:'3',color:'#AF1E2D',logo:null,homeAway:'home',winner:false}]},
  ],
  ncaamb:[{id:'cb1',sport:'ncaamb',sportName:"NCAA Men's Basketball",sportColor:'#ff6600',sportEmoji:'üèÄ',isLive:false,isFinal:true,isScheduled:false,periodDesc:'Final',date:new Date(Date.now()-86400000).toISOString(),stats:[],teams:[{abbr:'TEX',name:'Texas Longhorns',score:'78',color:'#BF5700',logo:null,homeAway:'away',winner:true},{abbr:'KU',name:'Kansas Jayhawks',score:'71',color:'#0051A5',logo:null,homeAway:'home',winner:false}]}],
  ncaawb:[],ncaabase:[],ncaasb:[],ncaafb:[],
};

async function fetchSport(sport){
  try{
    const ctrl=new AbortController();setTimeout(()=>ctrl.abort(),7000);
    const res=await fetch(sport.url,{signal:ctrl.signal});
    if(!res.ok)throw new Error();
    const data=await res.json();
    const sType=data.season?.type||data.leagues?.[0]?.season?.type||2;
    const sName=data.season?.displayName||data.leagues?.[0]?.season?.displayName||'';
    state.seasonMeta[sport.id]=getSeasonMeta(sType,sName);
    let games=(data.events||[]).map(ev=>parseGame(ev,sport));
    // Date-aware off-season override: if ESPN returns a future schedule with no
    // live, final, or near-term games (within 14 days), treat as off-season.
    if(games.length>0){
      const now=Date.now();
      const fourteenDaysFromNow=now+(14*24*60*60*1000);
      const hasCurrentActivity=games.some(g=>
        g.isLive ||
        g.isFinal ||
        new Date(g.date).getTime()<=fourteenDaysFromNow
      );
      if(!hasCurrentActivity){
        state.seasonMeta[sport.id]={key:'off',label:'Off Season',isOff:true};
        games=[];
      }
    }
    const sportDays=state.daysPerSport[sport.id]||1;
    if(state.showEnded&&state.endedLeagues.has(sport.id)&&sportDays>0){
      const fetches=[];
      for(let i=1;i<=sportDays;i++)fetches.push(fetch(buildHistoricalUrl(sport,i)).then(r=>r.ok?r.json():null).catch(()=>null));
      const results=await Promise.all(fetches);
      results.forEach(d=>{if(!d)return;(d.events||[]).forEach(ev=>{const g=parseGame(ev,sport);if(g.isFinal&&!games.find(x=>x.id===g.id))games.push(g);});});
    }
    // Custom scoreboard finals: fetch based on per-sport display_config.finals
    if(_activeFinalsCfg && _activeFinalsCfg[sport.id]?.show){
      const days=_activeFinalsCfg[sport.id].days||1;
      const fetches=[];
      for(let i=1;i<=days;i++)fetches.push(fetch(buildHistoricalUrl(sport,i)).then(r=>r.ok?r.json():null).catch(()=>null));
      const results=await Promise.all(fetches);
      results.forEach(d=>{if(!d)return;(d.events||[]).forEach(ev=>{const g=parseGame(ev,sport);if(g.isFinal&&!games.find(x=>x.id===g.id))games.push(g);});});
    }
    games.sort((a,b)=>(a.isLive?0:a.isScheduled?1:2)-(b.isLive?0:b.isScheduled?1:2));
    state.games[sport.id]=games;state.usingMock=false;
  }catch(e){
    console.info(`[${sport.name}] using demo data`);
    state.games[sport.id]=(MOCK[sport.id]||[]).map(g=>({...g}));
    const ms={nfl:4,nba:2,mlb:2,nhl:2,ncaamb:3,ncaawb:2,ncaabase:1,ncaasb:1,ncaafb:4};
    const mn={nfl:'Off Season',nba:'Regular Season',mlb:'Regular Season',nhl:'Regular Season',ncaamb:'Postseason',ncaawb:'Regular Season',ncaabase:'',ncaasb:'',ncaafb:'Off Season'};
    state.seasonMeta[sport.id]=getSeasonMeta(ms[sport.id]||2,mn[sport.id]||'');
    state.usingMock=true;
  }
  const el=document.getElementById(`count-${sport.id}`);if(el)el.textContent=state.games[sport.id].length;
}

async function fetchAllScores(){
  const btn=document.getElementById('refreshBtn');
  if(btn){btn.innerHTML='‚Üª Fetching...';btn.style.opacity='0.6';}
  // Skip loading skeleton in stream mode ‚Äî it wipes the stream canvas causing flicker
  if(!document.body.classList.contains('stream-mode')) showLoadingState();
  // In stream mode: also refresh scoreboard config to pick up saved settings changes
  if(document.body.classList.contains('stream-mode') && _activeStreamSlug) {
    await refreshStreamConfig();
  }
  await Promise.all(getAllEnabledSports().map(s=>fetchSport(s)));
  refreshSportToggles();updateTopbar();renderScoreboard();
  const el=document.getElementById('lastUpdate');
  if(el)el.textContent=`Updated: ${new Date().toLocaleTimeString()}${state.usingMock?' (demo)':''}`;
  if(btn){btn.innerHTML='<span>‚Üª</span> Refresh Scores';btn.style.opacity='1';}
}

// =====================
//  RENDER
// =====================
function showLoadingState(){const sb=document.getElementById('scoreboard');if(sb)sb.innerHTML=Array(4).fill('<div class="loading-skeleton"></div>').join('');}

function updateTopbar(){
  let live=0,total=0;
  getSPORTS().forEach(s=>{const g=state.games[s.id]||[];live+=g.filter(x=>x.isLive).length;total+=g.length;});
  const lc=document.getElementById('liveCount'),tc=document.getElementById('totalCount');
  if(lc)lc.textContent=live;if(tc)tc.textContent=total;
}

function renderScoreboard(){
  // Stream mode: do in-place updates instead of full re-render
  if(document.body.classList.contains('stream-mode')){
    if(document.getElementById('stream-canvas')){
      updateStreamScoresInPlace();
    } else {
      // Canvas not yet initialized ‚Äî run full init
      initStreamCanvas();
    }
    return;
  }
  const sb=document.getElementById('scoreboard');if(!sb)return;sb.innerHTML='';
  const hasFavs=state.favTeams.size>0;
  const favsOnly=state.filterMode==='favorites';
  const sports=getSPORTS();

  if(hasFavs&&!favsOnly){
    const pinned=[];
    sports.forEach(sport=>{
      if(!state.enabledSports.has(sport.id))return;
      (state.games[sport.id]||[]).forEach(g=>{
        if(g.isFinal&&(!state.showEnded||!state.endedLeagues.has(sport.id)))return;
        if(g.isFinal&&state.endedFilter[sport.id]==='favs-only'&&!isGameFavorited(g))return;
        if(isGameFavorited(g))pinned.push(g);
      });
    });
    if(pinned.length){
      const sec=document.createElement('div');sec.className='pinned-section';
      sec.innerHTML=`<div class="pinned-header"><div class="pinned-stripe"></div><div class="pinned-title">‚≠ê My Teams</div><div class="pinned-count">${pinned.length} game${pinned.length!==1?'s':''}</div><button onclick="clearAllFavTeams()" title="Clear all favorited teams" style="margin-left:auto;background:none;border:1px solid var(--border);border-radius:12px;color:var(--text-dim);font-size:10px;font-family:'Share Tech Mono',monospace;padding:2px 8px;cursor:pointer;letter-spacing:0.5px;">‚úï Clear All</button></div>`;
      const grid=document.createElement('div');grid.className=`games-grid ${state.layout}-mode`;
      pinned.forEach(g=>grid.appendChild(buildGameCard(g)));sec.appendChild(grid);sb.appendChild(sec);
    }
  }

  let anyGame=false;
  sports.forEach(sport=>{
    const season=state.seasonMeta[sport.id];
    let games=state.games[sport.id]||[];
    if(season?.isOff&&games.length===0)return;
    // Team filter: if a custom scoreboard has team_config, apply per-sport filter
    if(_activeTeamConfig){
      const sportTeams=_activeTeamConfig[sport.id];
      if(sportTeams&&sportTeams.length)
        games=games.filter(g=>g.teams.some(t=>sportTeams.includes(t.name)||sportTeams.includes(t.abbr)));
    }
    if(state.filterMode==='live')games=games.filter(g=>g.isLive);
    else if(favsOnly)games=games.filter(g=>isGameFavorited(g));
    if(!state.showEnded||!state.endedLeagues.has(sport.id))games=games.filter(g=>!g.isFinal);
    else{
      const ef=state.endedFilter[sport.id]||'all';
      if(ef==='favs-only'&&hasFavs)games=games.filter(g=>!g.isFinal||isGameFavorited(g));
      else if(ef==='favs-first'&&hasFavs){
        const ff=games.filter(g=>g.isFinal&&isGameFavorited(g)),nff=games.filter(g=>g.isFinal&&!isGameFavorited(g)),nf=games.filter(g=>!g.isFinal);
        games=[...nf,...ff,...nff];
      }
    }
    const liveUpcomingGames = games.filter(g => !g.isFinal);
    const customFinalGames = _activeFinalsCfg && _activeFinalsCfg[sport.id]?.show
      ? (state.games[sport.id]||[]).filter(g => g.isFinal)
      : [];

    if(!liveUpcomingGames.length && !customFinalGames.length)return;
    if(liveUpcomingGames.length) anyGame=true;
    // Render live/upcoming section
    if(liveUpcomingGames.length){
      let sbadge='';
      if(season&&season.key!=='reg')sbadge=`<span class="league-season-badge ${season.key}">${season.label}</span>`;
      const sec=document.createElement('div');sec.className='league-section';
      sec.innerHTML=`<div class="league-header"><div class="league-stripe" style="background:${sport.color}"></div><div class="league-name">${sport.emoji} ${sport.name}</div>${sbadge}<div class="league-game-count">${liveUpcomingGames.length} game${liveUpcomingGames.length!==1?'s':''}</div></div>`;
      const grid=document.createElement('div');grid.className=`games-grid ${state.layout}-mode`;
      liveUpcomingGames.forEach(g=>grid.appendChild(buildGameCard(g)));sec.appendChild(grid);sb.appendChild(sec);
    }

    // Render finals sections for custom scoreboard ‚Äî grouped by date
    if(customFinalGames.length){
      anyGame=true;
      // Group by date
      const byDate={};
      customFinalGames.forEach(g=>{
        const d=g.date?new Date(g.date).toLocaleDateString('en-CA'):'unknown';
        if(!byDate[d])byDate[d]=[];
        byDate[d].push(g);
      });
      Object.keys(byDate).sort((a,b)=>b.localeCompare(a)).forEach(dateKey=>{
        const dGames=byDate[dateKey];
        const dateLabel=dateKey!=='unknown'?' ¬∑ '+new Date(dateKey+'T12:00:00').toLocaleDateString([],{month:'short',day:'numeric',year:'numeric'}):'';
        const finSec=document.createElement('div');finSec.className='league-section';
        finSec.innerHTML=`<div class="league-header"><div class="league-stripe" style="background:#ffb400"></div><div class="league-name">${sport.emoji} ${sport.name} ‚Äî Finals${dateLabel}</div><div class="league-game-count">${dGames.length} game${dGames.length!==1?'s':''}</div></div>`;
        const finGrid=document.createElement('div');finGrid.className=`games-grid ${state.layout}-mode`;
        dGames.forEach(g=>finGrid.appendChild(buildGameCard(g)));finSec.appendChild(finGrid);sb.appendChild(finSec);
      });
    }
  });

  if(!anyGame&&!sb.querySelector('.pinned-section')){
    sb.innerHTML=`<div class="empty-state"><div class="empty-icon">${favsOnly?'‚≠ê':'üì∫'}</div><div class="empty-text">${favsOnly?'No favorites playing':'No games to show'}</div><div style="font-size:12px;color:var(--text-dim);margin-top:8px;">${favsOnly?'Star a team or league, or switch to All':state.filterMode==='live'?'No live games right now':'Enable sports in Settings or turn on Ended Games'}</div></div>`;
  }
}

function buildGameCard(g){return state.layout==='ticker'?buildTickerCard(g):buildFullCard(g);}

function buildTickerCard(g){
  const card=document.createElement('div');card.className=`game-card${g.isLive?' live':''}${g.isFinal?' is-final':''}`;
  const away=g.teams.find(t=>t.homeAway==='away')||g.teams[0],home=g.teams.find(t=>t.homeAway==='home')||g.teams[1];
  const finalDate = g.isFinal && g.date ? formatDate(g.date) : '';
  const sh=g.isLive?`<div class="status-live"><div class="status-live-dot"></div>${g.periodDesc}</div>`:g.isFinal?`<span class="status-final">FINAL${finalDate?' ¬∑ '+finalDate:''}</span>`:`<span class="status-upcoming">${formatTime(g.date)}</span>`;
  card.innerHTML=`<div class="ticker-row"><div style="width:6px;height:18px;border-radius:2px;background:${g.sportColor};flex-shrink:0"></div><div class="ticker-teams">${away?.abbr||'‚Äì'} vs ${home?.abbr||'‚Äì'}</div><div class="ticker-score">${away?.score??'‚Äì'} ‚Äì ${home?.score??'‚Äì'}</div>${buildNetworkBadges(g.networks)}<div class="ticker-period">${sh}</div></div>`;
  return card;
}

function buildFullCard(g){
  const card=document.createElement('div'),favd=isGameFavorited(g);
  card.className=`game-card${g.isLive?' live':''}${g.isFinal?' is-final':''}${favd?' favorited':''}`;
  const away=g.teams.find(t=>t.homeAway==='away')||g.teams[0],home=g.teams.find(t=>t.homeAway==='home')||g.teams[1];
  const as=parseInt(away?.score||0),hs=parseInt(home?.score||0);
  const aw=g.isFinal&&as>hs,hw=g.isFinal&&hs>as;
  const af=away&&(state.favTeams.has(away.name)||state.favTeams.has(away.abbr));
  const hf=home&&(state.favTeams.has(home.name)||state.favTeams.has(home.abbr));
  const an=(away?.name||'').replace(/'/g,"\\'"),hn=(home?.name||'').replace(/'/g,"\\'");
  const sh=g.isLive?`<div class="status-live"><div class="status-live-dot"></div>${g.periodDesc}</div>`:g.isFinal?'<span class="status-final">FINAL</span>':`<span class="status-upcoming">${formatTime(g.date)}</span>`;
  card.innerHTML=`
    <div class="card-status">${sh}${buildNetworkBadges(g.networks)}<span class="game-period" style="color:${g.sportColor}">${g.sportEmoji} ${g.sportName}</span></div>
    <div class="card-body">
      <div class="teams-container">
        <div class="team-row${aw?' winning':g.isFinal?' losing':''}">
          ${teamLogo(away)}
          <div class="team-name-block"><div class="team-abbr">${away?.abbr||'‚Äì'}</div><div class="team-full-name">${away?.name||''} ¬∑ Away</div></div>
          <button class="star-btn ${af?'starred':''}" onclick="toggleFavTeam('${an}')">‚≠ê</button>
          <div class="team-score">${g.isScheduled?'‚Äì':away?.score??'‚Äì'}</div>
        </div>
        <div style="height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:2px 0;"></div>
        <div class="team-row${hw?' winning':g.isFinal?' losing':''}">
          ${teamLogo(home)}
          <div class="team-name-block"><div class="team-abbr">${home?.abbr||'‚Äì'}</div><div class="team-full-name">${home?.name||''} ¬∑ Home</div></div>
          <button class="star-btn ${hf?'starred':''}" onclick="toggleFavTeam('${hn}')">‚≠ê</button>
          <div class="team-score">${g.isScheduled?'‚Äì':home?.score??'‚Äì'}</div>
        </div>
      </div>
      ${buildStats(g)}
    </div>`;
  return card;
}

// Network families ‚Äî maps any variant to a canonical display name + CSS class
// Anything not matched gets bucketed as RSN (regional sports network)
const NETWORK_FAMILIES=[
  {match:/^ESPN\+/i,        label:'ESPN+',    cls:'espnplus'},
  {match:/^ESPN2$/i,        label:'ESPN2',    cls:'espn2'},
  {match:/^ESPNU$/i,        label:'ESPNU',    cls:'espn'},
  {match:/^ESPN$/i,         label:'ESPN',     cls:'espn'},
  {match:/^espn/i,          label:'ESPN',     cls:'espn'},
  {match:/^ABC$/i,          label:'ABC',      cls:'abc'},
  {match:/^NBC$/i,          label:'NBC',      cls:'nbc'},
  {match:/^NBC Sports/i,    label:'NBC',      cls:'nbc'},
  {match:/^Peacock/i,       label:'Peacock',  cls:'peacock'},
  {match:/^CBS$/i,          label:'CBS',      cls:'cbs'},
  {match:/CBS Sports/i,     label:'CBSSN',    cls:'cbs'},
  {match:/^Paramount/i,     label:'CBS',      cls:'cbs'},
  {match:/^FOX$/i,          label:'FOX',      cls:'fox'},
  {match:/^Fox/i,         label:'FOX',      cls:'fox'},
  {match:/^FS1$/i,          label:'FS1',      cls:'fs1'},
  {match:/^FS2$/i,          label:'FS2',      cls:'fs2'},
  {match:/^TNT$/i,          label:'TNT',      cls:'tnt'},
  {match:/^TBS$/i,          label:'TBS',      cls:'tbs'},
  {match:/^truTV$/i,        label:'truTV',    cls:'tnt'},
  {match:/^NBA TV$/i,       label:'NBA TV',   cls:'nbatv'},
  {match:/^NBA League Pass/i,label:'League Pass',cls:'nbatv'},
  {match:/^MLB\.?TV$/i,     label:'MLB.TV',   cls:'mlbtv'},
  {match:/^MLB Net/i,       label:'MLB Net',  cls:'mlbtv'},
  {match:/^MLBN$/i,         label:'MLB Net',  cls:'mlbtv'},
  {match:/^NHL\.?TV$/i,     label:'NHL.TV',   cls:'nhltv'},
  {match:/^NFL Network/i,   label:'NFL Net',  cls:'nfln'},
  {match:/^Victory\+/i,     label:'Victory+', cls:'default'},
  {match:/^Gray Media/i,    label:'Local TV',  cls:'local'},
  {match:/^Arizona.s Family/i, label:'Local TV', cls:'local'},
  {match:/^Prime/i,         label:'Prime',    cls:'default'},
  {match:/^Apple TV/i,      label:'Apple TV', cls:'default'},
  {match:/^Max$/i,          label:'Max',      cls:'default'},
  {match:/^SEC Network/i,   label:'SEC Net',  cls:'espn'},
  {match:/^ACC Network/i,   label:'ACC Net',  cls:'espn'},
  {match:/^Big Ten/i,       label:'BTN',      cls:'default'},
  {match:/^BTN$/i,          label:'BTN',      cls:'default'},
  {match:/^TSN/i,           label:'TSN',      cls:'default'},
  {match:/^Sportsnet/i,     label:'SN',       cls:'default'},
];

function resolveNetwork(name){
  for(const f of NETWORK_FAMILIES){
    if(f.match.test(name)) return {label:f.label, cls:'nb-'+f.cls};
  }
  return null; // regional/local ‚Äî will be bucketed as RSN
}

function networkClass(name){
  return resolveNetwork(name)?.cls || 'nb-default';
}
function buildNetworkBadges(networks){
  if(!networks||!networks.length)return'';
  return'<div class="network-badges">'+networks.map(n=>{
    // networks array contains resolved labels ‚Äî look up class by label
    const cls = resolveNetwork(n)?.cls || (n==='RSN'?'nb-rsn':'nb-default');
    return `<span class="network-badge ${cls}">${n}</span>`;
  }).join('')+'</div>';
}

function teamLogo(team){
  if(!team)return'';
  const bg=team.color||'#1a2a3a',text=(team.abbr||'?').substring(0,3);
  if(team.logo)return`<div class="team-logo-placeholder" style="background:#${bg.replace('#','')};padding:3px"><img src="${team.logo}" style="width:100%;height:100%;object-fit:contain;border-radius:4px" onerror="this.parentNode.textContent='${text}'"></div>`;
  return`<div class="team-logo-placeholder" style="background:#${bg.replace('#','')};color:white">${text}</div>`;
}

function buildStats(g){
  if(state.statsDepth==='basic'||!g.stats?.length)return'';
  const cells=g.stats.map(s=>`<div class="stat-cell"><span class="stat-val">${s.value}</span><span class="stat-lbl">${s.label}</span></div>`).join('');
  return cells?`<div class="stats-bar">${cells}</div>`:'';
}

function formatTime(d){if(!d)return'TBD';try{return new Date(d).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}catch(e){return'TBD';}}
function formatDate(d){if(!d)return'';try{const dt=new Date(d);const today=new Date();const yesterday=new Date(today);yesterday.setDate(today.getDate()-1);if(dt.toDateString()===today.toDateString())return'Today';if(dt.toDateString()===yesterday.toDateString())return'Yesterday';return dt.toLocaleDateString([],{month:'short',day:'numeric'});}catch(e){return '';}}

// =====================
//  TEAM BROWSER
// =====================
const TEAM_URLS={
  nfl:'https://site.api.espn.com/apis/site/v2/sports/football/nfl/teams?limit=50',
  nba:'https://site.api.espn.com/apis/site/v2/sports/basketball/nba/teams?limit=50',
  mlb:'https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams?limit=50',
  nhl:'https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/teams?limit=50',
  ncaamb:'https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/teams?limit=200',
  ncaawb:'https://site.api.espn.com/apis/site/v2/sports/basketball/womens-college-basketball/teams?limit=200',
  ncaabase:'https://site.api.espn.com/apis/site/v2/sports/baseball/college-baseball/teams?limit=200',
  ncaasb:'https://site.api.espn.com/apis/site/v2/sports/baseball/college-softball/teams?limit=200',
  ncaafb:'https://site.api.espn.com/apis/site/v2/sports/football/college-football/teams?limit=200',
};

// Static fallback for major pro teams
const MOCK_TEAMS={
  nfl:[{abbr:'ARI',name:'Arizona Cardinals',color:'97233F'},{abbr:'ATL',name:'Atlanta Falcons',color:'A71930'},{abbr:'BAL',name:'Baltimore Ravens',color:'241773'},{abbr:'BUF',name:'Buffalo Bills',color:'00338D'},{abbr:'CAR',name:'Carolina Panthers',color:'0085CA'},{abbr:'CHI',name:'Chicago Bears',color:'0B162A'},{abbr:'CIN',name:'Cincinnati Bengals',color:'FB4F14'},{abbr:'CLE',name:'Cleveland Browns',color:'311D00'},{abbr:'DAL',name:'Dallas Cowboys',color:'003594'},{abbr:'DEN',name:'Denver Broncos',color:'FB4F14'},{abbr:'DET',name:'Detroit Lions',color:'0076B6'},{abbr:'GB',name:'Green Bay Packers',color:'203731'},{abbr:'HOU',name:'Houston Texans',color:'03202F'},{abbr:'IND',name:'Indianapolis Colts',color:'002C5F'},{abbr:'JAX',name:'Jacksonville Jaguars',color:'006778'},{abbr:'KC',name:'Kansas City Chiefs',color:'E31837'},{abbr:'LAC',name:'Los Angeles Chargers',color:'0080C6'},{abbr:'LAR',name:'Los Angeles Rams',color:'003594'},{abbr:'LV',name:'Las Vegas Raiders',color:'000000'},{abbr:'MIA',name:'Miami Dolphins',color:'008E97'},{abbr:'MIN',name:'Minnesota Vikings',color:'4F2683'},{abbr:'NE',name:'New England Patriots',color:'002244'},{abbr:'NO',name:'New Orleans Saints',color:'D3BC8D'},{abbr:'NYG',name:'New York Giants',color:'0B2265'},{abbr:'NYJ',name:'New York Jets',color:'125740'},{abbr:'PHI',name:'Philadelphia Eagles',color:'004C54'},{abbr:'PIT',name:'Pittsburgh Steelers',color:'FFB612'},{abbr:'SEA',name:'Seattle Seahawks',color:'002244'},{abbr:'SF',name:'San Francisco 49ers',color:'AA0000'},{abbr:'TB',name:'Tampa Bay Buccaneers',color:'D50A0A'},{abbr:'TEN',name:'Tennessee Titans',color:'0C2340'},{abbr:'WSH',name:'Washington Commanders',color:'5A1414'}],
  nba:[{abbr:'ATL',name:'Atlanta Hawks',color:'E03A3E'},{abbr:'BOS',name:'Boston Celtics',color:'007A33'},{abbr:'BKN',name:'Brooklyn Nets',color:'000000'},{abbr:'CHA',name:'Charlotte Hornets',color:'1D1160'},{abbr:'CHI',name:'Chicago Bulls',color:'CE1141'},{abbr:'CLE',name:'Cleveland Cavaliers',color:'860038'},{abbr:'DAL',name:'Dallas Mavericks',color:'00538C'},{abbr:'DEN',name:'Denver Nuggets',color:'0E2240'},{abbr:'DET',name:'Detroit Pistons',color:'C8102E'},{abbr:'GSW',name:'Golden State Warriors',color:'1D428A'},{abbr:'HOU',name:'Houston Rockets',color:'CE1141'},{abbr:'IND',name:'Indiana Pacers',color:'002D62'},{abbr:'LAC',name:'LA Clippers',color:'C8102E'},{abbr:'LAL',name:'Los Angeles Lakers',color:'552583'},{abbr:'MEM',name:'Memphis Grizzlies',color:'5D76A9'},{abbr:'MIA',name:'Miami Heat',color:'98002E'},{abbr:'MIL',name:'Milwaukee Bucks',color:'00471B'},{abbr:'MIN',name:'Minnesota Timberwolves',color:'0C2340'},{abbr:'NOP',name:'New Orleans Pelicans',color:'0C2340'},{abbr:'NYK',name:'New York Knicks',color:'006BB6'},{abbr:'OKC',name:'Oklahoma City Thunder',color:'007AC1'},{abbr:'ORL',name:'Orlando Magic',color:'0077C0'},{abbr:'PHI',name:'Philadelphia 76ers',color:'006BB6'},{abbr:'PHX',name:'Phoenix Suns',color:'1D1160'},{abbr:'POR',name:'Portland Trail Blazers',color:'E03A3E'},{abbr:'SAC',name:'Sacramento Kings',color:'5A2D81'},{abbr:'SAS',name:'San Antonio Spurs',color:'C4CED4'},{abbr:'TOR',name:'Toronto Raptors',color:'CE1141'},{abbr:'UTA',name:'Utah Jazz',color:'002B5C'},{abbr:'WAS',name:'Washington Wizards',color:'002B5C'}],
  mlb:[{abbr:'ARI',name:'Arizona Diamondbacks',color:'A71930'},{abbr:'ATL',name:'Atlanta Braves',color:'CE1141'},{abbr:'BAL',name:'Baltimore Orioles',color:'DF4601'},{abbr:'BOS',name:'Boston Red Sox',color:'BD3039'},{abbr:'CHC',name:'Chicago Cubs',color:'0E3386'},{abbr:'CWS',name:'Chicago White Sox',color:'27251F'},{abbr:'CIN',name:'Cincinnati Reds',color:'C6011F'},{abbr:'CLE',name:'Cleveland Guardians',color:'00385D'},{abbr:'COL',name:'Colorado Rockies',color:'33006F'},{abbr:'DET',name:'Detroit Tigers',color:'0C2340'},{abbr:'HOU',name:'Houston Astros',color:'002D62'},{abbr:'KC',name:'Kansas City Royals',color:'004687'},{abbr:'LAA',name:'Los Angeles Angels',color:'BA0021'},{abbr:'LAD',name:'Los Angeles Dodgers',color:'005A9C'},{abbr:'MIA',name:'Miami Marlins',color:'00A3E0'},{abbr:'MIL',name:'Milwaukee Brewers',color:'FFC52F'},{abbr:'MIN',name:'Minnesota Twins',color:'002B5C'},{abbr:'NYM',name:'New York Mets',color:'002D72'},{abbr:'NYY',name:'New York Yankees',color:'003087'},{abbr:'OAK',name:'Oakland Athletics',color:'003831'},{abbr:'PHI',name:'Philadelphia Phillies',color:'E81828'},{abbr:'PIT',name:'Pittsburgh Pirates',color:'27251F'},{abbr:'SD',name:'San Diego Padres',color:'2F241D'},{abbr:'SF',name:'San Francisco Giants',color:'FD5A1E'},{abbr:'SEA',name:'Seattle Mariners',color:'0C2C56'},{abbr:'STL',name:'St. Louis Cardinals',color:'C41E3A'},{abbr:'TB',name:'Tampa Bay Rays',color:'092C5C'},{abbr:'TEX',name:'Texas Rangers',color:'003278'},{abbr:'TOR',name:'Toronto Blue Jays',color:'134A8E'},{abbr:'WSH',name:'Washington Nationals',color:'AB0003'}],
  nhl:[{abbr:'ANA',name:'Anaheim Ducks',color:'F47A38'},{abbr:'BOS',name:'Boston Bruins',color:'FCB514'},{abbr:'BUF',name:'Buffalo Sabres',color:'002654'},{abbr:'CGY',name:'Calgary Flames',color:'C8102E'},{abbr:'CAR',name:'Carolina Hurricanes',color:'CC0000'},{abbr:'CHI',name:'Chicago Blackhawks',color:'CF0A2C'},{abbr:'COL',name:'Colorado Avalanche',color:'6F263D'},{abbr:'CBJ',name:'Columbus Blue Jackets',color:'002654'},{abbr:'DAL',name:'Dallas Stars',color:'006847'},{abbr:'DET',name:'Detroit Red Wings',color:'CE1126'},{abbr:'EDM',name:'Edmonton Oilers',color:'FF4C00'},{abbr:'FLA',name:'Florida Panthers',color:'041E42'},{abbr:'LAK',name:'Los Angeles Kings',color:'111111'},{abbr:'MIN',name:'Minnesota Wild',color:'154734'},{abbr:'MTL',name:'Montreal Canadiens',color:'AF1E2D'},{abbr:'NSH',name:'Nashville Predators',color:'FFB81C'},{abbr:'NJD',name:'New Jersey Devils',color:'CE1126'},{abbr:'NYI',name:'New York Islanders',color:'00539B'},{abbr:'NYR',name:'New York Rangers',color:'0038A8'},{abbr:'OTT',name:'Ottawa Senators',color:'C2912C'},{abbr:'PHI',name:'Philadelphia Flyers',color:'F74902'},{abbr:'PIT',name:'Pittsburgh Penguins',color:'FCB514'},{abbr:'SJS',name:'San Jose Sharks',color:'006D75'},{abbr:'SEA',name:'Seattle Kraken',color:'001628'},{abbr:'STL',name:'St. Louis Blues',color:'002F87'},{abbr:'TBL',name:'Tampa Bay Lightning',color:'002868'},{abbr:'TOR',name:'Toronto Maple Leafs',color:'00205B'},{abbr:'VAN',name:'Vancouver Canucks',color:'00205B'},{abbr:'VGK',name:'Vegas Golden Knights',color:'B4975A'},{abbr:'WSH',name:'Washington Capitals',color:'041E42'},{abbr:'WPG',name:'Winnipeg Jets',color:'041E42'}],
  ncaamb:[],ncaawb:[],ncaabase:[],ncaasb:[],ncaafb:[],
};

const tbState={activeSport:'nfl',teamCache:{},searchQuery:'',labelMode:ss.get('ss_tb_label')||'abbr',divisionFilter:ss.get('ss_tb_div')||'d1'};

function setTbLabelMode(mode){
  tbState.labelMode=mode;
  ss.set('ss_tb_label',mode);
  // Update button styles
  const abbrBtn=document.getElementById('tbLabelAbbr');
  const nickBtn=document.getElementById('tbLabelNick');
  if(abbrBtn&&nickBtn){
    abbrBtn.style.background=mode==='abbr'?'rgba(0,212,255,0.15)':'transparent';
    abbrBtn.style.color=mode==='abbr'?'var(--accent)':'var(--text-dim)';
    nickBtn.style.background=mode==='nick'?'rgba(0,212,255,0.15)':'transparent';
    nickBtn.style.color=mode==='nick'?'var(--accent)':'var(--text-dim)';
  }
  const teams=tbState.teamCache[tbState.activeSport]||[];
  renderTbTeams(teams);
}

function setTbDivision(div){
  tbState.divisionFilter=div;
  ss.set('ss_tb_div', div);
  ['d1','d2','d3','all'].forEach(d=>{
    const btn=document.getElementById('tbDiv'+d.charAt(0).toUpperCase()+d.slice(1));
    if(!btn)return;
    const active=d===div;
    btn.style.background=active?'rgba(0,212,255,0.12)':'transparent';
    btn.style.borderColor=active?'var(--accent)':'var(--border)';
    btn.style.color=active?'var(--accent)':'var(--text-dim)';
  });
  // Reload from API with new division filter (server-side filtering)
  loadTbSport(tbState.activeSport);
}

// Enhanced search: checks abbr, name, AND all NCAA_NAMES fields (school, nick, short)
function teamMatchesQuery(team,query){
  const q=query.toLowerCase();
  if(team.abbr.toLowerCase().includes(q))return true;
  if(team.name.toLowerCase().includes(q))return true;
  if(team.shortName&&team.shortName.toLowerCase().includes(q))return true;
  if(team.nick&&team.nick.toLowerCase().includes(q))return true;
  if(team.school&&team.school.toLowerCase().includes(q))return true;
  if(team.short&&team.short.toLowerCase().includes(q))return true;
  return false;
}

function enrichTeam(abbr, espnName, color, logo){
  // Merge ESPN data with our NCAA_NAMES rich metadata (color+logo now come from DB)
  const extra=NCAA_NAMES[abbr.toUpperCase()];
  return {
    abbr,
    name:     espnName || abbr,
    school:   extra ? extra.school  : null,
    nick:     extra ? extra.nick    : null,
    short:    extra ? extra.short   : null,
    shortName:espnName || abbr,
    color:    color || (extra && extra.color) || '333333',
    logo:     logo  || (extra && extra.logo)  || null,
    division: extra ? (extra.division || 'unknown') : 'unknown',
  };
}

async function fetchTeamsForSport(sid){
  // For NCAA sports, use our DB API filtered by sport+division (server-side)
  if(sid.startsWith('ncaa')) return fetchNcaaTeams(sid, tbState.divisionFilter);
  // Pro sports: use cache then ESPN
  if(tbState.teamCache[sid]&&tbState.teamCache[sid].length>0)return tbState.teamCache[sid];
  try{
    const ctrl=new AbortController();setTimeout(()=>ctrl.abort(),8000);
    const res=await fetch(TEAM_URLS[sid],{signal:ctrl.signal});
    if(!res.ok)throw new Error('HTTP '+res.status);
    const data=await res.json();
    const raw=data.sports?.[0]?.leagues?.[0]?.teams||data.teams||[];
    const teams=raw.map(t=>{
      const team=t.team||t;
      const abbr=team.abbreviation||team.abbr||'??';
      const espnName=team.displayName||team.name||abbr;
      const color=team.color||team.alternateColor||'333333';
      const logo=team.logos?.[0]?.href||null;
      return enrichTeam(abbr, espnName, color, logo);
    }).sort((a,b)=>a.name.localeCompare(b.name));
    tbState.teamCache[sid]=teams;
    return teams;
  }catch(e){
    const teams=(MOCK_TEAMS[sid]||[]).map(t=>enrichTeam(t.abbr,t.name,t.color,null));
    tbState.teamCache[sid]=teams;
    return teams;
  }
}

async function fetchNcaaTeams(sid, division){
  // Cache key includes division so switching pills doesn't serve stale data
  const cacheKey = sid + '_' + (division||'all');
  if(tbState.teamCache[cacheKey] && tbState.teamCache[cacheKey].length>0) return tbState.teamCache[cacheKey];
  try{
    const div = (!division || division==='all') ? '' : '&division='+division;
    const ctrl=new AbortController();setTimeout(()=>ctrl.abort(),8000);
    const res=await fetch(`${API_BASE}/ncaa/programs?sport=${sid}${div}`,{signal:ctrl.signal});
    if(!res.ok)throw new Error('HTTP '+res.status);
    const data=await res.json();
    const programs=data.programs||[];
    if(!programs.length) throw new Error('empty');
    const teams=programs.map(p=>({
      abbr:      (p.espn_abbr||'').toUpperCase(),
      name:      p.display_name || p.full_name || p.espn_abbr,
      school:    p.full_name,
      nick:      p.nick,
      short:     p.short_name,
      shortName: p.short_name || p.display_name,
      color:     p.color || '333333',
      logo:      p.logo_url || null,
      division:  p.division || 'unknown',
      gender:    p.gender,
    })).sort((a,b)=>a.name.localeCompare(b.name));
    tbState.teamCache[cacheKey]=teams;
    return teams;
  }catch(e){
    // Fallback: filter NCAA_NAMES by sport, optionally by division
    console.warn('[NCAA] API fetch failed, using fallback:', e.message);
    const teams=Object.entries(NCAA_NAMES)
      .filter(([,v])=>v.sports && v.sports.includes(sid))
      .filter(([,v])=>!division || division==='all' || v.division===division)
      .map(([abbr,v])=>enrichTeam(abbr, (v.short||'')+' '+(v.nick||''), v.color||null, v.logo||null))
      .sort((a,b)=>a.name.localeCompare(b.name));
    tbState.teamCache[cacheKey]=teams;
    return teams;
  }
}

function buildTbTabs(){
  const c=document.getElementById('tbTabs');if(!c)return;c.innerHTML='';
  // Sync label mode button states
  setTbLabelMode(tbState.labelMode);
  getAllEnabledSports().forEach(sport=>{
    const tab=document.createElement('div');
    tab.style.cssText='padding:6px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:20px;font-family:Barlow Condensed,sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);cursor:pointer;white-space:nowrap;transition:all 0.15s;flex-shrink:0;';
    tab.textContent=`${sport.emoji} ${sport.name}`;
    if(sport.id===tbState.activeSport)tab.style.cssText+='background:rgba(0,212,255,0.12);border-color:var(--accent);color:var(--accent);';
    tab.onclick=()=>{
      tbState.searchQuery='';const si=document.getElementById('tbSearch');if(si)si.value='';
      document.getElementById('tbTabs').querySelectorAll('div').forEach(t=>t.style.cssText=t.style.cssText.replace('background:rgba(0,212,255,0.12);border-color:var(--accent);color:var(--accent);',''));
      tab.style.cssText+='background:rgba(0,212,255,0.12);border-color:var(--accent);color:var(--accent);';
      tbState.activeSport=sport.id;loadTbSport(sport.id);
    };
    c.appendChild(tab);
  });
}

async function loadTbSport(sid){
  const list=document.getElementById('tbTeamList');if(!list)return;
  list.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--text-dim);">Loading teams...</div>';
  tbState.activeSport=sid;
  // Show division pills only for NCAA sports
  const pills=document.getElementById('tbDivPills');
  if(pills) pills.style.display=sid.startsWith('ncaa')?'flex':'none';
  const teams=await fetchTeamsForSport(sid);
  renderTbTeams(teams);
}

function filterTeams(query){
  tbState.searchQuery=query;
  const sid=tbState.activeSport;
  // NCAA sports use a division-aware cache key (e.g. "ncaafb_d1"), pro sports use sport id only
  const cacheKey=sid.startsWith('ncaa') ? sid+'_'+(tbState.divisionFilter||'all') : sid;
  const teams=tbState.teamCache[cacheKey]||tbState.teamCache[sid]||[];
  renderTbTeams(teams);
}

function renderTbTeams(teams){
  const list=document.getElementById('tbTeamList');if(!list)return;
  const q=tbState.searchQuery;
  // Division filtering is now server-side (fetchNcaaTeams handles it)
  // Just apply search query client-side
  let filtered=q?teams.filter(t=>teamMatchesQuery(t,q)):teams;
  if(!filtered.length){list.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--text-dim);">No teams found for "${q}"</div>`;return;}
  list.innerHTML='';
  filtered.forEach(team=>{
    const starred=state.favTeams.has(team.name)||state.favTeams.has(team.abbr)||state.favTeams.has(team.shortName);
    const card=document.createElement('div');
    card.style.cssText=`display:flex;align-items:center;gap:10px;padding:8px 11px;background:var(--bg-card);border:1px solid ${starred?'rgba(255,215,0,0.4)':'var(--border)'};border-radius:8px;cursor:pointer;transition:all 0.15s;${starred?'background:rgba(255,215,0,0.05);':''}`;
    const logoHtml=team.logo?`<img src="${team.logo}" style="width:100%;height:100%;object-fit:contain;border-radius:4px" onerror="this.parentNode.textContent='${team.abbr}'">`:`<span style="font-family:Barlow Condensed,sans-serif;font-weight:900;font-size:9px;color:white;">${team.abbr}</span>`;
    // Label mode: abbr shows ESPN abbreviation as primary, nickname shows team nick as primary
    const useNick=tbState.labelMode==='nick';
    const primaryLabel=useNick?(team.nick||team.abbr):team.abbr;
    // Secondary line: show nickname or school if available, else fall back to name
    const secondaryLabel=useNick
      ?(team.school||team.name)
      :(team.nick?`${team.nick} ¬∑ ${team.short||team.name}`:team.name);
    card.innerHTML=`
      <div style="width:28px;height:28px;border-radius:6px;background:#${team.color.replace('#','')};display:flex;align-items:center;justify-content:center;flex-shrink:0;">${logoHtml}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-family:Barlow Condensed,sans-serif;font-weight:800;font-size:12px;letter-spacing:0.5px;color:var(--text-primary);line-height:1;">${primaryLabel}</div>
        <div class="tb-team-full">${secondaryLabel}</div>
      </div>
      <span style="font-size:14px;filter:${starred?'grayscale(0) opacity(1) drop-shadow(0 0 3px rgba(255,215,0,0.5))':'grayscale(1) opacity(0.25)'};transition:all 0.15s;">‚≠ê</span>`;
    card.onclick=()=>{
      const nm=team.name;
      if(state.favTeams.has(nm)){state.favTeams.delete(nm);state.favTeams.delete(team.abbr);state.favTeams.delete(team.shortName);}
      else state.favTeams.add(nm);
      if(_activeSidebarSbId){
        saveSbFavs();  // per-scoreboard: display_config.favTeams only, never team_config
      } else {
        saveFavs();
      }
      updateTbFavCount();renderTbTeams(teams);
    };
    list.appendChild(card);
  });
  updateTbFavCount();
}

function updateTbFavCount(){
  const el=document.getElementById('tbFavCount');
  if(el)el.innerHTML=`‚≠ê <span style="color:#ffd700;">${state.favTeams.size}</span> team${state.favTeams.size!==1?'s':''} favorited`;
}

// =====================
//  SAVE-STATE MANAGEMENT
// =====================
// autoSave=true  ‚Üí settings save immediately on every change (old behaviour)
// autoSave=false ‚Üí changes are held in state; Save button appears in modal header
let autoSave = ss.get('ss_auto_save') !== 'false'; // default: ON
let _dirty   = false;
let _savedTimer = null;

function initAutoSaveToggle() {
  const el = document.getElementById('autoSaveToggle');
  if (el) el.classList.toggle('on', autoSave);
}

function toggleAutoSave() {
  autoSave = !autoSave;
  ss.set('ss_auto_save', String(autoSave));
  const el = document.getElementById('autoSaveToggle');
  if (el) el.classList.toggle('on', autoSave);
  // If switching back to auto-save, flush any pending dirty changes immediately
  if (autoSave && _dirty) flushSave();
  else updateSaveUI();
}

// Call this instead of save*() directly for settings that respect the toggle.
function settingsSave(saveFn) {
  if (autoSave) {
    saveFn();
    showSavedBriefly();
  } else {
    _dirty = true;
    updateSaveUI();
  }
}

// Explicit Save button pressed
function manualSave() {
  flushSave();
}

function flushSave() {
  // Re-run all settings saves so current state is fully persisted
  saveEnabledSports();
  saveActiveSports();
  saveDisplay();
  ss.set('ss_refresh_rate', String(state.refreshRate));
  _dirty = false;
  updateSaveUI();
  showSavedBriefly();
}

function updateSaveUI() {
  const badge      = document.getElementById('saveStatusBadge');
  const modalBtn   = document.getElementById('modalSaveBtn');
  const sidebarBtn = document.getElementById('sidebarSaveBtn');

  if (_dirty) {
    // Unsaved changes ‚Äî show orange indicator everywhere
    if (badge)      { badge.textContent='‚óè Unsaved changes'; badge.style.color='var(--accent2)'; badge.style.opacity='1'; }
    if (modalBtn)   modalBtn.style.display = 'block';
    if (sidebarBtn) sidebarBtn.style.display = 'block';
  } else if (!autoSave) {
    // Manual mode, nothing pending ‚Äî show Save button as mode indicator (modal only)
    if (badge)      { badge.textContent='Manual save mode'; badge.style.color='var(--text-secondary)'; badge.style.opacity='0.8'; }
    if (modalBtn)   modalBtn.style.display = 'block';
    if (sidebarBtn) sidebarBtn.style.display = 'none'; // sidebar stays clean when nothing pending
  } else {
    // Auto-save on, nothing pending ‚Äî hide everything
    if (badge)      badge.style.opacity = '0';
    if (modalBtn)   modalBtn.style.display = 'none';
    if (sidebarBtn) sidebarBtn.style.display = 'none';
  }
}

function showSavedBriefly() {
  const badge      = document.getElementById('saveStatusBadge');
  const modalBtn   = document.getElementById('modalSaveBtn');
  const sidebarBtn = document.getElementById('sidebarSaveBtn');
  clearTimeout(_savedTimer);
  if (badge) { badge.textContent='‚úì Saved'; badge.style.color='var(--accent-green)'; badge.style.opacity='0.85'; }
  if (modalBtn)   modalBtn.style.display = !autoSave ? 'block' : 'none'; // keep visible if still in manual mode
  if (sidebarBtn) sidebarBtn.style.display = 'none'; // always hide sidebar btn after save
  _savedTimer = setTimeout(() => {
    if (badge) badge.style.opacity = '0';
    // In manual mode, re-show the modal mode indicator after the flash fades
    if (!autoSave) setTimeout(() => updateSaveUI(), 100);
  }, 2500);
}

// =====================
//  DISPATCHARR
// =====================
const API_BASE='/api';
let dsNumMode='auto'; // 'auto' | 'manual'

// ‚îÄ‚îÄ Dispatcharr credential cache (localStorage fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// We cache URL + username in localStorage so the tab fields survive page refreshes
// even when the API container isn't reachable yet. Password is never cached locally.
function saveDsCache(url,username){
  try{ss.set('ss_ds_url',url||'');ss.set('ss_ds_user',username||'');}catch(e){}
}
function loadDsCache(){
  return{url:ss.get('ss_ds_url')||'',username:ss.get('ss_ds_user')||''};
}

// Load saved credentials into UI on tab open ‚Äî cache first, then API
async function initDsTab(){
  // 1. Populate fields immediately from localStorage cache (instant, no network)
  const cache=loadDsCache();
  const urlEl=document.getElementById('dsUrl'),userEl=document.getElementById('dsUser'),passEl=document.getElementById('dsPass');
  if(cache.url&&urlEl)urlEl.value=cache.url;
  if(cache.username&&userEl)userEl.value=cache.username;
  // 2. Try to refresh from API in the background (updates placeholder if password is saved)
  try{
    const r=await fetch(`${API_BASE}/dispatcharr/credentials`,{signal:AbortSignal.timeout(4000)});
    if(r.ok){
      const d=await r.json();
      if(d.url&&urlEl)urlEl.value=d.url;
      if(d.username&&userEl)userEl.value=d.username;
      if(passEl)passEl.placeholder=d.has_password?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (saved)':'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      saveDsCache(d.url,d.username);
      // 3. Auto-load groups and profiles if credentials are fully saved
      if(d.url&&d.username&&d.has_password){
        loadDsGroups();
        loadDsProfiles();
        loadStreamProfiles();
      }
    }
  }catch(e){
    // API unreachable - fields already populated from cache above
  }
  buildManualSportRows();
}

async function saveCredentials(){
  const url=document.getElementById('dsUrl').value.trim();
  const username=document.getElementById('dsUser').value.trim();
  const password=document.getElementById('dsPass').value;
  if(!url){alert('Please enter the Dispatcharr URL');return;}
  const el=document.getElementById('testResult');
  el.style.display='block';el.className='dispatcharr-test-result';el.textContent='Saving credentials...';
  // Always cache URL+username locally so fields survive page refresh even if API is down
  saveDsCache(url,username);
  try{
    const r=await fetch(`${API_BASE}/dispatcharr/credentials`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({url,username,password:password||undefined}),
      signal:AbortSignal.timeout(5000)
    });
    const d=await r.json();
    if(r.ok){
      el.className='dispatcharr-test-result ok';el.textContent='‚úÖ Credentials saved to API';
      document.getElementById('dsPass').value='';
      document.getElementById('dsPass').placeholder='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (saved)';
    }else{el.className='dispatcharr-test-result err';el.textContent=`‚ùå ${d.error||'Save failed'}`;}
  }catch(e){
    el.className='dispatcharr-test-result err';
    el.textContent='‚ùå ScoreStream API not reachable ‚Äî check that the scorestream-api container is running. URL and username were cached locally.';
  }
}

async function testConnection(){
  const el=document.getElementById('testResult');
  el.style.display='block';el.className='dispatcharr-test-result';el.textContent='Testing connection...';
  try{
    const r=await fetch(`${API_BASE}/dispatcharr/test`,{signal:AbortSignal.timeout(8000)});
    const d=await r.json();
    if(r.ok&&d.connected){
      el.className='dispatcharr-test-result ok';
      el.textContent=`‚úÖ Connected to Dispatcharr${d.version?' (v'+d.version+')':''}`;
      updateDsStatus(true);
      // Auto-load groups and profiles after successful connection
      loadDsGroups();loadDsProfiles();loadStreamProfiles();
    }else{
      el.className='dispatcharr-test-result err';
      el.textContent=`‚ùå ${d.error||'Could not connect to Dispatcharr'}`;
      updateDsStatus(false,'error');
    }
  }catch(e){
    el.className='dispatcharr-test-result err';
    el.textContent=`‚ùå ScoreStream API container not reachable ‚Äî go to Portainer and confirm scorestream-api is running, then retry.`;
    updateDsStatus(false,'error');
  }
}

// Store all groups for client-side filtering
let _allGroups = [];
let _groupFilter = 'dispatcharr'; // default: show Dispatcharr-created groups only

async function loadDsGroups(){
  const sel=document.getElementById('dGroupSelect');
  sel.innerHTML='<option value="">Loading...</option>';
  try{
    const r=await fetch(`${API_BASE}/dispatcharr/groups`,{signal:AbortSignal.timeout(50000)});
    const d=await r.json();
    if(r.ok&&d.groups?.length){
      _allGroups=d.groups;
      renderGroupSelect();
    }else{
      _allGroups=[];
      sel.innerHTML='<option value="">‚Äî no groups found ‚Äî</option>';
    }
  }catch(e){sel.innerHTML='<option value="">‚Äî connect first ‚Äî</option>';}
  buildManualSportRows();
}

function renderGroupSelect(){
  const sel=document.getElementById('dGroupSelect');
  if(!sel)return;
  const prev=sel.value;
  let filtered=_allGroups;
  if(_groupFilter==='dispatcharr') filtered=_allGroups.filter(g=>g.m3u_count===0);
  else if(_groupFilter==='m3u') filtered=_allGroups.filter(g=>g.m3u_count>0);
  if(!filtered.length && _groupFilter!=='all'){
    // fallback: show all if filter yields nothing
    filtered=_allGroups;
  }
  sel.innerHTML='<option value="">‚Äî select group ‚Äî</option>'+
    filtered.map(g=>`<option value="${g.id}">${g.name}${g.m3u_count>0?' (M3U)':''}</option>`).join('');
  if(prev) sel.value=prev;
  buildManualSportRows();
}

function setGroupFilter(f){
  _groupFilter=f;
  document.querySelectorAll('.grp-filter-btn').forEach(b=>{
    b.classList.toggle('active',b.dataset.filter===f);
  });
  renderGroupSelect();
}

async function createNewGroup(){
  const nameEl=document.getElementById('dNewGroupName');
  const resultEl=document.getElementById('newGroupResult');
  const name=nameEl?.value?.trim();
  if(!name){resultEl.style.display='block';resultEl.style.color='var(--accent-red)';resultEl.textContent='Enter a group name first.';return;}
  resultEl.style.display='block';resultEl.style.color='var(--text-dim)';resultEl.textContent='Creating...';
  try{
    const r=await fetch(`${API_BASE}/dispatcharr/groups`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name}),signal:AbortSignal.timeout(15000)
    });
    const d=await r.json();
    if(r.ok&&d.id){
      resultEl.style.color='var(--accent-green)';
      resultEl.textContent='‚úÖ Group "'+d.name+'" created';
      nameEl.value='';
      // Add to local list and refresh select, auto-select the new group
      _allGroups.push({id:d.id,name:d.name,m3u_count:0});
      _allGroups.sort((a,b)=>a.name.localeCompare(b.name));
      _groupFilter='dispatcharr';
      document.querySelectorAll('.grp-filter-btn').forEach(b=>b.classList.toggle('active',b.dataset.filter==='dispatcharr'));
      renderGroupSelect();
      document.getElementById('dGroupSelect').value=d.id;
      setTimeout(()=>{resultEl.style.display='none';},3000);
    }else{
      resultEl.style.color='var(--accent-red)';
      resultEl.textContent='‚ùå '+(d.error||JSON.stringify(d));
    }
  }catch(e){resultEl.style.color='var(--accent-red)';resultEl.textContent='‚ùå '+e.message;}
}

async function loadDsProfiles(){
  const list=document.getElementById('dProfileList');
  const label=document.getElementById('dProfileLabel');
  if(list) list.innerHTML='<div style="padding:8px 10px;opacity:0.6;font-size:12px;">Loading profiles...</div>';
  if(label) label.textContent='Loading...';
  try{
    const r=await fetch(`${API_BASE}/dispatcharr/profiles`,{signal:AbortSignal.timeout(50000)});
    const d=await r.json();
    if(r.ok&&d.profiles?.length){
      list.innerHTML=d.profiles.map(p=>
        `<label class="profile-ms-item"><input type="checkbox" class="profile-cb" value="${p.id}" onchange="onProfileCbChange()"><span>${p.name}</span></label>`
      ).join('');
      updateProfileLabel();
    }else{
      list.innerHTML='<div style="padding:8px 10px;opacity:0.6;font-size:12px;">No profiles found</div>';
      if(label) label.textContent='‚Äî no profiles found ‚Äî';
    }
  }catch(e){
    if(list) list.innerHTML='<div style="padding:8px 10px;opacity:0.6;font-size:12px;">Failed to load</div>';
    if(label) label.textContent='‚Äî connect first ‚Äî';
  }
}

function toggleProfileDropdown(){
  const dd=document.getElementById('dProfileDropdown');
  if(!dd)return;
  const isOpen=dd.style.display!=='none';
  dd.style.display=isOpen?'none':'block';
  if(!isOpen){
    // Close when clicking outside
    setTimeout(()=>document.addEventListener('click',closeProfileDropdown,{once:true,capture:true}),0);
  }
}

function closeProfileDropdown(e){
  const ms=document.getElementById('dProfileMultiselect');
  if(ms&&!ms.contains(e.target)){
    const dd=document.getElementById('dProfileDropdown');
    if(dd)dd.style.display='none';
  } else {
    // re-attach if click was inside
    setTimeout(()=>document.addEventListener('click',closeProfileDropdown,{once:true,capture:true}),0);
  }
}

function onProfileAllChange(allCb){
  if(allCb.checked){
    document.querySelectorAll('.profile-cb').forEach(cb=>cb.checked=false);
  }
  updateProfileLabel();
}

function onProfileCbChange(){
  // Uncheck "All" if any individual is selected
  const allCb=document.getElementById('dProfileAll');
  const anyChecked=[...document.querySelectorAll('.profile-cb')].some(cb=>cb.checked);
  if(allCb&&anyChecked) allCb.checked=false;
  updateProfileLabel();
}

function updateProfileLabel(){
  const allCb=document.getElementById('dProfileAll');
  const checked=[...document.querySelectorAll('.profile-cb')].filter(cb=>cb.checked);
  const label=document.getElementById('dProfileLabel');
  if(!label)return;
  if(allCb?.checked){
    label.textContent='All Profiles';
  } else if(checked.length===0){
    label.textContent='‚Äî default (no profile) ‚Äî';
  } else if(checked.length===1){
    label.textContent=checked[0].closest('label').querySelector('span').textContent;
  } else {
    label.textContent=checked.length+' profiles selected';
  }
}

function getSelectedProfileIds(){
  const allCb=document.getElementById('dProfileAll');
  if(allCb?.checked) return 'all';
  return [...document.querySelectorAll('.profile-cb:checked')].map(cb=>parseInt(cb.value));
}

// ‚îÄ‚îÄ Stream Profiles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStreamProfiles(){
  const sel=document.getElementById('dStreamProfileSelect');
  if(sel)sel.innerHTML='<option value="">Loading...</option>';
  try{
    const r=await fetch(`${API_BASE}/dispatcharr/streamprofiles`,{signal:AbortSignal.timeout(20000)});
    const d=await r.json();
    if(r.ok&&d.profiles?.length){
      _cachedStreamProfiles=d.profiles;
      if(sel){
        sel.innerHTML='<option value="">‚Äî default (none) ‚Äî</option>'+
          '<option value="__custom__">+ Create custom ffmpeg profile...</option>'+
          '<optgroup label="Built-in">'+d.profiles.filter(p=>p.locked).map(p=>`<option value="${p.id}">${p.name}</option>`).join('')+'</optgroup>'+
          (d.profiles.filter(p=>!p.locked).length?'<optgroup label="Custom">'+d.profiles.filter(p=>!p.locked).map(p=>`<option value="${p.id}">${p.name}</option>`).join('')+'</optgroup>':'');
        sel.onchange=onStreamProfileChange;
      }
    }else{
      if(sel)sel.innerHTML='<option value="">‚Äî no profiles found ‚Äî</option>';
    }
  }catch(e){if(sel)sel.innerHTML='<option value="">‚Äî connect first ‚Äî</option>';}
}

function onStreamProfileChange(){
  const sel=document.getElementById('dStreamProfileSelect');
  const panel=document.getElementById('customStreamPanel');
  if(!panel)return;
  panel.style.display=(sel?.value==='__custom__')?'block':'none';
}

async function createStreamProfile(){
  const name=document.getElementById('dCustomStreamName')?.value?.trim();
  const params=document.getElementById('dCustomStreamParams')?.value?.trim();
  const resultEl=document.getElementById('customStreamResult');
  if(!name||!params){resultEl.style.color='var(--accent-red)';resultEl.textContent='Name and parameters required.';return;}
  resultEl.style.color='var(--text-dim)';resultEl.textContent='Creating...';
  try{
    const r=await fetch(`${API_BASE}/dispatcharr/streamprofiles`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name,parameters:params}),signal:AbortSignal.timeout(15000)
    });
    const d=await r.json();
    if(r.ok&&d.id){
      resultEl.style.color='var(--accent-green)';
      resultEl.textContent='‚úÖ Profile "'+d.name+'" created (id='+d.id+')';
      document.getElementById('dCustomStreamName').value='';
      // Reload profiles and auto-select the new one
      await loadStreamProfiles();
      document.getElementById('dStreamProfileSelect').value=d.id;
      document.getElementById('customStreamPanel').style.display='none';
    }else{
      resultEl.style.color='var(--accent-red)';
      resultEl.textContent='‚ùå '+(d.error||JSON.stringify(d));
    }
  }catch(e){resultEl.style.color='var(--accent-red)';resultEl.textContent='‚ùå '+e.message;}
}

// Channel numbering mode
function setNumMode(mode){
  dsNumMode=mode;
  document.getElementById('numModeAuto').classList.toggle('active',mode==='auto');
  document.getElementById('numModeManual').classList.toggle('active',mode==='manual');
  document.getElementById('numAutoPanel').style.display=mode==='auto'?'block':'none';
  document.getElementById('numManualPanel').style.display=mode==='manual'?'block':'none';
  if(mode==='manual')buildManualSportRows();
}

function buildManualSportRows(){
  const c=document.getElementById('manualSportRows');if(!c)return;
  const sports=getAllEnabledSports();
  // Get current groups for dropdown
  const groupSel=document.getElementById('dGroupSelect');
  const groupOptions=groupSel?Array.from(groupSel.options).filter(o=>o.value).map(o=>`<option value="${o.value}">${o.text}</option>`).join(''):'';
  c.innerHTML=sports.map(sport=>`
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:8px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;">
      <div style="width:8px;height:8px;border-radius:2px;background:${sport.color};flex-shrink:0;"></div>
      <span style="font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;min-width:140px;">${sport.emoji} ${sport.name}</span>
      <input type="number" placeholder="Ch#" id="mch-${sport.id}" style="width:70px;background:var(--bg-input,rgba(255,255,255,0.05));border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text-primary);font-size:12px;">
      <select id="mgrp-${sport.id}" style="flex:1;background:var(--bg-input,rgba(255,255,255,0.05));border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text-primary);font-size:12px;">
        <option value="">Default group</option>
        ${groupOptions}
      </select>
    </div>`).join('');
}

async function createChannels(mode){
  const el=document.getElementById('channelResult');
  el.style.display='block';el.className='channel-result';el.textContent='Creating channels...';
  try{
    const groupId=document.getElementById('dGroupSelect')?.value||null;
    const profileIds=getSelectedProfileIds();
    const sports=getAllEnabledSports().map(s=>({id:s.id,name:s.name,emoji:s.emoji}));

    let channelAssignments=null;
    if(dsNumMode==='manual'){
      channelAssignments=sports.map(s=>({
        sportId:s.id,
        sportName:s.name,
        channelNumber:parseInt(document.getElementById(`mch-${s.id}`)?.value||'0')||null,
        groupId:document.getElementById(`mgrp-${s.id}`)?.value||groupId||null,
      }));
    }

    const streamProfileVal=document.getElementById('dStreamProfileSelect')?.value||null;
    const streamProfileId=(streamProfileVal&&streamProfileVal!=='__custom__')?parseInt(streamProfileVal):null;
    const body={
      mode,
      sports,
      numberingMode:dsNumMode,
      startChannel:parseInt(document.getElementById('dChannelStart')?.value||'900'),
      groupId,
      profileIds,
      streamProfileId,
      channelAssignments,
    };

    const r=await fetch(`${API_BASE}/dispatcharr/create`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body),signal:AbortSignal.timeout(20000)
    });
    const d=await r.json();
    if(r.ok){
      el.style.color='var(--accent)';
      el.textContent='‚úÖ Created '+(d.created?.length||0)+' channel(s)\n'+(d.created||[]).map(c=>'  #'+c.number+' '+c.name).join('\n')+(d.errors?.length?'\n‚ö†Ô∏è '+d.errors.length+' error(s):\n'+d.errors.join('\n'):'');
    }else{
      el.style.color='#ff6b6b';el.textContent=`‚ùå ${d.error||'Channel creation failed'}`;
    }
  }catch(e){el.style.color='#ff6b6b';el.textContent=`‚ùå Error: ${e.message}`;}
}

function updateDsStatus(connected,st=''){
  const dot=document.getElementById('dsDot'),label=document.getElementById('dsLabel');
  if(!dot||!label)return;
  if(connected){dot.className='ds-dot connected';label.className='ds-label connected';label.textContent='Dispatcharr: Connected';}
  else if(st==='error'){dot.className='ds-dot error';label.className='ds-label error';label.textContent='Dispatcharr: Connection Error';}
  else if(st==='configured'){dot.className='ds-dot configured';label.className='ds-label';label.textContent='Dispatcharr: Configured';}
  else{dot.className='ds-dot';label.className='ds-label';label.textContent='Dispatcharr: Not Configured';}
}

// =====================
//  SCOREBOARD SELECTOR
// =====================
let _activeSidebarSlug = '__all__'; // '__all__' = default All Sports view
let _activeStreamDisplayConfig = null; // display_config of active stream scoreboard
let _activeStreamSlug = null;           // slug of the active stream scoreboard for config refresh
let _activeSidebarSbId = null;       // numeric ID of active custom scoreboard (null = All Sports)
let _allSportsEnabledSports = null;  // saved state when switching away from All Sports
let _allSportsActiveSports = null;
let _allSportsFavTeams = null;       // saved global favorites when switching to custom scoreboard
let _activeTeamConfig = null;
let _activeFinalsCfg = null;  // per-sport finals config from scoreboard display_config

async function initSidebarScoreboardSelector(){
  try{
    const r=await fetch(`${API_BASE}/scoreboards`,{signal:AbortSignal.timeout(5000)});
    if(!r.ok)return;
    const d=await r.json();
    const pills=document.getElementById('sbSelectorPills');
    if(!pills)return;
    // Clear existing CUSTOM pills only (keep static "All Sports" pill which has class all-sports)
    pills.querySelectorAll('.sb-selector-pill:not(.all-sports)').forEach(p=>p.remove());
    const custom=(d.scoreboards||[]);
    custom.forEach(sb=>{
      const pill=document.createElement('div');
      pill.className='sb-selector-pill';
      pill.dataset.slug=sb.slug;
      pill.dataset.sbid=sb.id;
      pill.title=sb.name;
      pill.textContent='üìã '+sb.name;
      pill.onclick=()=>selectSidebarScoreboard(sb.slug);
      pills.appendChild(pill);
    });
  }catch(e){}
}

function selectSidebarScoreboard(slug){
  _activeSidebarSlug=slug;
  // Update pill active states
  document.querySelectorAll('.sb-selector-pill').forEach(p=>{
    p.classList.toggle('active', p.dataset.slug===slug);
  });
  const defaultSections=document.getElementById('sidebarDefaultSections');
  const banner=document.getElementById('previewBanner');
  const titleEl=document.getElementById('topbarTitle');
  if(slug==='__all__'){
    // Restore All Sports view
    _activeTeamConfig=null;
    _activeFinalsCfg=null;
    _activeSidebarSbId=null;
    // Reset card scale to default
    const sbEl=document.getElementById('scoreboard');
    if(sbEl){
      sbEl.style.removeProperty('--card-score-size');
      sbEl.style.removeProperty('--card-abbr-size');
      sbEl.style.removeProperty('--card-name-size');
    }
    if(defaultSections)defaultSections.style.display='block';
    if(banner)banner.style.display='none';
    if(titleEl)titleEl.textContent='All Sports Scoreboard';
    // Restore saved sports state, or default to ALL sports enabled
    if(_allSportsEnabledSports){
      state.enabledSports=_allSportsEnabledSports;
      state.activeSports=_allSportsActiveSports;
      _allSportsEnabledSports=null;
      _allSportsActiveSports=null;
    }
    // Restore global localStorage favorites
    if(_allSportsFavTeams !== null){ state.favTeams=_allSportsFavTeams; _allSportsFavTeams=null; }
    buildSportToggles();
    renderScoreboard();
  }else{
    // Save current All Sports state before overriding
    if(!_allSportsEnabledSports){
      _allSportsEnabledSports=new Set(state.enabledSports);
      _allSportsActiveSports=new Set(state.activeSports);
    }
    // Hide default sidebar sections
    if(defaultSections)defaultSections.style.display='none';
    // Fetch scoreboard config and apply
    fetch(`${API_BASE}/scoreboards/by-slug/${slug}`,{signal:AbortSignal.timeout(5000)})
      .then(r=>r.ok?r.json():null)
      .then(sb=>{
        if(!sb)return;
        if(titleEl)titleEl.textContent=sb.name;
        if(banner){banner.style.display='inline-block';banner.textContent='‚óè PREVIEW';}
        const sportIds=Object.entries(sb.sport_config||{}).filter(([,v])=>v).map(([k])=>k);
        if(!sportIds.length){
          // Unconfigured scoreboard ‚Äî show message
          document.getElementById('scoreboard').innerHTML=
            '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;color:var(--text-dim);font-family:\'Barlow Condensed\',sans-serif;">' +
            '<div style="font-size:48px;margin-bottom:16px;">‚öôÔ∏è</div>' +
            '<div style="font-size:22px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;">Scoreboard Not Configured</div>' +
            '<div style="font-size:14px;">Go to Settings ‚Üí My Scoreboards to add sports to this scoreboard.</div></div>';
          return;
        }
        // Store team_config as-is (per-sport object) for filtering during render
        const tc = sb.team_config;
        _activeTeamConfig = (tc && !Array.isArray(tc) && Object.keys(tc).length) ? tc : null;
        // Store finals config for this scoreboard
        _activeFinalsCfg = (sb.display_config && sb.display_config.finals) || null;
        // Track active scoreboard ID for per-scoreboard favorites
        _activeSidebarSbId = sb.id;
        // Save global favorites before overriding with scoreboard favorites
        if(_allSportsFavTeams === null){ _allSportsFavTeams = new Set(state.favTeams); }
        // Load per-scoreboard favorites from display_config (independent of team_config)
        state.favTeams = new Set((sb.display_config && sb.display_config.favTeams) || []);
        state.enabledSports=new Set(sportIds);
        state.activeSports=new Set(sportIds);
        // Apply stream card scale to preview
        const previewScale = sb.display_config?.stream_card_scale || 1.0;
        const sbEl = document.getElementById('scoreboard');
        if(sbEl){
          sbEl.style.setProperty('--card-score-size', Math.round(34 * previewScale) + 'px');
          sbEl.style.setProperty('--card-abbr-size', Math.round(18 * previewScale) + 'px');
          sbEl.style.setProperty('--card-name-size', Math.round(11 * previewScale) + 'px');
        }
        buildSportToggles();
        // Re-fetch scores to get finals data if needed
        fetchAllScores();
      })
      .catch(()=>{});
  }
}

// =====================
//  CLOCK
// =====================
let _clockInterval = null;
function startClock(tz){
  const el=document.getElementById('clockDisplay');if(!el)return;
  if(_clockInterval)clearInterval(_clockInterval);
  const opts=tz?{timeZone:tz,hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true}:undefined;
  const tick=()=>{const n=new Date();el.innerHTML=`<span>üïê</span> <span class="val">${n.toLocaleTimeString(undefined,opts)}</span>`;};
  tick(); // fire immediately so clock shows before first interval
  _clockInterval=setInterval(tick,1000);
}

// =====================
//  WIRE UP UI
// =====================
document.querySelectorAll('.layout-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.layout-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');state.layout=btn.dataset.layout;renderScoreboard();
  });
});

document.querySelectorAll('.pill-opt').forEach(opt=>{
  opt.addEventListener('click',()=>{
    document.querySelectorAll(`.pill-opt[data-opt="${opt.dataset.opt}"]`).forEach(o=>o.classList.remove('active'));
    opt.classList.add('active');
    if(opt.dataset.opt==='stats')state.statsDepth=opt.dataset.val;
    if(opt.dataset.opt==='filter')state.filterMode=opt.dataset.val;
    renderScoreboard();
  });
});

document.getElementById('refreshBtn').addEventListener('click',fetchAllScores);

// =====================
//  INIT
// =====================
const savedRate=parseInt(ss.get('ss_refresh_rate')||'60');
state.refreshRate=savedRate;
initDisplayControls();
initAutoSaveToggle();
buildSportToggles();
startClock(); // default clock, no timezone ‚Äî overridden in stream mode
renderFavSummary();

// STREAM MODE: configure scoreboard filters BEFORE fetching scores so the correct
// sport/team filters are applied from the very first fetch
(async function initStreamMode(){
  const params=new URLSearchParams(window.location.search);
  if(!params.has('stream')){
    // Normal mode ‚Äî fetch scores immediately as before
    fetchAllScores();
    startAutoRefresh();
    setRefreshRate(savedRate);
    loadNcaaFromApi();
    initSidebarScoreboardSelector();
    return;
  }

  // Stream mode ‚Äî hide sidebar, add CSS class
  const sidebar=document.getElementById('sidebar');
  if(sidebar)sidebar.style.display='none';
  document.body.classList.add('stream-mode');

  // Fetch scoreboard config FIRST so filters are set before any score fetching
  const slug=params.get('slug');
  _activeStreamSlug = slug || '__active__';
  const url=slug?`${API_BASE}/scoreboards/by-slug/${slug}`:`${API_BASE}/scoreboards/active`;
  try{
    const r=await fetch(url,{signal:AbortSignal.timeout(5000)});
    if(r.ok){
      const sb=await r.json();
      // Update topbar title
      const titleEl=document.getElementById('topbarTitle');
      if(titleEl)titleEl.textContent=sb.name||'ScoreStream';
      // Set clock timezone
      const tz=(sb.display_config&&sb.display_config.timezone)||null;
      startClock(tz);
      const sportIds=Object.entries(sb.sport_config||{}).filter(([,v])=>v).map(([k])=>k);
      if(!sportIds.length){
        document.getElementById('scoreboard').innerHTML=
          '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:80vh;color:var(--text-dim);font-family:Barlow Condensed,sans-serif;">' +
          '<div style="font-size:64px;margin-bottom:20px;">‚öôÔ∏è</div>' +
          '<div style="font-size:28px;font-weight:900;letter-spacing:3px;text-transform:uppercase;margin-bottom:10px;color:var(--text-primary);">Not Configured</div>' +
          '<div style="font-size:15px;">Configure sports in Settings ‚Üí My Scoreboards</div></div>';
        return;
      }
      // Apply sport filter before fetching
      state.enabledSports=new Set(sportIds);
      state.activeSports=new Set(sportIds);
      // Apply team filter
      if(sb.team_config&&!Array.isArray(sb.team_config)&&Object.keys(sb.team_config).length>0){
        _activeTeamConfig=sb.team_config;
      } else {
        _activeTeamConfig=null;
      }
      // Store finals config and full display_config for this scoreboard
      _activeFinalsCfg = (sb.display_config && sb.display_config.finals) || null;
      _activeStreamDisplayConfig = sb.display_config || null;
      // Load per-scoreboard favorites from display_config (independent of team_config)
      state.favTeams = new Set((sb.display_config && sb.display_config.favTeams) || []);
      // Apply resolution scaling to #main
      applyStreamResolution(sb.display_config?.stream_resolution || '1920x1080');
    }
  }catch(e){
    console.warn('[stream] Failed to load scoreboard config:',e.message);
  }

  // Now fetch scores with correct filters already applied
  await fetchAllScores();
  // Stream mode uses 30s refresh
  setRefreshRate(30);
  startAutoRefresh();
  loadNcaaFromApi();

  // Replace scoreboard with fixed canvas layout ‚Äî must run AFTER fetchAllScores
  // so games are in state.games before renderStreamCanvas is called
  initStreamCanvas();
})();

// =====================
//  STREAM CANVAS
// =====================

// Stream canvas state
let _streamPages = [];      // array of arrays of game elements
let _streamCurrentPage = 0;
let _streamPageTimer = null;
let _streamScaleX = 1;
let _streamScaleY = 1;
let _streamInterval = 15;   // seconds between page rotations

// Re-fetch scoreboard config during stream refresh cycle to pick up saved settings changes
async function refreshStreamConfig() {
  if(!_activeStreamSlug) return;
  const url = _activeStreamSlug === '__active__'
    ? `${API_BASE}/scoreboards/active`
    : `${API_BASE}/scoreboards/by-slug/${_activeStreamSlug}`;
  try {
    const r = await fetch(url, {signal: AbortSignal.timeout(4000)});
    if(!r.ok) return;
    const sb = await r.json();
    const dc = sb.display_config || {};
    const prevScale    = _activeStreamDisplayConfig?.stream_card_scale;
    const prevRotation = _activeStreamDisplayConfig?.stream_rotation_secs;
    _activeStreamDisplayConfig = dc;
    _activeFinalsCfg = dc.finals || null;  // keep finals config in sync
    // Re-apply resolution if it changed
    applyStreamResolution(dc.stream_resolution || '1920x1080');

    // If card scale changed, re-render canvas with new scale
    const newScale = dc.stream_card_scale;
    if(newScale != null && newScale !== prevScale) {
      console.log(`[stream] Card scale changed ${prevScale} ‚Üí ${newScale}, re-rendering`);
      renderStreamCanvas();
    }
    // If rotation interval changed, restart the page timer
    const newRotation = dc.stream_rotation_secs;
    if(newRotation != null && newRotation !== prevRotation) {
      console.log(`[stream] Rotation interval changed ${prevRotation}s ‚Üí ${newRotation}s, restarting timer`);
      _streamInterval = newRotation;
      if(_streamPageTimer) { clearInterval(_streamPageTimer); _streamPageTimer = null; }
      if(_streamInterval > 0) {
        _streamPageTimer = setInterval(advanceStreamPage, _streamInterval * 1000);
      }
    }
  } catch(e) {
    // Non-fatal ‚Äî stream continues with current settings
  }
}

function applyStreamResolution(resolution) {
  // Resolution is stored in display_config and passed to the renderer via URL param.
  // The renderer (Puppeteer) uses STREAM_WIDTH / STREAM_HEIGHT env vars to set viewport.
  // This function has NO effect on the DOM ‚Äî resolution is a renderer-level setting.
  // We do NOT apply any CSS transform here because scaling #main causes clipping/distortion.
  // The resolution value is read by the renderer's launch script via ?res= query param.
  const main = document.getElementById('main');
  if (main) {
    main.style.transform = '';
    main.style.transformOrigin = '';
    main.style.width = '';
    main.style.height = '';
  }
  console.log(`[stream] Resolution config: ${resolution} (applied by renderer viewport)`);
}

function getStreamSettings() {
  // In stream mode: read from the scoreboard's display_config
  // In sidebar preview: fall back to localStorage defaults
  const dc = _activeStreamDisplayConfig || {};
  const stored = (() => { try { return JSON.parse(localStorage.getItem('ss_stream_settings') || '{}'); } catch(e){ return {}; } })();
  return {
    interval:  dc.stream_rotation_secs != null ? dc.stream_rotation_secs : (stored.interval || 30),
    cardScale: dc.stream_card_scale    != null ? dc.stream_card_scale    : (stored.cardScale || 1.0),
    resolution: dc.stream_resolution  || '1920x1080',
    bitrate:    dc.stream_bitrate      || '2000k',
  };
}

function initStreamCanvas() {
  const sb = document.getElementById('scoreboard');
  if (!sb) return;

  const settings = getStreamSettings();
  _streamInterval = settings.interval;

  // Build canvas structure
  sb.innerHTML = '<div id="stream-canvas"><div id="stream-pages"></div></div><div id="stream-pagination"></div>';

  // Defer render by one frame so the DOM is laid out and clientHeight/Width are valid
  requestAnimationFrame(() => renderStreamCanvas());
}

function renderStreamCanvas() {
  const pagesEl = document.getElementById('stream-pages');
  const paginationEl = document.getElementById('stream-pagination');
  if (!pagesEl) return;

  const settings = getStreamSettings();
  const scale = settings.cardScale;

  // Collect all games across enabled sports in order
  const allSections = [];
  const sports = getSPORTS();

  sports.forEach(sport => {
    let games = state.games[sport.id] || [];
    if (!games.length) return;

    // Apply team filter
    if (_activeTeamConfig) {
      const sportTeams = _activeTeamConfig[sport.id];
      if (sportTeams && sportTeams.length)
        games = games.filter(g => g.teams.some(t => sportTeams.includes(t.name) || sportTeams.includes(t.abbr)));
    }

    // Separate live/upcoming from finals
    const liveUpcoming = games.filter(g => !g.isFinal);
    const finalGames = games.filter(g => g.isFinal);

    // Show live/upcoming section
    if (liveUpcoming.length > 0) allSections.push({ sport, games: liveUpcoming });

    // Show finals sections ‚Äî grouped by date so each day gets its own section
    const showFinals = (finalGames.length > 0) && (
      (_activeFinalsCfg && _activeFinalsCfg[sport.id]?.show) ||
      (!_activeFinalsCfg && state.showEnded && state.endedLeagues.has(sport.id))
    );
    if (showFinals) {
      // Group by date string (YYYY-MM-DD)
      const byDate = {};
      finalGames.forEach(g => {
        const d = g.date ? new Date(g.date).toLocaleDateString('en-CA') : 'unknown'; // en-CA = YYYY-MM-DD
        if (!byDate[d]) byDate[d] = [];
        byDate[d].push(g);
      });
      // Sort dates descending (most recent first)
      Object.keys(byDate).sort((a, b) => b.localeCompare(a)).forEach(dateKey => {
        allSections.push({ sport, games: byDate[dateKey], isFinalSection: true, finalDate: dateKey });
      });
    }
  });

  if (!allSections.length) {
    pagesEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-dim);font-family:Barlow Condensed,sans-serif;font-size:22px;letter-spacing:2px;">NO GAMES RIGHT NOW</div>';
    if (paginationEl) paginationEl.innerHTML = '';
    return;
  }

  // Measure available space ‚Äî use window dimensions as reliable fallback
  // canvas.clientHeight can be 0 if layout hasn't painted yet
  const canvas = document.getElementById('stream-canvas');
  const topbarH = document.getElementById('topbar')?.offsetHeight || 64;
  const paginationH = 28; // dot bar at bottom
  const availH = (canvas && canvas.clientHeight > 50)
    ? canvas.clientHeight
    : (window.innerHeight - topbarH - paginationH - 16);
  const availW = (canvas && canvas.clientWidth > 100)
    ? canvas.clientWidth
    : (window.innerWidth - 28);

  // Card approximate height at current scale (header + 2 teams + padding)
  const cardH = Math.round(130 * scale);
  const sectionHeaderH = 36; // league-header height
  const gridGap = 9;
  const pagePad = 28; // padding inside page
  const colMinW = Math.round(300 * scale);
  const cols = Math.max(1, Math.floor((availW - pagePad) / (colMinW + gridGap)));
  console.log(`[stream] availH=${availH} availW=${availW} cols=${cols} scale=${scale} cardH=${cardH}`);

  // Build section blocks ‚Äî figure out how many rows each section needs
  // then paginate by fitting as many sections as possible per page
  let pages = [];
  let currentPageSections = [];
  let currentPageH = 0;

  allSections.forEach(({ sport, games, isFinalSection }) => {
    const rows = Math.ceil(games.length / cols);
    const sectionH = sectionHeaderH + gridGap + (rows * cardH) + ((rows - 1) * gridGap) + 26; // 26 = section margin

    if (currentPageSections.length > 0 && currentPageH + sectionH > availH) {
      // This section doesn't fit ‚Äî start a new page
      pages.push(currentPageSections);
      currentPageSections = [];
      currentPageH = 0;
    }

    // If section alone is taller than page, we still put it on its own page
    currentPageSections.push({ sport, games, isFinalSection });
    currentPageH += sectionH;
  });

  if (currentPageSections.length > 0) pages.push(currentPageSections);

  _streamPages = pages;

  // Render pages DOM
  pagesEl.innerHTML = '';
  pages.forEach((sections, pageIdx) => {
    const pageEl = document.createElement('div');
    pageEl.className = 'stream-page' + (pageIdx === _streamCurrentPage ? ' active' : '');
    pageEl.dataset.page = pageIdx;

    sections.forEach(({ sport, games, isFinalSection, finalDate }) => {
      // Sport section header
      const season = state.seasonMeta[sport.id];
      let sbadge = '';
      if (season && season.key !== 'reg' && !isFinalSection) sbadge = `<span class="league-season-badge ${season.key}">${season.label}</span>`;
      const sec = document.createElement('div');
      sec.className = 'league-section';
      sec.dataset.sportId = sport.id;
      let sectionLabel = `${sport.emoji} ${sport.name}`;
      if (isFinalSection) {
        const dateLabel = finalDate && finalDate !== 'unknown' ? ' ¬∑ ' + new Date(finalDate + 'T12:00:00').toLocaleDateString([], {month:'short', day:'numeric'}) : '';
        sectionLabel = `${sport.emoji} ${sport.name} ‚Äî Finals${dateLabel}`;
      }
      sec.innerHTML = `<div class="league-header"><div class="league-stripe" style="background:${isFinalSection ? '#ffb400' : sport.color}"></div><div class="league-name">${sectionLabel}</div>${sbadge}<div class="league-game-count">${games.length} game${games.length !== 1 ? 's' : ''}</div></div>`;

      const grid = document.createElement('div');
      grid.className = 'games-grid grid-mode';
      grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      if (scale !== 1.0) {
        grid.style.setProperty('--card-score-size', Math.round(34 * scale) + 'px');
        grid.style.setProperty('--card-abbr-size', Math.round(18 * scale) + 'px');
        grid.style.setProperty('--card-name-size', Math.round(11 * scale) + 'px');
      }

      games.forEach(g => {
        const card = buildFullCard(g);
        card.dataset.gameId = g.id;
        grid.appendChild(card);
      });

      sec.appendChild(grid);
      pageEl.appendChild(sec);
    });

    pagesEl.appendChild(pageEl);
  });

  // Render pagination dots (only if more than 1 page)
  if (paginationEl) {
    if (pages.length > 1) {
      paginationEl.innerHTML = pages.map((_, i) =>
        `<div class="stream-dot${i === _streamCurrentPage ? ' active' : ''}" data-page="${i}"></div>`
      ).join('');
    } else {
      paginationEl.innerHTML = '';
    }
  }

  // Start/restart page rotation timer
  if (_streamPageTimer) clearInterval(_streamPageTimer);
  if (pages.length > 1) {
    _streamPageTimer = setInterval(advanceStreamPage, _streamInterval * 1000);
  }
}

function advanceStreamPage() {
  const pages = document.querySelectorAll('.stream-page');
  if (pages.length <= 1) return;

  const nextPage = (_streamCurrentPage + 1) % pages.length;

  // Fade out current
  pages[_streamCurrentPage].classList.remove('active');
  // Fade in next
  pages[nextPage].classList.add('active');

  _streamCurrentPage = nextPage;

  // Update dots
  document.querySelectorAll('.stream-dot').forEach((d, i) => {
    d.classList.toggle('active', i === _streamCurrentPage);
  });
}

function updateStreamScoresInPlace() {
  const sports = getSPORTS();
  let hasNewGames = false;

  sports.forEach(sport => {
    let games = state.games[sport.id] || [];
    if (_activeTeamConfig) {
      const sportTeams = _activeTeamConfig[sport.id];
      if (sportTeams && sportTeams.length)
        games = games.filter(g => g.teams.some(t => sportTeams.includes(t.name) || sportTeams.includes(t.abbr)));
    }
    // Only filter out finals if they're not configured to show for this sport
    const showFinalForSport = (_activeFinalsCfg && _activeFinalsCfg[sport.id]?.show) ||
                              (state.showEnded && state.endedLeagues.has(sport.id));
    if (!showFinalForSport) games = games.filter(g => !g.isFinal);

    games.forEach(g => {
      const cardEl = document.querySelector(`.stream-page [data-game-id="${g.id}"]`);
      if (!cardEl) {
        // New game appeared ‚Äî need full re-render
        hasNewGames = true;
        return;
      }

      // Update scores in-place
      const teamRows = cardEl.querySelectorAll('.team-row');
      const away = g.teams.find(t => t.homeAway === 'away') || g.teams[0];
      const home = g.teams.find(t => t.homeAway === 'home') || g.teams[1];

      [away, home].forEach((team, idx) => {
        if (!team || !teamRows[idx]) return;
        const scoreEl = teamRows[idx].querySelector('.team-score');
        if (scoreEl) {
          const newScore = g.isScheduled ? '‚Äì' : (team.score ?? '‚Äì');
          if (scoreEl.textContent !== String(newScore)) {
            scoreEl.textContent = newScore;
            scoreEl.classList.remove('score-updated');
            void scoreEl.offsetWidth; // reflow to restart animation
            scoreEl.classList.add('score-updated');
          }
        }
      });

      // Update status bar
      const statusEl = cardEl.querySelector('.card-status');
      if (statusEl) {
        const sh = g.isLive
          ? `<div class="status-live"><div class="status-live-dot"></div>${g.periodDesc}</div>`
          : g.isFinal ? '<span class="status-final">FINAL</span>'
          : `<span class="status-upcoming">${formatTime(g.date)}</span>`;
        const networkBadges = buildNetworkBadges(g.networks);
        const sportLabel = `<span class="game-period" style="color:${g.sportColor}">${g.sportEmoji} ${g.sportName}</span>`;
        statusEl.innerHTML = sh + networkBadges + sportLabel;
      }

      // Update live border
      cardEl.classList.toggle('live', g.isLive);
      cardEl.classList.toggle('is-final', g.isFinal);
    });
  });

  // If new games appeared or games disappeared, do a full canvas re-render
  if (hasNewGames) {
    renderStreamCanvas();
  }

  // Update topbar counts
  updateTopbar();
}

// Check Dispatcharr credentials on load and update sidebar status
(async function initDsStatus(){
  try{
    const r=await fetch(`${API_BASE}/dispatcharr/credentials`,{signal:AbortSignal.timeout(3000)});
    if(r.ok){
      const d=await r.json();
      if(d.url&&d.username&&d.has_password){
        updateDsStatus(false,'configured'); // show as configured but not yet tested
      }
    }
  }catch(e){}
})();
// =====================
//  NCAA MANAGEMENT
// =====================
let _ncaaAllPrograms = [];
let _ncaaEditingPid  = null; // program id being edited, null = new
let _ncaaEditingSid  = null; // school id for the program being edited

async function initNcaaSection(){
  await loadNcaaSyncStatus();
  await loadNcaaPrograms();
}

async function loadNcaaSyncStatus(){
  try{
    const r=await fetch(`${API_BASE}/ncaa/sync/status`,{signal:AbortSignal.timeout(5000)});
    if(!r.ok)return;
    const d=await r.json();
    const el=document.getElementById('ncaaSyncStatus');
    if(!el)return;
    const sc=d.school_count||0, pc=d.program_count||0;
    const last=d.last_synced?new Date(d.last_synced).toLocaleString():'Never';
    el.textContent=`${sc.toLocaleString()} schools ¬∑ ${pc.toLocaleString()} programs ¬∑ Last synced: ${last}`;
  }catch(e){}
}

async function triggerNcaaSync(){
  const btn=document.getElementById('ncaaSyncBtn');
  if(btn){btn.textContent='Syncing...';btn.disabled=true;}
  try{
    await fetch(`${API_BASE}/ncaa/sync`,{method:'POST',signal:AbortSignal.timeout(10000)});
    // Poll status for a few seconds to show progress
    let polls=0;
    const poll=setInterval(async()=>{
      await loadNcaaSyncStatus();
      if(++polls>=6){clearInterval(poll);if(btn){btn.textContent='‚Üª Sync Now';btn.disabled=false;}await loadNcaaPrograms();}
    },3000);
  }catch(e){
    if(btn){btn.textContent='‚Üª Sync Now';btn.disabled=false;}
  }
}

async function loadNcaaPrograms(){
  const sport=document.getElementById('ncaaSportFilter')?.value||'';
  const div=document.getElementById('ncaaDivFilter')?.value||'';
  const q=document.getElementById('ncaaSearchInput')?.value||'';
  const listEl=document.getElementById('ncaaTeamList');
  const countEl=document.getElementById('ncaaTeamCount');
  if(listEl)listEl.innerHTML='<div style="color:var(--text-dim);font-size:13px;padding:12px;">Loading...</div>';
  try{
    let url=`${API_BASE}/ncaa/programs?`;
    if(sport)url+=`sport=${sport}&`;
    if(div)url+=`division=${div}&`;
    if(q)url+=`q=${encodeURIComponent(q)}&`;
    const r=await fetch(url,{signal:AbortSignal.timeout(8000)});
    if(!r.ok)throw new Error();
    const d=await r.json();
    _ncaaAllPrograms=d.programs||[];
    if(countEl)countEl.textContent=`${_ncaaAllPrograms.length.toLocaleString()} program${_ncaaAllPrograms.length!==1?'s':''}${sport||div||q?' (filtered)':''}`;
    renderNcaaList();
  }catch(e){
    if(listEl)listEl.innerHTML='<div style="color:var(--accent-red);font-size:13px;padding:12px;">Failed to load teams</div>';
  }
}

function ncaaFilterTeams(){
  // Debounce via timeout
  clearTimeout(ncaaFilterTeams._t);
  ncaaFilterTeams._t=setTimeout(loadNcaaPrograms,300);
}

const NCAA_SPORT_LABELS={ncaafb:'Football',ncaamb:"Men's Basketball",ncaawb:"Women's Basketball",ncaabase:'Baseball',ncaasb:'Softball'};

function renderNcaaList(){
  const listEl=document.getElementById('ncaaTeamList');
  if(!listEl)return;
  if(!_ncaaAllPrograms.length){
    listEl.innerHTML='<div style="color:var(--text-dim);font-size:13px;padding:16px;text-align:center;">No teams found. Try adjusting filters or syncing from ESPN.</div>';
    return;
  }
  listEl.innerHTML=_ncaaAllPrograms.map(p=>{
    const sportLabel=NCAA_SPORT_LABELS[p.sport_id]||p.sport_id;
    const color=p.color?'#'+(p.color.replace('#','')):'#333';
    const divBadge=p.division?`<span style="font-size:9px;font-weight:700;letter-spacing:1px;padding:2px 5px;border-radius:3px;background:rgba(255,255,255,0.07);color:var(--text-dim);text-transform:uppercase;">${p.division.toUpperCase()}</span>`:'';
    return `<div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;">
      <div style="width:4px;height:36px;border-radius:2px;background:${color};flex-shrink:0;"></div>
      ${p.logo_url?`<img src="${p.logo_url}" style="width:28px;height:28px;object-fit:contain;flex-shrink:0;" onerror="this.style.display='none'">`:'<div style="width:28px;"></div>'}
      <div style="flex:1;min-width:0;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:14px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.display_name||p.full_name}</div>
        <div style="font-size:11px;color:var(--text-dim);display:flex;gap:6px;align-items:center;margin-top:2px;">
          <span>${sportLabel}</span>${divBadge}
          ${p.espn_abbr?`<span style="color:var(--accent);font-weight:700;">${p.espn_abbr}</span>`:''}
        </div>
      </div>
      <div style="display:flex;gap:6px;flex-shrink:0;">
        <button onclick="openNcaaEditModal(${p.id})" style="padding:5px 11px;background:transparent;border:1px solid var(--border);border-radius:6px;color:var(--text-dim);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;">Edit</button>
        <button onclick="deleteNcaaProgram(${p.id},'${(p.display_name||p.full_name).replace(/'/g,"\\'")}',${p.school_id})" style="padding:5px 11px;background:transparent;border:1px solid rgba(255,59,92,0.3);border-radius:6px;color:var(--accent-red);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;">Delete</button>
      </div>
    </div>`;
  }).join('');
}

function openNcaaAddModal(){
  _ncaaEditingPid=null;
  _ncaaEditingSid=null;
  document.getElementById('ncaaModalTitle').textContent='Add NCAA Program';
  document.getElementById('ncaaModalSchool').value='';
  document.getElementById('ncaaModalAbbr').value='';
  document.getElementById('ncaaModalNick').value='';
  document.getElementById('ncaaModalSport').value='ncaafb';
  document.getElementById('ncaaModalDiv').value='d1';
  document.getElementById('ncaaModalColor').value='#333333';
  document.getElementById('ncaaModalError').style.display='none';
  document.getElementById('ncaaModal').style.display='flex';
}

function openNcaaEditModal(pid){
  const p=_ncaaAllPrograms.find(x=>x.id===pid);
  if(!p)return;
  _ncaaEditingPid=pid;
  _ncaaEditingSid=p.school_id;
  document.getElementById('ncaaModalTitle').textContent='Edit NCAA Program';
  document.getElementById('ncaaModalSchool').value=p.full_name||p.display_name||'';
  document.getElementById('ncaaModalAbbr').value=p.espn_abbr||'';
  document.getElementById('ncaaModalNick').value=p.nick||'';
  document.getElementById('ncaaModalSport').value=p.sport_id||'ncaafb';
  document.getElementById('ncaaModalDiv').value=p.division||'d1';
  document.getElementById('ncaaModalColor').value=p.color?'#'+p.color.replace('#',''):'#333333';
  document.getElementById('ncaaModalError').style.display='none';
  document.getElementById('ncaaModal').style.display='flex';
}

function closeNcaaModal(){
  document.getElementById('ncaaModal').style.display='none';
}

async function saveNcaaModal(){
  const school=(document.getElementById('ncaaModalSchool').value||'').trim();
  const abbr=(document.getElementById('ncaaModalAbbr').value||'').trim().toUpperCase();
  const nick=(document.getElementById('ncaaModalNick').value||'').trim();
  const sport=document.getElementById('ncaaModalSport').value;
  const div=document.getElementById('ncaaModalDiv').value;
  const color=document.getElementById('ncaaModalColor').value.replace('#','');
  const errEl=document.getElementById('ncaaModalError');
  const saveBtn=document.getElementById('ncaaModalSaveBtn');

  if(!school){errEl.textContent='School name is required.';errEl.style.display='block';return;}
  if(!abbr){errEl.textContent='Abbreviation is required.';errEl.style.display='block';return;}

  errEl.style.display='none';
  saveBtn.textContent='Saving...';saveBtn.disabled=true;

  try{
    if(_ncaaEditingPid){
      // Update existing program (and its school)
      await fetch(`${API_BASE}/ncaa/schools/${_ncaaEditingSid}`,{
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({full_name:school,espn_abbr:abbr,color,alt_color:''}),
        signal:AbortSignal.timeout(8000)
      });
      const pr=await fetch(`${API_BASE}/ncaa/programs/${_ncaaEditingPid}`,{
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({nick,display_name:school+(nick?' '+nick:''),short_name:nick||abbr,sport_id:sport,division:div,gender:sport.endsWith('wb')||sport.endsWith('sb')?'womens':'mens'}),
        signal:AbortSignal.timeout(8000)
      });
      if(!pr.ok)throw new Error(await pr.text());
    }else{
      // Create school first, then program
      const sr=await fetch(`${API_BASE}/ncaa/schools`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({full_name:school,espn_abbr:abbr,color,location:school}),
        signal:AbortSignal.timeout(8000)
      });
      if(!sr.ok)throw new Error(await sr.text());
      const sd=await sr.json();
      const pr=await fetch(`${API_BASE}/ncaa/programs`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({school_id:sd.id,nick,display_name:school+(nick?' '+nick:''),short_name:nick||abbr,sport_id:sport,division:div,gender:sport.endsWith('wb')||sport.endsWith('sb')?'womens':'mens'}),
        signal:AbortSignal.timeout(8000)
      });
      if(!pr.ok)throw new Error(await pr.text());
    }
    closeNcaaModal();
    await loadNcaaPrograms();
  }catch(e){
    errEl.textContent='Save failed: '+(e.message||'Unknown error');
    errEl.style.display='block';
  }finally{
    saveBtn.textContent='Save';saveBtn.disabled=false;
  }
}

async function deleteNcaaProgram(pid, name, schoolId){
  if(!confirm(`Delete "${name}"? If this is the school's only program, the school record will also be removed.`))return;
  try{
    const r=await fetch(`${API_BASE}/ncaa/programs/${pid}`,{method:'DELETE',signal:AbortSignal.timeout(8000)});
    if(!r.ok)throw new Error();
    await loadNcaaPrograms();
    await loadNcaaSyncStatus();
  }catch(e){
    alert('Failed to delete program. Try again.');
  }
}

</script>
</body>
</html>