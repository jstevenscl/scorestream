version: "3.8"
# ============================================================
# ScoreStream — Docker Compose Stack
# Pull from GitHub Container Registry (ghcr.io)
#
# Set SCORESTREAM_TAG in .env to choose image version:
#   latest → stable release
#   beta   → bleeding edge (built on every dev push)
#   v0.0.1-beta → specific version
# ============================================================
services:
  scorestream-web:
    image: ghcr.io/${GITHUB_OWNER:-jstevenscl}/scorestream-web:${SCORESTREAM_TAG:-latest}
    # To build locally instead of pulling, comment image line above and uncomment below:
    # build:
    #   context: .
    #   dockerfile: nginx/Dockerfile
    container_name: scorestream-web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-8888}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./scoreboard.html:/usr/share/nginx/html/index.html:ro
      - hls_segments:/usr/share/nginx/html/hls:ro
    networks:
      - scorestream-net
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/health"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 10s

  scorestream-renderer:
    image: ghcr.io/${GITHUB_OWNER:-jstevenscl}/scorestream-renderer:${SCORESTREAM_TAG:-latest}
    # build:
    #   context: ./renderer
    container_name: scorestream-renderer
    restart: unless-stopped
    environment:
      - TZ=${TZ:-America/Chicago}
      - STREAM_WIDTH=${STREAM_WIDTH:-1920}
      - STREAM_HEIGHT=${STREAM_HEIGHT:-1080}
      - STREAM_FPS=${STREAM_FPS:-10}
      - SCOREBOARD_URL=http://scorestream-web/?stream
    volumes:
      - renderer_pipe:/pipes
    networks:
      - scorestream-net
    depends_on:
      scorestream-web:
        condition: service_healthy
    shm_size: 512mb

  scorestream-ffmpeg:
    image: ghcr.io/${GITHUB_OWNER:-jstevenscl}/scorestream-ffmpeg:${SCORESTREAM_TAG:-latest}
    # build:
    #   context: ./ffmpeg
    container_name: scorestream-ffmpeg
    restart: unless-stopped
    environment:
      - TZ=${TZ:-America/Chicago}
      - STREAM_WIDTH=${STREAM_WIDTH:-1920}
      - STREAM_HEIGHT=${STREAM_HEIGHT:-1080}
      - STREAM_FPS=${STREAM_FPS:-10}
      - HLS_SEGMENT_DURATION=${HLS_SEGMENT_DURATION:-2}
      - HLS_PLAYLIST_SIZE=${HLS_PLAYLIST_SIZE:-10}
    volumes:
      - renderer_pipe:/pipes:ro
      - hls_segments:/hls
    networks:
      - scorestream-net
    depends_on:
      - scorestream-renderer

  scorestream-api:
    image: ghcr.io/${GITHUB_OWNER:-jstevenscl}/scorestream-api:${SCORESTREAM_TAG:-latest}
    # build:
    #   context: ./api
    container_name: scorestream-api
    restart: unless-stopped
    environment:
      - TZ=${TZ:-America/Chicago}
      - DISPATCHARR_URL=${DISPATCHARR_URL}
      - DISPATCHARR_USER=${DISPATCHARR_USER}
      - DISPATCHARR_PASS=${DISPATCHARR_PASS}
      - DISPATCHARR_GROUP=${DISPATCHARR_GROUP:-ScoreStream}
      - DISPATCHARR_CHANNEL_START=${DISPATCHARR_CHANNEL_START:-900}
      - STREAM_BASE_URL=${STREAM_BASE_URL}
      - CONFIG_PATH=/config/config.json
    volumes:
      - ./config:/config
    networks:
      - scorestream-net
    # API starts independently — no dependency on renderer/ffmpeg pipeline
    # This ensures the Dispatcharr UI works even if the streaming stack is not running

volumes:
  hls_segments:
  renderer_pipe:

networks:
  scorestream-net:
    driver: bridge
