version: "3.8"
# ============================================================
# ScoreStream — Docker Compose Stack
#
# Three services total:
#   scorestream-web    — nginx (serves UI + HLS + proxies API)
#   scorestream-api    — Flask API (scoreboards, Dispatcharr)
#   scorestream-stream — Stream manager (Puppeteer + ffmpeg)
#                        Automatically streams every scoreboard in the DB.
#                        No compose changes needed when adding scoreboards.
#
# Set SCORESTREAM_TAG in .env:
#   beta   -> dev builds (default for testing)
#   latest -> stable release
# ============================================================
services:
  scorestream-web:
    image: ghcr.io/${GITHUB_OWNER:-jstevenscl}/scorestream-web:${SCORESTREAM_TAG:-beta}
    container_name: scorestream-web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-8888}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./scoreboard.html:/usr/share/nginx/html/index.html:ro
      - hls_segments:/usr/share/nginx/html/hls:ro
    networks:
      - scorestream-net
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/health"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 10s

  scorestream-api:
    image: ghcr.io/${GITHUB_OWNER:-jstevenscl}/scorestream-api:${SCORESTREAM_TAG:-beta}
    container_name: scorestream-api
    restart: unless-stopped
    environment:
      - TZ=${TZ:-America/New_York}
      - DISPATCHARR_URL=${DISPATCHARR_URL}
      - DISPATCHARR_USER=${DISPATCHARR_USER}
      - DISPATCHARR_PASS=${DISPATCHARR_PASS}
      - STREAM_BASE_URL=${STREAM_BASE_URL}
      - STREAM_MANAGER_URL=http://scorestream-stream:3001
      - CONFIG_PATH=/config/config.json
    volumes:
      - ./config:/config
    networks:
      - scorestream-net

  scorestream-stream:
    image: ghcr.io/${GITHUB_OWNER:-jstevenscl}/scorestream-stream:${SCORESTREAM_TAG:-beta}
    container_name: scorestream-stream
    restart: unless-stopped
    environment:
      - TZ=${TZ:-America/New_York}
      - STREAM_WIDTH=${STREAM_WIDTH:-1920}
      - STREAM_HEIGHT=${STREAM_HEIGHT:-1080}
      - STREAM_FPS=${STREAM_FPS:-10}
      - WEB_BASE=http://scorestream-web
      - DB_PATH=/config/scorestream.db
      - HLS_DIR=/hls
      - PIPES_DIR=/tmp/pipes
      - MANAGER_PORT=3001
      - HLS_SEGMENT_DURATION=${HLS_SEGMENT_DURATION:-2}
      - HLS_PLAYLIST_SIZE=${HLS_PLAYLIST_SIZE:-10}
    volumes:
      - ./config:/config:ro
      - hls_segments:/hls
    networks:
      - scorestream-net
    depends_on:
      scorestream-web:
        condition: service_healthy
    shm_size: 512mb

volumes:
  hls_segments:

networks:
  scorestream-net:
    driver: bridge
